!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).desktop=e.desktop||{},e.desktop.min=t())}(this,(function(){"use strict";var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},e(t,n)};function t(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}var n=function(){return n=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};function i(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?r(e.value):new n((function(t){t(e.value)})).then(s,a)}c((i=i.apply(e,t||[])).next())}))}function r(e,t){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function o(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var i=Array(e),r=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var s=1,a=2,c=3,d=4;function u(e){return e.type===c?"timestamp":e.type===a?"number":e.type===s?"string":e.type===d?"object":"unknown"}function h(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function l(e){var t={},n=u(e);if("object"===n){var i=Object.keys(e.value).reduce((function(t,n){var i=h(e.value[n]);if("object"===i){var r=p(e.value[n]);t[n]={type:"object",description:"",context:{},composite:r}}else t[n]={type:i,description:"",context:{}};return t}),{});t.composite=i}return t.name=g(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function p(e){return Object.keys(e).reduce((function(t,n){var i=h(e[n]);return t[n]="object"===i?{type:"object",description:"",context:{},composite:p(e[n])}:{type:i,description:"",context:{}},t}),{})}function g(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function f(e){return"timestamp"===u(e)?Date.now():y(e.value)}function y(e){return"object"!=typeof e?e:Object.keys(e).reduce((function(t,n){var i=e[n];return"object"==typeof i&&i.constructor!==Date?t[n]=y(i):i.constructor===Date?t[n]=new Date(i).getTime():i.constructor===Boolean?t[n]=i.toString():t[n]=i,t}),{})}function m(e){return e.reduce((function(e,t){return e.concat(Array.isArray(t)?m(t):t)}),[])}function v(e){var t=m(e.root.getAggregateState()),n=t.sort((function(e,t){return e.state?t.state?t.state-e.state:-1:1}))[0],i=function(e){var t="";return e.forEach((function(e,n,i){var r=e.path.join(".");n===i.length-1?t+=r+"."+e.name+": "+e.description:t+=r+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t);return{description:i,value:n.state}}var w=function(e,t,n){if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},b=function(){function e(e,t,n,i,r){this.definition=e,this.system=t,this.transport=n,this.value=i,this.type=r,this.path=[],w(e,t,n),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,n.createMetric(this)}return Object.defineProperty(e.prototype,"repo",{get:function(){var e;return null===(e=this.system)||void 0===e?void 0:e.repo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),e.prototype.update=function(e){return this.value=e,this.transport.updateMetric(this)},e}(),_=function(e){function n(t,n,i,r){return e.call(this,t,n,i,r,a)||this}return t(n,e),n.prototype.incrementBy=function(e){this.update(this.value+e)},n.prototype.increment=function(){this.incrementBy(1)},n.prototype.decrement=function(){this.incrementBy(-1)},n.prototype.decrementBy=function(e){this.incrementBy(-1*e)},n}(b),I=function(e){function n(t,n,i,r){return e.call(this,t,n,i,r,d)||this}return t(n,e),n.prototype.update=function(e){return this.mergeValues(e),this.transport.updateMetric(this)},n.prototype.mergeValues=function(e){var t=this;return Object.keys(this.value).forEach((function(n){void 0!==e[n]&&(t.value[n]=e[n])}))},n}(b),C=function(e){function n(t,n,i,r){return e.call(this,t,n,i,r,s)||this}return t(n,e),n}(b),A=function(e){function n(t,n,i,r){return e.call(this,t,n,i,r,c)||this}return t(n,e),n.prototype.now=function(){this.update(new Date)},n}(b);function x(e,t,n,i,r){if(!t)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");var o,u,h=n,l=e,p=r||"",g=t,f=i,y=function e(t){if(!t||!t.parent)return[];var n=e(t.parent);return n.push(t.name),n}(i),m={},v=(u="/",((o=y)&&o.length>0?o.join(u):"")+e),w=t.root,b=[],T=[];function k(e,t,n,i){var r={name:""};r="string"==typeof e?{name:e}:e;var o=T.filter((function(e){return e.name===r.name}));if(o.length>0){var s=o[0];if(s.type!==t)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=i(r);return T.push(a),a}var S={get name(){return l},get description(){return p},get repo(){return g},get parent(){return f},path:y,id:v,root:w,get subSystems(){return b},get metrics(){return T},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");var n=b.filter((function(t){return t.name===e}));if(n.length>0)return n[0];var i=x(e,g,h,S,t);return b.push(i),i},getState:function(){return m},setState:function(e,t){m={state:e,description:t},h.updateSystem(S,m)},stringMetric:function(e,t){return k(e,s,t,(function(e){return new C(e,S,h,t)}))},timestampMetric:function(e,t){return k(e,c,t,(function(e){return new A(e,S,h,t)}))},objectMetric:function(e,t){return k(e,d,t,(function(e){return new I(e,S,h,t)}))},numberMetric:function(e,t){return k(e,a,t,(function(e){return new _(e,S,h,t)}))},getAggregateState:function(){var e=[];return Object.keys(m).length>0&&e.push({name:l,path:y,state:m.state,description:m.description}),b.forEach((function(t){var n=t.getAggregateState();n.length>0&&e.push.apply(e,n)})),e}};return h.createSystem(S),S}var T=function(){function e(e,t){t.init(this),this.root=x("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}return e.prototype.addSystemMetrics=function(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){var n=e.subSystem("ClickStream"),i=function(e){var t;if(e.target){var i=e.target,r=i&&null!==(t=i.getAttribute("class"))&&void 0!==t?t:"";n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:r,id:i.id,type:"<"+i.tagName.toLowerCase()+">",href:i.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}e.stringMetric("StartTime",(new Date).toString());var r=e.stringMetric("StartURL",""),o=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},e}(),k=function(){function e(){}return e.prototype.init=function(e){},e.prototype.createSystem=function(e){return Promise.resolve()},e.prototype.updateSystem=function(e,t){return Promise.resolve()},e.prototype.createMetric=function(e){return Promise.resolve()},e.prototype.updateMetric=function(e){return Promise.resolve()},e}(),S=function(){function e(e,t,n){this.api=e,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=t?t:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return e.prototype.scheduleCollection=function(){var e=this;setTimeout((function(){e.collect(),setInterval((function(){e.collect()}),e.publishInterval)}),this.initialPublishTimeout)},e.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(e){}},e.prototype.collectMemory=function(){var e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))},e.prototype.collectEntries=function(){var e=window.performance.getEntries();if(!(e.length<=this.lastCount)){this.lastCount=e.length;var t=e.map((function(e){return e.toJSON()}));this.system.stringMetric("entries",JSON.stringify(t))}},e}(),P=function(e){var t;t=e.connection&&"object"==typeof e.connection?function(e,t){var o,s,a=this;if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");var c=function(e){d(e.root)},d=function(e){u(e),e.metrics.forEach((function(e){h(e)})),e.subSystems.forEach((function(e){d(e)}))},u=function(e){return i(a,void 0,void 0,(function(){var t,n;return r(this,(function(i){switch(i.label){case 0:return void 0===e.parent?[2]:[4,o];case 1:return i.sent(),t={name:g(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},n={type:"define",metrics:[t]},s.send(n),[2]}}))}))},h=function(e){return i(a,void 0,void 0,(function(){var t,n,i;return r(this,(function(r){switch(r.label){case 0:return t=y(e),[4,o];case 1:return r.sent(),n=l(t),i={type:"define",metrics:[n]},s.send(i),void 0!==t.value&&p(t),[2]}}))}))},p=function(e){if(m()){var t=f(e),n={type:"publish",values:[{name:g(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return s.sendFireAndForget(n)}return Promise.resolve()},y=function(e){var t=n({},e);return"object"==typeof e.value&&null!==e.value&&(t.value=n({},e.value)),t},m=function(){var e;try{return(null!==(e=t.canUpdateMetric)&&void 0!==e?e:function(){return!0})()}catch(e){return!0}};return{init:function(n){var i;o=new Promise((function(e){i=e})),(s=e.domain("metrics")).onJoined((function(e){!e&&i&&(i(),i=void 0);var t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};s.send(t),e&&c(n)})),s.join({system:t.system,service:t.service,instance:t.instance})},createSystem:u,updateSystem:function(t,n){return i(a,void 0,void 0,(function(){var i,a,c;return r(this,(function(r){switch(r.label){case 0:return[4,o];case 1:return r.sent(),i={type:"publish",values:[{name:g(t.path.join("/")+"/"+t.name+"/State"),value:{Description:n.description,Value:n.state},timestamp:Date.now()}]},s.send(i),a=v(t),c={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:a.description,Value:a.value},timestamp:Date.now()}]},s.send(c),[2]}}))}))},createMetric:h,updateMetric:function(e){return i(a,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t=y(e),[4,o];case 1:return n.sent(),p(t),[2]}}))}))}}}(e.connection,e):new k;var o=new T(e,t).root;e.disableAutoAppSystem||(o=o.subSystem("App"));var s=function(e){var t,n=e.subSystem("reporting"),i={name:"features"},r=function(e,r,o){if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");t?t.update({name:e,action:r,payload:o}):t=n.objectMetric(i,{name:e,action:r,payload:o})};return e.featureMetric=r,e}(o);return function(e,t){var n,i;if("undefined"==typeof window)return;var r=null===(i=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===i?void 0:i.pagePerformanceMetrics;r&&(t=r);(null==t?void 0:t.enabled)&&new S(e,t.initialPublishTimeout,t.publishInterval)}(s,e.pagePerformanceMetrics),s};function M(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(t)t(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,r){var o=n[e];return o||(o=[],n[e]=o),o.push(t),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(r)?t.apply(void 0,r):t.apply(void 0,[r])}catch(t){i(t,e)}}))}),0),function(){var i=n[e];i&&(0===(i=i.reduce((function(e,n,i){return n===t&&e.length===i||e.push(n),e}),[])).length?delete n[e]:n[e]=i)}},execute:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var o=n[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,t);s.push(r)}catch(t){s.push(void 0),i(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}M.default=M;var E=M,R=function(){function e(e,t){var n=this;this.registry=E(),this.gw=e.facade,this.gw.connect((function(e,t){n.messageHandler(t)})).then((function(e){n.client=e}))}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){return e(!0),function(){}},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"in-memory"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),j=function(){function e(e,t){var n=this;this.logger=t,this.registry=E(),this.worker=new SharedWorker(e),this.worker.port.onmessage=function(e){n.messageHandler(e.data)}}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.worker.port.postMessage(e),Promise.resolve()},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){return e(!0),function(){}},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"shared-worker"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),W=function(){function e(){}return e.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?void 0:e}},e.isNode=function(){if(void 0!==e._isNode)return e._isNode;if("undefined"!=typeof window)return e._isNode=!1,!1;try{e._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(t){e._isNode=!1}return e._isNode},e}(),O=function(){function e(){var e=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(t,n){e.resolve=function(n){e.resolved=!0,t(n)},e.reject=function(t){e.rejected=!0,n(t)}}))}return e.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},Object.defineProperty(e.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),e}(),N={};function F(e){var t=N[e];if(t)return t;var n=[];function i(){return(new Date).getTime()}var r,o,s=i();function a(e,t){var r=null!=t?t:i(),o=0;n.length>0&&(o=r-n[n.length-1].time),n.push({name:e,time:r,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return r},get period(){return o},stop:function(){return a("end",r=i()),o=r-s},mark:a,marks:n};return N[e]=c,c}var L=W.isNode()?require("ws"):window.WebSocket,D=function(){function e(e,t){if(this.startupTimer=F("connection"),this._running=!0,this._registry=E(),this.wsRequests=[],this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}return e.prototype.onMessage=function(e){return this._registry.add("onMessage",e)},e.prototype.send=function(e,t){var n=this;return new Promise((function(t,i){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(e),t()}catch(e){i(e)}}),i)}))},e.prototype.open=function(){var e=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(t,n){e.waitForSocketConnection(t,n)}))},e.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},e.prototype.onConnectedChanged=function(e){return this._registry.add("onConnectedChanged",e)},e.prototype.name=function(){return this.settings.ws},e.prototype.reconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close();var t=new O;return this.waitForSocketConnection((function(){t.resolve()})),t.promise},e.prototype.waitForSocketConnection=function(e,t){var n;t=null!=t?t:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t("wait for socket on "+this.settings.ws+" failed - socket closed by user")},e.prototype.openSocket=function(e,t){return i(this,void 0,void 0,(function(){var n=this;return r(this,(function(i){switch(i.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+t+" more times (every "+e+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===t?void 0:t-1;n.openSocket(e,i)}),e),[3,4];case 4:return[2]}}))}))},e.prototype.initiateSocket=function(){var e=this,t=new O;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new L(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(e){var r=new WeakSet;i=JSON.stringify(n,(function(e,t){if("object"==typeof t&&null!==t){if(r.has(t))return;r.add(t)}return t}))}t.reject("error"),e.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){e.logger.info("ws closed "+n),t.reject("closed"),e.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;e.startupTimer.mark("ws-opened"),e.logger.info("ws opened "+(null===(n=e.settings.identity)||void 0===n?void 0:n.application)),t.resolve(),e.notifyStatusChanged(!0)},this.ws.onmessage=function(t){e._registry.execute("onMessage",t.data)},t.promise},e.prototype.notifyForSocketState=function(e){this.wsRequests.forEach((function(t){e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]},e.prototype.notifyStatusChanged=function(e,t){this._registry.execute("onConnectedChanged",e,t)},e}();var G=1;var B,q,H,U={nextValue:function(){return(G=(9301*G+49297)%233280)/233280},seed:function(e){G=e}},V="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function J(){H=!1}function z(e){if(e){if(e!==B){if(e.length!==V.length)throw new Error("Custom alphabet for shortid must be "+V.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+V.length+" unique characters. These characters were not unique: "+t.join(", "));B=e,J()}}else B!==V&&(B=V,J())}function $(){return H||(H=function(){B||z(V);for(var e,t=B.split(""),n=[],i=U.nextValue();t.length>0;)i=U.nextValue(),e=Math.floor(i*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var K={characters:function(e){return z(e),B},seed:function(e){U.seed(e),q!==e&&(J(),q=e)},lookup:function(e){return $()[e]},shuffled:$},Q="object"==typeof window&&(window.crypto||window.msCrypto);var Z=function(){if(!Q||!Q.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return Q.getRandomValues(e),48&e[0]};var X=function(e,t){for(var n,i=0,r="";!n;)r+=e(t>>4*i&15|Z()),n=t<Math.pow(16,i+1),i++;return r};var Y=function(e){var t=K.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}};var ee=function(e){if(!e||"string"!=typeof e||e.length<6)return!1;for(var t=K.characters(),n=e.length,i=0;i<n;i++)if(-1===t.indexOf(e[i]))return!1;return!0},te=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n,i=0;function r(){var e="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?t++:(t=0,n=r),e+=X(K.lookup,6),e+=X(K.lookup,i),t>0&&(e+=X(K.lookup,t)),e+=X(K.lookup,r)}e.exports=r,e.exports.generate=r,e.exports.seed=function(t){return K.seed(t),e.exports},e.exports.worker=function(t){return i=t,e.exports},e.exports.characters=function(e){return void 0!==e&&K.characters(e),K.shuffled()},e.exports.decode=Y,e.exports.isValid=ee}));te.generate,te.seed,te.worker,te.characters,te.decode,te.isValid;var ne=te;function ie(e,t,n,i,r){null==e&&(e="global"),i=i||["success"],r=r||["error"];var o,s=!1,a=!1,c=!1,d=E();t.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,d.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),h(o))})),t.on("success",(function(e){return p(e)})),t.on("error",(function(e){return l(e)})),t.on("result",(function(e){return p(e)})),i&&i.forEach((function(e){t.on(e,(function(e){return p(e)}))})),r&&r.forEach((function(e){t.on(e,(function(e){return l(e)}))}));var u={};function h(t){return o=t,new Promise((function(i,r){if(s)i();else{var o;if("global"===e)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+e),o=f({type:"join",destination:e,domain:"global",options:t});o.then((function(){!function(){n.debug("did join "+e),s=!0;var t=a;a=!1,d.execute("onJoined",t)}(),i()})).catch((function(t){n.debug("error joining "+e+" domain: "+JSON.stringify(t)),r(t)}))}}))}function l(t){if(e===t.domain){var n=t.request_id;if(n){var i=u[n];i&&i.error(t)}}}function p(t){if(t.domain===e){var n=t.request_id;if(n){var i=u[n];i&&i.success(t)}}}function g(){return ne()}function f(i,r,o){o=o||{},i.request_id=i.request_id||g(),i.domain=i.domain||e,o.skipPeerId||(i.peer_id=t.peerId);var s=i.request_id;return new Promise((function(e,a){u[s]={success:function(t){delete u[s],t._tag=r,e(t)},error:function(e){n.warn("GW error - "+JSON.stringify(e)+" for request "+JSON.stringify(i)),delete u[s],e._tag=r,a(e)}},t.send(i,o).catch((function(e){u[s].error({err:e})}))}))}return{join:h,leave:function(){return"global"===e?Promise.resolve():(n.debug("stopping session "+e+"..."),a=!1,f({type:"leave",destination:e,domain:"global"}).then((function(){s=!1,d.execute("onLeft")})).catch((function(){s=!1,d.execute("onLeft")})))},onJoined:function(e){return s&&e(!1),d.add("onJoined",e)},onLeft:function(e){return s||e(),d.add("onLeft",e)},send:f,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:g(),n.domain=n.domain||e,n.peer_id=t.peerId,t.send(n)},on:function(i,r){t.on(i,(function(t){if(t.domain===e)try{r(t)}catch(e){n.error("Callback  failed: "+e+" \n "+e.stack+" \n msg was: "+JSON.stringify(t),e)}}))},loggedIn:function(e){return t.loggedIn(e)},connected:function(e){return t.connected(e)},disconnected:function(e){return t.disconnected(e)},get peerId(){return t.peerId},get domain(){return e}}}var re=function(){function e(e,t,n){var i=this;this.connection=e,this.settings=t,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=E(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],e.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.processStringMessage=function(e){var t=this,n=JSON.parse(e,(function(e,n){if("string"!=typeof n)return n;if(n.length<t.dateMinLen)return n;if(n[0]!==t.datePrefixFirstChar)return n;if(n.substring(0,t.datePrefixLen)!==t.datePrefix)return n;try{var i=parseInt(n.substring(t.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(e){return n}}));return{msg:n,msgType:n.type}},e.prototype.createStringMessage=function(e){var t=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}},e.prototype.processObjectMessage=function(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}},e.prototype.createObjectMessage=function(e){return e},e.prototype.login=function(e,t){return i(this,void 0,void 0,(function(){var n,i,o,s,a,c,d,u,h,l;return r(this,(function(r){switch(r.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=e.gatewayToken,!e.gatewayToken)return[3,5];if(!t)return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=r.sent(),e.gatewayToken=u,[3,4];case 3:return i=r.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=e.gatewayToken,this.connection.gatewayToken=e.gatewayToken,[3,10];case 5:return"sspi"!==e.flowName?[3,9]:(n.provider="win",n.method="access-token",e.flowCallback&&e.sessionId?(o=n,[4,e.flowCallback(e.sessionId,null)]):[3,7]);case 6:return o.token=r.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(e.token)n.method="access-token",n.token=e.token;else if(e.username)n.method="secret",n.login=e.username,n.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));n.provider=e.provider,n.providerContext=e.providerContext}r.label=10;case 10:s={type:"hello",identity:this.settings.identity,authentication:n},e.sessionId&&(s.request_id=e.sessionId),this.globalDomain=ie("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),a={skipPeerId:!0},this.initialLogin&&(a.retryInterval=this.settings.reconnectInterval,a.maxRetries=this.settings.reconnectAttempts),r.label=11;case 11:r.trys.push([11,19,20,21]),c=void 0,r.label=12;case 12:return[4,this.globalDomain.send(s,void 0,a)];case 13:return"authentication-request"!==(d=r.sent()).type?[3,16]:(u=Buffer.from(d.authentication.token,"base64"),e.flowCallback&&e.sessionId?(h=s.authentication,[4,e.flowCallback(e.sessionId,u)]):[3,15]);case 14:h.token=r.sent().data.toString("base64"),r.label=15;case 15:return s.request_id=e.sessionId,[3,12];case 16:if("welcome"===d.type)return c=d,[3,18];throw"error"===d.type?new Error("Authentication failed: "+d.reason):new Error("Unexpected message type during authentication: "+d.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.debug("login successful with peerId "+c.peer_id),this.connection.peerId=c.peer_id,this.connection.resolvedIdentity=c.resolved_identity,this.connection.availableDomains=c.available_domains,c.options&&(this.connection.token=c.options.access_token,this.connection.info=c.options.info),this.setLoggedIn(!0),[2,c.resolved_identity];case 19:throw l=r.sent(),this.logger.error("error sending hello message - "+(l.message||l.msg||l.reason||l),l),l;case 20:return e&&e.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null),[7];case 21:return[2]}}))}))},e.prototype.logout=function(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){switch(t.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),e=this.sessions.map((function(e){e.leave()})),[4,Promise.all(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)},e.prototype.domain=function(e,t,n,i){var r=this.sessions.filter((function(t){return t.domain===e}))[0];return r||(r=ie(e,this.connection,t,n,i),this.sessions.push(r)),r},e.prototype.handleDisconnected=function(){var e=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(e.handleDisconnected.bind(e),e.settings.reconnectInterval||1e3)}))}},e.prototype.setLoggedIn=function(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")},e.prototype.ping=function(){var e=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){e.ping()}),3e4))},e.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(e){return e.token})):Promise.reject(new Error("no global domain session"))},e.prototype.getNewGWToken=function(){if(void 0!==typeof window){var e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))},e}(),oe=function(){function e(e){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var t=0,n=e;t<n.length;t++){var i=n[t];this.specs[i.name]=i,this.specsNames.push(i.name)}}return e.prototype.init=function(e){var t=this;this.connection=e;for(var n=0,i=this.specsNames;n<i.length;n++)for(var r=i[n],o=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var r=e.on(n,(function(e){return t.processMessage(n,e)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){o(c[a])}},e.prototype.processMessage=function(e,t){if(!this.isDone&&t)for(var n=0,i=this.specsNames;n<i.length;n++){var r=i[n];if(-1!==this.specs[r].types.indexOf(e)){var o=this.messages[r]||[];this.messages[r]=o,o.push(t)}}},e.prototype.drain=function(e,t){var n;t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(var i=0,r=this.specs[e].types;i<r.length;i++){var o=r[i];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[e],this.specs.length||(this.isDone=!0)},e}(),se=function(e,t,n){return new Promise((function(i,r){var o=setTimeout((function(){r(n||"Promise timeout hit: "+t)}),t);new Promise(e).then((function(e){clearTimeout(o),i(e)})).catch((function(e){clearTimeout(o),r(e)}))}))},ae=function(){function e(e,t,n){this.settings=e,this.logger=t,this.identity=n,this.iAmConnected=!1,this.parentReady=!1,this.rejected=!1,this.children=[],this.extContentAvailable=!1,this.extContentConnecting=!1,this.extContentConnected=!1,this.parentInExtMode=!1,this.parentPingTimeout=5e3,this.connectionRequestTimeout=7e3,this.defaultTargetString="*",this.registry=E(),this.messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:this.handleParentReady.bind(this)},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}},this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.settings.port||(this.parent=window.opener||window.top,this.parentType=window.opener?"opener":-1!==window.name.indexOf("#wsp")?"workspace":"top")}return e.prototype.manualSetReadyState=function(){this.iAmConnected=!0,this.parentReady=!0},Object.defineProperty(e.prototype,"transportWindowId",{get:function(){return this.publicWindowId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"communicationId",{get:function(){return this._communicationId},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return i(this,void 0,void 0,(function(){return r(this,(function(t){if(this.extContentConnected)return[2,window.postMessage({glue42ExtOut:e},this.defaultTargetString)];if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");return this.port.postMessage(e),[2]}))}))},Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.send=function(){return Promise.reject("not supported")},e.prototype.onConnectedChanged=function(e){return this.registry.add("onConnectedChanged",e)},e.prototype.open=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return this.logger.debug("opening a connection to the web platform gateway."),[4,this.connect()];case 1:return e.sent(),this.notifyStatusChanged(!0),[2]}}))}))},e.prototype.close=function(){var e,t,n={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:null===(e=this.identity)||void 0===e?void 0:e.windowId}}};return null===(t=this.port)||void 0===t||t.postMessage(n),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()},e.prototype.name=function(){return"web-platform"},e.prototype.reconnect=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.close()];case 1:return e.sent(),[2,Promise.resolve()]}}))}))},e.prototype.connect=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return this.settings.port?[4,this.initiateInternalConnection()]:[3,2];case 1:return e.sent(),this.logger.debug("internal web platform connection completed"),[2];case 2:if(!this.parentType||!this.parent)throw new Error("Cannot initiate a connection, because there is no opener, no top and no port.");return this.logger.debug("opening a "+("opener"===this.parentType?"child":"grandchild")+" client web platform connection"),[4,this.waitParent(this.parent,this.parentType)];case 3:return e.sent(),this.parentInExtMode?[4,this.requestConnectionPermissionFromExt()]:[3,5];case 4:e.sent(),e.label=5;case 5:return[4,this.initiateRemoteConnection(this.parent,this.parentType)];case 6:return e.sent(),this.logger.debug("the "+("opener"===this.parentType?"child":"grandchild")+" client is connected"),[2]}}))}))},e.prototype.initiateInternalConnection=function(){var e=this;return new Promise((function(t,n){e.logger.debug("opening an internal web platform connection"),e.port=e.settings.port,e.iAmConnected?e.logger.warn("cannot open a new connection, because this client is currently connected"):(e.port.onmessage=function(i){var r,o;if(!e.iAmConnected||(null===(r=i.data)||void 0===r?void 0:r.glue42core)){var s=null===(o=i.data)||void 0===o?void 0:o.glue42core;s&&(s.type===e.messages.gatewayInternalConnect.name&&s.success&&(e.publicWindowId=e.settings.windowId,e.identity&&(e.identity.windowId=e.publicWindowId),t()),s.type===e.messages.gatewayInternalConnect.name&&s.error&&n(s.error))}else e.registry.execute("onMessage",i.data)},e.port.postMessage({glue42core:{type:e.messages.gatewayInternalConnect.name}}))}))},e.prototype.initiateRemoteConnection=function(e,t){var n=this;return se((function(i,r){var o;n.connectionResolve=i,n.connectionReject=r,n.myClientId=null!==(o=n.myClientId)&&void 0!==o?o:ne();var s="workspace"===n.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window.name,a={glue42core:{type:n.messages.connectionRequest.name,clientId:n.myClientId,clientType:"top"===t||"workspace"===t?"grandChild":"child",bridgeInstanceId:s}};if(n.logger.debug("sending connection request to "+t),n.extContentConnecting)return a.glue42core.clientType="child",a.glue42core.bridgeInstanceId=n.myClientId,a.glue42core.parentWindowId=n.parentWindowId,window.postMessage(a,n.defaultTargetString);e.postMessage(a,n.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the opener/top window timed out")},e.prototype.waitParent=function(e,t){return i(this,void 0,void 0,(function(){var n,i,o=this;return r(this,(function(r){switch(r.label){case 0:if(n="Cannot initiate glue, because this window was not opened or created by a glue client",(i=se((function(i,r){var s=window.self!==window.top;if("top"===t&&!s)return r(n);o.parentPingResolve=i;var a={glue42core:{type:"opener"===t?o.messages.platformPing.name:o.messages.parentPing.name}};o.logger.debug("checking for "+t+" window availability"),o.parentPingInterval=setInterval((function(){e.postMessage(a,o.defaultTargetString)}),1e3)}),this.parentPingTimeout,n)).catch((function(){o.parentPingInterval&&(clearInterval(o.parentPingInterval),delete o.parentPingInterval)})),!this.extContentAvailable)return[2,i];r.label=1;case 1:return r.trys.push([1,3,,5]),[4,i];case 2:return r.sent(),[2];case 3:return r.sent(),this.logger.debug("the parent check failed, but there is an associated extension content script, requesting permission..."),[4,this.requestConnectionPermissionFromExt()];case 4:return r.sent(),[3,5];case 5:return[2]}}))}))},e.prototype.setUpMessageListener=function(){var e=this;this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(function(t){var n,i=null===(n=t.data)||void 0===n?void 0:n.glue42core;if(i&&!e.rejected)if(e.checkMessageTypeValid(i.type)){var r=i.type;e.logger.debug("received valid glue42core message of type: "+r),e.messages[r].handle(t)}else e.logger.error("cannot handle the incoming glue42 core message, because the type is invalid: "+i.type)}))},e.prototype.setUpUnload=function(){var e=this;this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(function(){var t,n;if(!e.extContentConnected){var i={glue42core:{type:e.messages.clientUnload.name,data:{clientId:e.myClientId,ownWindowId:null===(t=e.identity)||void 0===t?void 0:t.windowId}}};e.parent&&e.parent.postMessage(i,e.defaultTargetString),null===(n=e.port)||void 0===n||n.postMessage(i)}}))},e.prototype.handleParentReady=function(e){var t;this.logger.debug("handling the ready signal from the parent, by resoling the pending promise."),this.parentReady=!0;var n=null===(t=e.data)||void 0===t?void 0:t.glue42core;n&&n.extMode&&(this.logger.debug("my parent is connected to its content script, fetching windowId and proceeding with content script connection"),this.parentWindowId=n.extMode.windowId,this.parentInExtMode=!0),this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)},e.prototype.handlePlatformReady=function(){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)},e.prototype.handleConnectionAccepted=function(e){var t,n=null===(t=e.data)||void 0===t?void 0:t.glue42core;return this.myClientId===n.clientId?this.handleAcceptanceOfMyRequest(n):this.handleAcceptanceOfGrandChildRequest(n,e)},e.prototype.handleAcceptanceOfMyRequest=function(e){var t=this;if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId="opener"===this.parentType?window.name:"top"===this.parentType?e.parentWindowId:window.name.substring(0,window.name.indexOf("#wsp")),this.identity&&"top"!==this.parentType&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=function(e){return t.registry.execute("onMessage",e.data)},this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")},e.prototype.processExtContentConnection=function(e){var t=this;if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(function(e){var n,i=null===(n=e.data)||void 0===n?void 0:n.glue42ExtInc;i&&t.registry.execute("onMessage",i)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve},e.prototype.handleAcceptanceOfGrandChildRequest=function(e,t){if(this.extContentConnecting||this.extContentConnected)this.logger.debug("cannot process acceptance of a grandchild, because I am connected to a content script");else{this.logger.debug("handling a connection accepted signal targeted at a grandchild: "+e.clientId);var n=this.children.find((function(t){return t.grandChildId===e.clientId}));n?(n.connected=!0,this.logger.debug("the grandchild connection for "+e.clientId+" is set up, forwarding the success message and the gateway port"),e.parentWindowId=this.publicWindowId,n.source.postMessage(t.data,n.origin,[e.port])):this.logger.error("cannot handle connection accepted for grandchild: "+e.clientId+", because there is no grandchild with this id")}},e.prototype.handleConnectionRejected=function(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)},e.prototype.handleConnectionRequest=function(e){if(this.extContentConnecting)this.logger.debug("This connection request event is targeted at the extension content");else{var t=e.source,n=e.data.glue42core;if(!n.clientType||"grandChild"!==n.clientType)return this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call");if(!n.clientId)return this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id");if("opener"!==this.parentType||!this.parent)return this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found");this.logger.debug("handling a connection request for a grandchild: "+n.clientId),this.children.push({grandChildId:n.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug("grandchild: "+n.clientId+" is prepared, forwarding connection request to the platform"),this.parent.postMessage(e.data,this.defaultTargetString)}},e.prototype.handleParentPing=function(e){if(this.parentReady)if(this.iAmConnected){var t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});var n=e.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(t,e.origin)}else this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");else this.logger.debug("my parent is not ready, I am ignoring the parent ping")},e.prototype.setupPlatformUnloadListener=function(){var e=this;this.onMessage((function(t){"platformUnload"===t.type&&(e.logger.debug("detected a web platform unload"),e.parentReady=!1,e.notifyStatusChanged(!1,"Gateway unloaded"))}))},e.prototype.handleManualUnload=function(){var e,t,n={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:null===(e=this.identity)||void 0===e?void 0:e.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:n},this.defaultTargetString);null===(t=this.port)||void 0===t||t.postMessage(n)},e.prototype.handleClientUnload=function(e){var t=e.data.glue42core,n=null==t?void 0:t.data.clientId;n?this.children.find((function(e){return e.grandChildId===n}))?(this.logger.debug("handling grandchild unload for id: "+n),this.children=this.children.filter((function(e){return e.grandChildId!==n}))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")},e.prototype.handlePlatformPing=function(){this.logger.error("cannot handle platform ping, because this is not a platform calls handling component")},e.prototype.notifyStatusChanged=function(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)},e.prototype.checkMessageTypeValid=function(e){return"string"==typeof e&&!!this.messages[e]},e.prototype.rejectConnectionRequest=function(e,t,n){this.rejected=!0,this.logger.error(n);var i={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(i,t)},e.prototype.requestConnectionPermissionFromExt=function(){var e=this;return this.waitForContentScript().then((function(){return se((function(t,n){e.extConnectionResolve=t,e.extConnectionReject=n;e.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},e.defaultTargetString)}),e.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")}))},e.prototype.handleExtConnectionResponse=function(e){var t;if(!(null===(t=e.data)||void 0===t?void 0:t.glue42core).approved&&this.extConnectionReject)return this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected");this.extConnectionResolve&&(this.extContentConnecting=!0,this.logger.debug("The extension connection was approved, proceeding."),this.extConnectionResolve(),delete this.extConnectionResolve)},e.prototype.handleExtSetupRequest=function(){},e.prototype.handleGatewayDisconnect=function(){},e.prototype.handleGatewayInternalConnect=function(){},e.prototype.waitForContentScript=function(){var e;return!!(null===(e=window.glue42ext)||void 0===e?void 0:e.content)?Promise.resolve():se((function(e){window.addEventListener("Glue42EXTReady",(function(){e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")},e}(),ce=function(){function e(e){void 0===e&&(e=0),this.minSequenceInterval=e,this.queue=[],this.isExecutingQueue=!1}return e.prototype.enqueue=function(e){var t=this;return new Promise((function(n,i){t.queue.push({action:e,resolve:n,reject:i}),t.executeQueue()}))},e.prototype.executeQueue=function(){return i(this,void 0,void 0,(function(){var e,t,n;return r(this,(function(i){switch(i.label){case 0:if(this.isExecutingQueue)return[2];this.isExecutingQueue=!0,i.label=1;case 1:if(!this.queue.length)return[3,7];if(!(e=this.queue.shift()))return this.isExecutingQueue=!1,[2];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,e.action()];case 3:return t=i.sent(),e.resolve(t),[3,5];case 4:return n=i.sent(),e.reject(n),[3,5];case 5:return[4,this.intervalBreak()];case 6:return i.sent(),[3,1];case 7:return this.isExecutingQueue=!1,[2]}}))}))},e.prototype.intervalBreak=function(){var e=this;return new Promise((function(t){return setTimeout(t,e.minSequenceInterval)}))},e}(),de=function(){function e(e,t){if(this.settings=e,this.logger=t,this.messageHandlers={},this.ids=1,this.registry=E(),this._connected=!1,this.isTrace=!1,this._swapTransport=!1,this._switchInProgress=!1,this._transportSubscriptions=[],this._sequelizer=new ce,(e=e||{}).reconnectAttempts=e.reconnectAttempts||10,e.reconnectInterval=e.reconnectInterval||1e3,e.inproc)this.transport=new R(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new j(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new ae(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new D(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug("starting with "+this.transport.name()+" transport"),this.protocol=new re(this,e,t.subLogger("protocol"));var n=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),i=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(n),this._transportSubscriptions.push(i),this._defaultTransport=this.transport}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;return null===(e=this.protocol)||void 0===e?void 0:e.protocolVersion},enumerable:!0,configurable:!0}),e.prototype.switchTransport=function(e){return i(this,void 0,void 0,(function(){var t=this;return r(this,(function(n){return[2,this._sequelizer.enqueue((function(){return i(t,void 0,void 0,(function(){var t,n,i;return r(this,(function(r){switch(r.label){case 0:if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");return this.logger.trace("Starting transport switch with settings: "+JSON.stringify(e)),t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport,this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth,n=this.verifyConnection(),this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),[4,this.transport.close()];case 1:r.sent(),r.label=2;case 2:return r.trys.push([2,4,,5]),[4,n];case 3:return r.sent(),i=this.transport===t,this.logger.info("The reconnection after the switch was completed. Was the switch a success: "+i),this._switchInProgress=!1,[2,{success:i}];case 4:return r.sent(),this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,[2,{success:!1}];case 5:return[2]}}))}))}))]}))}))},e.prototype.onLibReAnnounced=function(e){return this.registry.add("libReAnnounced",e)},e.prototype.setLibReAnnounced=function(e){this.registry.execute("libReAnnounced",e)},e.prototype.send=function(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(e);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,t)}var i=this.protocol.createStringMessage(e);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,t)},e.prototype.on=function(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});var n=this.ids++;return this.messageHandlers[e][n]=t,{type:e,id:n}},e.prototype.off=function(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.connected=function(e){var t=this;return this.protocol.loggedIn((function(){var n=t.transport.name();e(n)}))},e.prototype.disconnected=function(e){return this.registry.add("disconnected",e)},e.prototype.login=function(e,t){return i(this,void 0,void 0,(function(){var n,i,o;return r(this,(function(r){switch(r.label){case 0:this._defaultAuth||(this._defaultAuth=e),this._swapTransport&&(this.logger.trace("Detected a transport swap, swapping transports"),n=this.transportSwap(),e=null!=n?n:e),this.logger.trace("Starting login for transport: "+this.transport.name()+" and auth "+JSON.stringify(e)),r.label=1;case 1:return r.trys.push([1,4,,5]),[4,this.transport.open()];case 2:return r.sent(),this.logger.trace("Transport: "+this.transport.name()+" opened, logging in"),F("connection").mark("transport-opened"),[4,this.protocol.login(e,t)];case 3:return i=r.sent(),this.logger.trace("Logged in with identity: "+JSON.stringify(i)),F("connection").mark("protocol-logged-in"),[2,i];case 4:throw o=r.sent(),this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(o);case 5:return[2]}}))}))},e.prototype.logout=function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.protocol.logout()];case 1:return e.sent(),[4,this.transport.close()];case 2:return e.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this.protocol.loggedIn(e)},e.prototype.domain=function(e,t,n){return this.protocol.domain(e,this.logger.subLogger("domain="+e),t,n)},e.prototype.authToken=function(){return this.protocol.authToken()},e.prototype.reconnect=function(){return this.transport.reconnect()},e.prototype.distributeMessage=function(e,t){var n=this,i=this.messageHandlers[t.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(t){var r=i[t];if(void 0!==r)try{r(e)}catch(e){try{n.logger.error("Message handler failed with "+e.stack,e)}catch(t){console.log("Message handler failed",e)}}}))},e.prototype.handleConnectionChanged=function(e){this._connected!==e&&(this._connected=e,e?(this.settings.replaySpecs&&this.settings.replaySpecs.length&&(this.replayer=new oe(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):this.registry.execute("disconnected"))},e.prototype.handleTransportMessage=function(e){var t;t="string"==typeof e?this.protocol.processStringMessage(e):this.protocol.processObjectMessage(e),this.isTrace&&this.logger.trace("<< "+JSON.stringify(t)),this.distributeMessage(t.msg,t.msgType)},e.prototype.verifyConnection=function(){var e=this;return se((function(t){var n,i,r,o=(i=function(){n&&n(),t()},r=2,function(){0==--r&&i()});n=e.onLibReAnnounced((function(e){return"interop"===e.name||"contexts"===e.name?o():void 0}))}),1e4,"Transport switch timed out waiting for all libraries to be re-announced")},e.prototype.getNewSecondaryTransport=function(e){var t;if(!(null===(t=e.transportConfig)||void 0===t?void 0:t.url))throw new Error("Missing secondary transport URL.");return new D(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))},e.prototype.getNewSecondaryAuth=function(e){var t;if(!(null===(t=e.transportConfig)||void 0===t?void 0:t.auth))throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth},e.prototype.transportSwap=function(){if(this._swapTransport=!1,this._targetTransport&&this._targetAuth){this._transportSubscriptions.forEach((function(e){return e()})),this._transportSubscriptions=[],this.transport=this._targetTransport;var e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}this.logger.warn("Error while switching transports - either the target transport or auth is not defined: transport defined -> "+!!this._defaultTransport+", auth defined -> "+!!this._targetAuth+". Staying on the current one.")},e.prototype.prepareDefaultSwap=function(){var e=this;this._transportSubscriptions.forEach((function(e){return e()})),this._transportSubscriptions=[],this.transport.close().catch((function(t){return e.logger.warn("Error closing the "+e.transport.name()+" transport after a failed connection attempt: "+JSON.stringify(t))})),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0},e}(),ue=["trace","debug","info","warn","error","off"],he=function(){function e(e,t,n){this.name=e,this.parent=t,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=e,this.path=t?t.path+"."+e:e,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return e.prototype.subLogger=function(t){var n=this.subLoggers.filter((function(e){return e.name===t}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(e){if(e===t)throw new Error("This sub logger name is not allowed.")}));var i=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},e.prototype.publishLevel=function(e){var t;return e&&(this._publishLevel=e),this._publishLevel||(null===(t=this.parent)||void 0===t?void 0:t.publishLevel())},e.prototype.consoleLevel=function(e){var t;return e&&(this._consoleLevel=e),this._consoleLevel||(null===(t=this.parent)||void 0===t?void 0:t.consoleLevel())},e.prototype.log=function(e,t,n){this.publishMessage(t||"info",e,n)},e.prototype.trace=function(e){this.log(e,"trace")},e.prototype.debug=function(e){this.log(e,"debug")},e.prototype.info=function(e){this.log(e,"info")},e.prototype.warn=function(e){this.log(e,"warn")},e.prototype.error=function(e,t){this.log(e,"error")},e.prototype.canPublish=function(e,t){return ue.indexOf(e)>=ue.indexOf(t||this.consoleLevel()||"trace")},e.prototype.publishMessage=function(t,n,i){var r=this.loggerFullName;if("error"===t&&!i){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(t,this.publishLevel())){var s=e.Interop;if(s)try{s.methods({name:e.InteropMethodName}).length>0&&s.invoke(e.InteropMethodName,{msg:""+n,logger:r,level:t})}catch(e){}}if(this.canPublish(t)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+t+"] "}var d=""+a+r+": "+n;switch(t){case"trace":this.logFn.debug(d);break;case"debug":this.logFn.debug?this.logFn.debug(d):this.logFn.log(d);break;case"info":this.logFn.info(d);break;case"warn":this.logFn.warn(d);break;case"error":this.logFn.error(d,i)}}},e.InteropMethodName="T42.AppLogger.Log",e}(),le="create-context",pe="created",ge="destroyed",fe="context-created",ye="context-added",me="subscribe-context",ve="subscribed-context",we="unsubscribe-context",be="destroy-context",_e="context-destroyed",Ie="update-context",Ce="context-updated",Ae="joined",xe={get name(){return"context"},get types(){return[le,pe,ge,fe,ye,me,ve,we,be,_e,Ie,Ce,Ae]}},Te="5.7.5";var ke=function(){function e(e,t,n,i){this.updateCallbacks={},this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=i,this.context={}}return e.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},e.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},e}();function Se(e,t,i){try{if((null==i?void 0:i.canPublish("trace"))&&(null==i||i.trace("applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e))),!t)return e;if(t.reset)return e=n({},t.reset);if(e=Pe(e,void 0),t.commands){for(var r=0,o=t.commands;r<o.length;r++){var s=o[r];"remove"===s.type?We(e,s.path):"set"===s.type&&Re(e,s.value,s.path)}return e}var a=t.added,c=t.updated,d=t.removed;return a&&Object.keys(a).forEach((function(t){e[t]=a[t]})),c&&Object.keys(c).forEach((function(t){Me(t,e,c)})),d&&d.forEach((function(t){delete e[t]})),e}catch(n){return null==i||i.error("error applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e),n),e}}function Pe(e,t){if(t=t||new WeakMap,Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(t.has(e))return t.get(e);var n=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e.constructor?new e.constructor:Object.create(null);return t.set(e,n),e instanceof Map&&Array.from(e,(function(e){var i=e[0],r=e[1];return n.set(i,Pe(r,t))})),Object.assign.apply(Object,o([n],Object.keys(e).map((function(n){var i;return(i={})[n]=Pe(e[n],t),i}))))}var Me=function(e,t,n){var i=n[e];if(void 0===i)return t;var r=t[e];return r&&i?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(r)||Array.isArray(i)?(t[e]=i,t):(t[e]=Object.assign({},r,i),t):(t[e]=i,t)};function Ee(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!Ee(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function Re(e,t,n){var i,r=n.split(".");for(i=0;i<r.length-1;i++)e[r[i]]||(e[r[i]]={}),"object"!=typeof e[r[i]]&&(e[r[i]]={}),e=e[r[i]];e[r[i]]=t}function je(e,t){return Object.keys(t).every((function(n){return"object"==typeof t[n]?je((null==e?void 0:e[n])||{},t[n]||{}):t[n]===(null==e?void 0:e[n])}))}function We(e,t){var n,i=t.split(".");for(n=0;n<i.length-1;n++){if(!e[i[n]])return;e=e[i[n]]}delete e[i[n]]}var Oe,Ne=function(){function e(e){var t,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._contextsTempCache={},this._contextsSubscriptionsCache=[],this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[fe,ve,_e,Ce]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined((function(e){if(e)return n._reAnnounceKnownContexts?void n.reInitiateState().then((function(){return n._connection.setLibReAnnounced({name:"contexts"})})):n._connection.setLibReAnnounced({name:"contexts"})})),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(t=this._connection.replayer)||void 0===t||t.drain(xe.name,(function(e){var t=e.type;t&&(t===fe||t===ye||t===pe?n.handleContextCreatedMessage(e):t===ve||t===Ce||t===Ae?n.handleContextUpdatedMessage(e):t!==_e&&t!==ge||n.handleContextDestroyedMessage(e))}))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;if(!this._protocolVersion){var t=this._connection.availableDomains.find((function(e){return"context"===e.uri}));this._protocolVersion=null!==(e=null==t?void 0:t.version)&&void 0!==e?e:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){for(var e=0,t=this._gw3Subscriptions;e<t.length;e++){var n=t[e];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},e.prototype.createContext=function(e,t){var n=this;return this._gw3Session.send({type:le,domain:"global",name:e,data:t,lifetime:"retained"}).then((function(i){n._contextNameToId[e]=i.context_id,n._contextIdToName[i.context_id]=e;var r=n._contextNameToData[e]||new ke(i.context_id,e,!0,void 0);return r.isAnnounced=!0,r.name=e,r.contextId=i.context_id,r.context=i.data||t,r.hasReceivedSnapshot=!0,n._contextNameToData[e]=r,i.context_id}))},e.prototype.all=function(){var e=this;return Object.keys(this._contextNameToData).filter((function(t){return e._contextNameToData[t].isAnnounced}))},e.prototype.update=function(e,t){var n;return i(this,void 0,void 0,(function(){var i,o,s,a=this;return r(this,(function(r){switch(r.label){case 0:return(i=this._contextNameToData[e])&&i.isAnnounced?(o=i.context,i.hasCallbacks()?[3,2]:[4,this.get(i.name)]):[2,this.createContext(e,t)];case 1:o=r.sent(),r.label=2;case 2:return s=2===this.protocolVersion?this.calculateContextDeltaV2(o,t):this.calculateContextDeltaV1(o,t),Object.keys(s.added).length||Object.keys(s.updated).length||s.removed.length||(null===(n=s.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:Ie,domain:"global",context_id:i.contextId,delta:s},{},{skipPeerId:!1}).then((function(e){a.handleUpdated(i,s,{updaterId:e.peer_id})}))]:[2,Promise.resolve()]}}))}))},e.prototype.set=function(e,t){var n=this,i=this._contextNameToData[e];return i&&i.isAnnounced?this._gw3Session.send({type:Ie,domain:"global",context_id:i.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(i,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)},e.prototype.setPath=function(e,t,n){return this.setPathSupported?this.setPaths(e,[{path:t,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},e.prototype.setPaths=function(e,t){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var i=this._contextNameToData[e];if(!i||!i.isAnnounced){for(var r={},o=0,s=t;o<s.length;o++){Re(r,(u=s[o]).value,u.path)}return this.createContext(e,r)}for(var a=[],c=0,d=t;c<d.length;c++){var u;null===(u=d[c]).value?a.push({type:"remove",path:u.path}):a.push({type:"set",path:u.path,value:u.value})}return this._gw3Session.send({type:Ie,domain:"global",context_id:i.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(i,{added:{},removed:[],updated:{},commands:a},{updaterId:e.peer_id})}))},e.prototype.get=function(e){var t,n=this,i=this._contextNameToData[e];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&(!i.hasCallbacks()||!i.hasReceivedSnapshot))return new Promise((function(t){n.subscribe(e,(function(e,i,r,o){n.unsubscribe(o),t(e)}))}));var r=null!==(t=null==i?void 0:i.context)&&void 0!==t?t:{};return Promise.resolve(r)},e.prototype.subscribe=function(e,t,n){var i=this,r=void 0===n?this._nextCallbackSubscriptionNumber:n;void 0===n&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every((function(e){return e.subKey!==i._nextCallbackSubscriptionNumber}))&&this._contextsSubscriptionsCache.push({contextName:e,subKey:r,callback:t});var o=this._contextNameToData[e];if(!o||!o.isAnnounced)return o=o||new ke(void 0,e,!1,void 0),this._contextNameToData[e]=o,o.updateCallbacks[r]=t,Promise.resolve(r);var s=o.hasCallbacks();if(o.updateCallbacks[r]=t,s){if(o.hasReceivedSnapshot)t(a=Pe(o.context),a,[],r);return Promise.resolve(r)}if(o.joinedActivity){if(o.hasReceivedSnapshot)t(a=Pe(o.context),a,[],r);return Promise.resolve(r)}if(o.context&&o.sentExplicitSubscription){var a;if(o.hasReceivedSnapshot)t(a=Pe(o.context),a,[],r);return Promise.resolve(r)}return this.sendSubscribe(o).then((function(){return r}))},e.prototype.unsubscribe=function(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter((function(t){return t.subKey!==e}));for(var t=0,n=Object.keys(this._contextNameToData);t<n.length;t++){var i=n[t],r=this._contextNameToData[i];if(!r)return;var o=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&o&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[i]}},e.prototype.destroy=function(e){var t=this._contextNameToData[e];return t?this._gw3Session.send({type:be,domain:"global",context_id:t.contextId}).then((function(e){})):Promise.reject("context with "+e+" does not exist")},e.prototype.handleUpdated=function(e,t,n){var i=e.context;e.context=Se(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||Ee(i,e.context)||this.invokeUpdateCallbacks(e,t,n)},e.prototype.subscribeToContextCreatedMessages=function(){for(var e=0,t=[ye,fe,pe];e<t.length;e++){var n=t[e],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},e.prototype.handleContextCreatedMessage=function(e){var t=this,n=e.type;n===pe?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):n===ye&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);var i=this._contextIdToName[e.context_id];if(!i)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[i])throw new Error("Received created event for context with unknown id: "+e.context_id);var r=this._contextNameToData[i];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=e.context_id,r.activityId=e.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[i]=r=new ke(e.context_id,i,!0,e.activity_id),this._trackAllContexts&&this.subscribe(i,(function(){})).then((function(e){return t._systemContextsSubKey=e}))},e.prototype.subscribeToContextUpdatedMessages=function(){for(var e=0,t=[Ce,ve,Ae];e<t.length;e++){var n=t[e],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},e.prototype.handleContextUpdatedMessage=function(e){var t=e.type,n=e.context_id,i=this._contextNameToData[this._contextIdToName[n]],r=!i||!i.isAnnounced;if(t===Ae)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=e.activity_id):(i=new ke(n,e.activity_id,!0,e.activity_id),this._contextNameToData[e.activity_id]=i,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(t===ve?((i=i||new ke(n,e.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[e.name]=i,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=i.context;if(i.hasReceivedSnapshot=!0,t===ve)i.context=e.data||{};else if(t===Ae)i.context=e.context_snapshot||{};else{if(t!==Ce)throw new Error("Unrecognized context update message "+t);i.context=Se(i.context,e.delta,this._logger)}!r&&Ee(i.context,o)&&t!==ve||this.invokeUpdateCallbacks(i,e.delta,{updaterId:e.updater_id})},e.prototype.invokeUpdateCallbacks=function(e,t,n){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(var i=0,r=t.commands;i<r.length;i++){var o=r[i];"remove"===o.type?(-1===o.path.indexOf(".")&&t.removed.push(o.path),Re(t.updated,null,o.path)):"set"===o.type&&Re(t.updated,o.value,o.path)}}for(var s in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(s))try{(0,e.updateCallbacks[s])(Pe(e.context),Object.assign({},t.added||{},t.updated||{},t.reset||{}),t.removed,parseInt(s,10),n)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}},e.prototype.subscribeToContextDestroyedMessages=function(){for(var e=0,t=[_e,ge];e<t.length;e++){var n=t[e],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},e.prototype.handleContextDestroyedMessage=function(e){var t,n;if(e.type===ge){if(n=e.activity_id,!(t=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+e.activity_id)}else if(t=e.context_id,!(n=this._contextIdToName[t]))return void this._logger.error("Received 'destroyed' for unknown context: "+e.context_id);delete this._contextIdToName[t],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+t)},e.prototype.sendSubscribe=function(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:me,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.sendUnsubscribe=function(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:we,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.calculateContextDeltaV1=function(e,t){var n={added:{},updated:{},removed:[],reset:void 0};if(e)for(var i=0,r=Object.keys(e);i<r.length;i++){var o=r[i];-1===Object.keys(t).indexOf(o)||null===t[o]||Ee(e[o],t[o])||(n.updated[o]=t[o])}for(var s=0,a=Object.keys(t);s<a.length;s++){o=a[s];e&&-1!==Object.keys(e).indexOf(o)?null===t[o]&&n.removed.push(o):null!==t[o]&&(n.added[o]=t[o])}return n},e.prototype.calculateContextDeltaV2=function(e,t){for(var n,i,r={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(t);o<s.length;o++){var a=s[o];if(null!==t[a])Ee(e?e[a]:null,t[a])||null===(n=r.commands)||void 0===n||n.push({type:"set",path:a,value:t[a]});else null===(i=r.commands)||void 0===i||i.push({type:"remove",path:a})}return r},e.prototype.resetState=function(){for(var e=this,t=0,n=this._gw3Subscriptions;t<n.length;t++){var i=n[t];this._connection.off(i)}this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce((function(t,n){return t[n]=e._contextNameToData[n].context,t}),{}),this._contextNameToData={}},e.prototype.reInitiateState=function(){var e;return i(this,void 0,void 0,(function(){var t,n,i,o,s,a=this;return r(this,(function(r){switch(r.label){case 0:return this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(xe.name,(function(e){var t=e.type;t&&(t===fe||t===ye||t===pe?a.handleContextCreatedMessage(e):t===ve||t===Ce||t===Ae?a.handleContextUpdatedMessage(e):t!==_e&&t!==ge||a.handleContextDestroyedMessage(e))})),[4,Promise.all(this._contextsSubscriptionsCache.map((function(e){return a.subscribe(e.contextName,e.callback,e.subKey)})))];case 1:return r.sent(),[4,this.flushQueue()];case 2:for(n in r.sent(),t=[],this._contextsTempCache)t.push(n);i=0,r.label=3;case 3:return i<t.length?(o=t[i],"object"!=typeof this._contextsTempCache[o]||0===Object.keys(this._contextsTempCache[o]).length?[3,5]:(s=this._contextsTempCache[o],this._logger.info("Re-announcing known context: "+o),[4,this.update(o,s)])):[3,6];case 4:r.sent(),r.label=5;case 5:return i++,[3,3];case 6:return this._contextsTempCache={},this._logger.info("Contexts are re-announced"),[2]}}))}))},e.prototype.flushQueue=function(){return new Promise((function(e){return setTimeout((function(){return e()}),0)}))},e}(),Fe=function(){function e(e){this._bridge=new Ne(e)}return e.prototype.all=function(){return this._bridge.all()},e.prototype.update=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)},e.prototype.set=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)},e.prototype.setPath=function(e,t,n){return this.checkName(e),this.checkPath(t),""===t?(this.checkData(n),this.set(e,n)):this._bridge.setPath(e,t,n)},e.prototype.setPaths=function(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,i=t;n<i.length;n++){var r=i[n],o=r.path,s=r.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(e,t)},e.prototype.subscribe=function(e,t){var n=this;if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,(function(e,i,r,o,s){return t(e,i,r,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(e){return function(){n._bridge.unsubscribe(e)}}))},e.prototype.get=function(e){return this.checkName(e),this._bridge.get(e)},e.prototype.ready=function(){return Promise.resolve(this)},e.prototype.destroy=function(e){return this.checkName(e),this._bridge.destroy(e)},Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),e.prototype.checkName=function(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")},e.prototype.checkPath=function(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")},e.prototype.checkData=function(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")},e}();function Le(e,t,n){return"function"!=typeof t&&"function"!=typeof n?e:("function"!=typeof t?t=function(){}:"function"!=typeof n&&(n=function(){}),e.then(t,n))}function De(e,t,n){var i;void 0===e&&(e=0);var r=function(){i&&clearTimeout(i)};return t.then((function(){r()})).catch((function(){r()})),new Promise((function(t,r){i=setTimeout((function(){return r(n)}),e)}))}!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(Oe||(Oe={}));var Ge=function(){function e(e,t,n,i){this.protocol=e,this.repo=t,this.instance=n,this.configuration=i}return e.prototype.subscribe=function(e,t,n,i,r){var o=this,s=function(e,n,i,s){var a;t.methodResponseTimeout=null!==(a=t.methodResponseTimeout)&&void 0!==a?a:t.waitTimeoutMs,o.protocol.client.subscribe(n,t,e,i,s,r)};return Le(new Promise((function(n,i){var r,a=function(e){n(e)},c=function(e){i(e)};if(e)if((r="string"==typeof e?{name:e}:e).name){void 0===t&&(t={});var d=t.target;if(void 0===d&&(d="best"),"string"!=typeof d||"all"===d||"best"===d){void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=o.configuration.waitTimeoutMs));var u=0,h=o.getServerMethodsByFilterAndTarget(r,d);if(h.length>0)s(h,h[0].methods[0],a,c);else{var l=function(){if(d&&t.waitTimeoutMs)if(u+=500,(h=o.getServerMethodsByFilterAndTarget(r,d)).length>0){var n=h[0].methods[0];s(h,n,a,c)}else if(u>=t.waitTimeoutMs){s(h,"string"==typeof e?{name:e}:e,a,c)}else setTimeout(l,500)};setTimeout(l,500)}}else i(new Error('"'+d+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,i)},e.prototype.servers=function(e){var t=void 0===e?void 0:n({},e);return this.getServers(t).map((function(e){return e.server.instance}))},e.prototype.methods=function(e){return e="string"==typeof e?{name:e}:n({},e),this.getMethods(e)},e.prototype.methodsForInstance=function(e){return this.getMethodsForInstance(e)},e.prototype.methodAdded=function(e){return this.repo.onMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.repo.onMethodRemoved(e)},e.prototype.serverAdded=function(e){return this.repo.onServerAdded(e)},e.prototype.serverRemoved=function(e){return this.repo.onServerRemoved((function(t,n){e(t,n)}))},e.prototype.serverMethodAdded=function(e){return this.repo.onServerMethodAdded((function(t,n){e({server:t,method:n})}))},e.prototype.serverMethodRemoved=function(e){return this.repo.onServerMethodRemoved((function(t,n){e({server:t,method:n})}))},e.prototype.invoke=function(e,t,o,s,a,c){return i(this,void 0,void 0,(function(){var d,u=this;return r(this,(function(h){return d=function(){return i(u,void 0,void 0,(function(){var i,a,c,d,u,h,l,p,g,f,y,m,v=this;return r(this,(function(r){switch(r.label){case 0:if(!(i="string"==typeof e?{name:e}:n({},e)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(t||(t={}),o||(o="best"),"string"==typeof o&&"all"!==o&&"best"!==o&&"skipMine"!==o)return[2,Promise.reject(new Error('"'+o+'" is not a valid target. Valid targets are "all" and "best".'))];if(s||(s={}),void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=s.method_response_timeout,void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=s.wait_for_method_timeout,void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==s.waitTimeoutMs&&"number"!=typeof s.waitTimeoutMs)return[2,Promise.reject(new Error('"'+s.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof t)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+i.name))];if(0!==(a=this.getServerMethodsByFilterAndTarget(i,o)).length)return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(i,o,s)];case 2:return a=r.sent(),[3,4];case 3:return r.sent(),c=n(n({},i),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(f=i.objectTypes)&&void 0!==f?f:[],flags:null!==(m=null===(y=i.flags)||void 0===y?void 0:y.metadata)&&void 0!==m?m:{}}),d={method:c,called_with:t,message:"Can not find a method matching "+JSON.stringify(e)+" with server filter "+JSON.stringify(o),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(d)];case 4:return u=s.methodResponseTimeoutMs,h=s,l=a.map((function(e){var n=ne(),i=e.methods[0],r=e.server,o=v.protocol.client.invoke(n,i,t,r,h);return Promise.race([o,De(u,o,{invocationId:n,message:"Invocation timeout ("+u+" ms) reached for method name: "+(null==i?void 0:i.name)+", target instance: "+JSON.stringify(r.instance)+", options: "+JSON.stringify(h),status:Oe.Error})])})),[4,Promise.all(l)];case 5:return p=r.sent(),g=this.getInvocationResultObj(p,i,t),p.every((function(e){return e.status===Oe.Error}))?[2,Promise.reject(g)]:[2,g]}}))}))},[2,Le(d(),a,c)]}))}))},e.prototype.getInvocationResultObj=function(e,t,n){var i=e.filter((function(e){return e.status===Oe.Success})).reduce((function(e,i){return e=o(e,[{executed_by:i.instance,returned:i.result,called_with:n,method:t,message:i.message,status:i.status}])}),[]),r=e.filter((function(e){return e.status===Oe.Error})).reduce((function(e,i){return e=o(e,[{executed_by:i.instance,called_with:n,name:t.name,message:i.message}])}),[]),s=e[0];return{method:t,called_with:n,returned:s.result,executed_by:s.instance,all_return_values:i,all_errors:r,message:s.message,status:s.status}},e.prototype.tryToAwaitForMethods=function(e,t,n){var i=this;return new Promise((function(r,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(e,t);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},e.prototype.filterByTarget=function(e,t){var n=this;if("string"!=typeof e){return(Array.isArray(e)?e:[e]).reduce((function(e,i){var r=t.filter((function(e){return n.instanceMatch(i,e.server.instance)}));return e.concat(r)}),[])}if("all"===e)return o(t);if("best"===e){var i=t.find((function(e){return e.server.instance.isLocal}));if(i)return[i];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((function(e){return e.server.instance.peerId!==n.instance.peerId}));return[]},e.prototype.instanceMatch=function(e,t){return this.containsProps(e,t)},e.prototype.methodMatch=function(e,t){return this.containsProps(e,t)},e.prototype.containsProps=function(e,t){return Object.keys(e).filter((function(t){return void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]})).every((function(n){var i,r=e[n],o=t[n];switch(n){case"objectTypes":i=(r||[]).every((function(e){return(o||[]).includes(e)}));break;case"flags":i=je(o||{},r||{});break;default:i=String(r).toLowerCase()===String(o).toLowerCase()}return i}))},e.prototype.getMethods=function(e){var t=this;return void 0===e?this.repo.getMethods():this.repo.getMethods().filter((function(n){return t.methodMatch(e,n)}))},e.prototype.getMethodsForInstance=function(e){var t=this,n=this.repo.getServers().filter((function(n){return t.instanceMatch(e,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(e){Object.keys(e.methods).forEach((function(t){var n=e.methods[t];i[n.identifier]=n}))})),Object.keys(i).map((function(e){return i[e]}))},e.prototype.getServers=function(e){var t=this,n=this.repo.getServers();return void 0===e?n.map((function(e){return{server:e,methods:[]}})):n.reduce((function(n,i){var r=Object.values(i.methods).filter((function(n){return t.methodMatch(e,n)}));return r.length>0&&n.push({server:i,methods:r}),n}),[])},e.prototype.getServerMethodsByFilterAndTarget=function(e,t){var n=this.getServers(e);return this.filterByTarget(t,n)},e}(),Be=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}return Object.defineProperty(e.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},e.prototype.push=function(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)},e}(),qe=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return e.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},e.prototype.acceptOnBranch=function(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)},e.prototype.reject=function(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)},e}(),He=function(){function e(e,t){var n=this;this.protocol=e,this.server=t,e.server.onSubRequest((function(e,t){return n.handleSubRequest(e,t)})),e.server.onSubAdded((function(e,t){return n.handleSubAdded(e,t)})),e.server.onSubRemoved((function(e,t){return n.handleSubRemoved(e,t)}))}return e.prototype.handleSubRequest=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRequestHandler){var n=new qe(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}},e.prototype.handleSubAdded=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionAddedHandler){var n=new Be(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}},e.prototype.handleSubRemoved=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRemovedHandler){var n=new Be(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}},e}(),Ue=function(){function e(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}return e.prototype.subscriptions=function(){var e=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(t){return new Be(e.protocol,e.repoMethod,t)}))},e.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},e.prototype.push=function(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])},e}(),Ve=function(){function e(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}return e.prototype.branches=function(e){var t=this,n=this._protocol.server.getBranchList(this._repoMethod);return e?n.indexOf(e)>-1?new Ue(e,this._protocol,this._repoMethod):void 0:n.map((function(e){return new Ue(e,t._protocol,t._repoMethod)}))},e.prototype.branch=function(e){return this.branches(e)},e.prototype.subscriptions=function(){var e=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(t){return new Be(e._protocol,e._repoMethod,t)}))},Object.defineProperty(e.prototype,"definition",{get:function(){var e,t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming,flags:null===(e=t.flags)||void 0===e?void 0:e.metadata}},enumerable:!0,configurable:!0}),e.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},e.prototype.push=function(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)},e.prototype.updateRepoMethod=function(e){this._repoMethod=e},e}(),Je=function(){function e(e,t){this.protocol=e,this.serverRepository=t,this.invocations=0,this.currentlyUnregistering={},this.streaming=new He(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return e.prototype.createStream=function(e,t,i,r,o){var s=this;return Le(new Promise((function(i,r){if(e){var a;if(!(a="string"==typeof e?{name:""+e}:n({},e)).name)return r("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(a));if(s.serverRepository.getList().some((function(e){return e.definition.name===a.name})))return r('A stream with the name "'+a.name+'" already exists! Please, provide a unique name for the stream.');a.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=function(e){e.accept()});var c=s.serverRepository.add({definition:a,streamCallbacks:t,protocolState:{}});s.protocol.server.createStream(c).then((function(){var e;o?(e=o,o.updateRepoMethod(c)):e=new Ve(s.protocol,c,s),c.stream=e,i(e)})).catch((function(e){c.repoId&&s.serverRepository.remove(c.repoId),r(e)}))}else r("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),i,r)},e.prototype.register=function(e,t){var n=this;if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var o=function(e,o){return i(n,void 0,void 0,(function(){var n,i,s;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),(n=t(e.args,e.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return i=r.sent(),o(void 0,i),[3,3];case 2:o(void 0,n),r.label=3;case 3:return[3,5];case 4:return(s=r.sent())||(s=""),o(s,s),[3,5];case 5:return[2]}}))}))};return o.userCallback=t,this.registerCore(e,o)},e.prototype.registerAsync=function(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var n=function(e,n){try{var i=!1,r=function(e){i||n(void 0,e),i=!0},o=function(e){i||(e||(e=""),n(e,e)),i=!0},s=t(e.args,e.instance,r,o);s&&"function"==typeof s.then&&s.then(r).catch(o)}catch(e){n(e,void 0)}};return n.userCallbackAsync=t,this.registerCore(e,n)},e.prototype.unregister=function(e,t){return void 0===t&&(t=!1),i(this,void 0,void 0,(function(){var n,i;return r(this,(function(r){switch(r.label){case 0:return void 0===e?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof e?[3,2]:[4,this.unregisterWithPredicate(e,t)];case 1:case 3:return r.sent(),[2];case 2:return void 0===(n="string"==typeof e?{name:e}:e).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(e){return e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')]}}))}))},e.prototype.unregisterWithPredicate=function(e,t){return i(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(t){return e(t.definition)})).filter((function(e){return(e.definition.supportsStreaming||!1)===t})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(t?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},e.prototype.removeMethodsOrStreams=function(e){var t=this,n=[];return e.forEach((function(e){var i=t.protocol.server.unregister(e).then((function(){e.repoId&&t.serverRepository.remove(e.repoId)}));n.push(i),t.addAsCurrentlyUnregistering(e.definition.name,i)})),Promise.all(n)},e.prototype.addAsCurrentlyUnregistering=function(e,t){return i(this,void 0,void 0,(function(){var n,i=this;return r(this,(function(r){return n=new Promise((function(e){return setTimeout(e,5e3)})),this.currentlyUnregistering[e]=Promise.race([t,n]).then((function(){delete i.currentlyUnregistering[e]})),[2]}))}))},e.prototype.registerCore=function(e,t){return i(this,void 0,void 0,(function(){var i,o,s,a=this;return r(this,(function(r){switch(r.label){case 0:return(i="string"==typeof e?{name:""+e}:n({},e)).name?(o=this.currentlyUnregistering[i.name])?[4,o]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(e))];case 1:r.sent(),r.label=2;case 2:return this.serverRepository.getList().some((function(e){return e.definition.name===i.name}))?[2,Promise.reject('A method with the name "'+i.name+'" already exists! Please, provide a unique name for the method.')]:i.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+i.name+" to be a stream, please use the glue.interop.createStream() method.")]:(s=this.serverRepository.add({definition:i,theFunction:t,protocolState:{}}),[2,this.protocol.server.register(s).catch((function(e){throw(null==s?void 0:s.repoId)&&a.serverRepository.remove(s.repoId),e}))])}}))}))},e.prototype.onMethodInvoked=function(e,t,n){var i=this;e&&e.theFunction&&e.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},i.protocol.server.methodInvocationResult(e,t,n,r)}))},e}(),ze=function(){function e(e,t,n){var i=this;this.wrapped={},this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((function(e){return e.supportsStreaming}))},t&&this.refreshWrappedObject(t),n&&(n.loggedIn((function(){i.refresh(n)})),this.refresh(n))}return e.prototype.unwrap=function(){return this.wrapped},e.prototype.refresh=function(e){if(e){var t=null==e?void 0:e.resolvedIdentity,n=Object.assign({},null!=t?t:{},{peerId:null==e?void 0:e.peerId});this.refreshWrappedObject(n)}},e.prototype.refreshWrappedObject=function(e){var t,n,i,r,o=this;Object.keys(e).forEach((function(t){o.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=null!==(t=e.application)&&void 0!==t?t:ne(),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=null!==(i=null!==(n=e.pid)&&void 0!==n?n:e.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=null===(r=e.isLocal)||void 0===r||r,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId},e}(),$e=function(e){return n(n({},e),{flags:e.flags.metadata||{}})},Ke=function(){function e(e,t){this.logger=e,this.API=t,this.servers={},this.methodsCount={},this.callbacks=E();var n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}return e.prototype.addServer=function(e,t){this.logger.debug("adding server "+t);var n=this.servers[t];if(n)return n.id;var i=new ze(this.API,e),r={id:t,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[t]=r,this.callbacks.execute("onServerAdded",r.instance),t},e.prototype.removeServerById=function(e,t){var n=this,i=this.servers[e];i?(this.logger.debug("removing server "+e),Object.keys(i.methods).forEach((function(t){n.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",i.instance,t)):this.logger.warn("not aware of server "+e+", my state "+JSON.stringify(Object.keys(this.servers)))},e.prototype.addServerMethod=function(e,t){var n,i=this.servers[e];if(!i)throw new Error("server does not exists");if(!i.methods[t.id]){var r=this.createMethodIdentifier(t),o=this,s={identifier:r,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:null!==(n=t.flags)&&void 0!==n?n:{},getServers:function(){return o.getServersByMethod(r)}};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,i.methods[t.id]=s;var a=$e(s);return this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",a)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",i.instance,a),s}},e.prototype.removeServerMethod=function(e,t){var n=this.servers[e];if(!n)throw new Error("server does not exists");var i=n.methods[t];delete n.methods[t];var r=$e(i);this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},e.prototype.getMethods=function(){return this.extractMethodsFromServers(Object.values(this.servers)).map($e)},e.prototype.getServers=function(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)},e.prototype.onServerAdded=function(e){var t=this.callbacks.add("onServerAdded",e),n=this.getServers().map((function(e){return e.instance}));return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onMethodAdded=function(e){var t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onServerMethodAdded=function(e){var t=this.callbacks.add("onServerMethodAdded",e),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(t){var i=t.methods;Object.keys(i).forEach((function(r){n||e(t.instance,i[r])}))}))}),0),function(){n=!0,t()}},e.prototype.onMethodRemoved=function(e){return this.callbacks.add("onMethodRemoved",e)},e.prototype.onServerRemoved=function(e){return this.callbacks.add("onServerRemoved",e)},e.prototype.onServerMethodRemoved=function(e){return this.callbacks.add("onServerMethodRemoved",e)},e.prototype.getServerById=function(e){return this.hideServerMethodSystemFlags(this.servers[e])},e.prototype.reset=function(){var e,t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers=((e={})[this.myServer.id]=this.myServer,e),this.methodsCount={}},e.prototype.createMethodIdentifier=function(e){var t,n,i=null!==(t=e.input_signature)&&void 0!==t?t:"",r=null!==(n=e.result_signature)&&void 0!==n?n:"";return(e.name+i+r).toLowerCase()},e.prototype.getServersByMethod=function(e){var t=[];return Object.values(this.servers).forEach((function(n){Object.values(n.methods).forEach((function(i){i.identifier===e&&t.push(n.instance)}))})),t},e.prototype.returnUnsubWithDelayedReplay=function(e,t,n){var i=!1;return setTimeout((function(){t.forEach((function(e){i||n(e)}))}),0),function(){i=!0,e()}},e.prototype.hideServerMethodSystemFlags=function(e){var t={};return Object.entries(e.methods).forEach((function(e){var n=e[0],i=e[1];t[n]=$e(i)})),n(n({},e),{methods:t})},e.prototype.extractMethodsFromServers=function(e){return Object.values(e).reduce((function(e,t){return o(e,Object.values(t.methods))}),[])},e}(),Qe=function(){function e(){this.nextId=0,this.methods=[]}return e.prototype.add=function(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e},e.prototype.remove=function(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(t){return t.repoId!==e}))},e.prototype.getById=function(e){if("string"==typeof e)return this.methods.find((function(t){return t.repoId===e}))},e.prototype.getList=function(){return this.methods.map((function(e){return e}))},e.prototype.length=function(){return this.methods.length},e.prototype.reset=function(){this.methods=[]},e}(),Ze="onSubscriptionRequest",Xe="onSubscriptionAdded",Ye="onSubscriptionRemoved",et=function(){function e(e,t,n){var i=this;this.session=e,this.repository=t,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=E(),this.nextStreamId=0,e.on("add-interest",(function(e){i.handleAddInterest(e)})),e.on("remove-interest",(function(e){i.handleRemoveInterest(e)}))}return e.prototype.acceptRequestOnBranch=function(e,t,n){if("string"!=typeof n&&(n=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(t,n),r=e.msg.subscription_id,o={id:r,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:i,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[r]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:i}),this.callbacks.execute(Xe,o,t)},e.prototype.rejectRequest=function(e,t,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)},e.prototype.pushData=function(e,t,n){var i=this;if("object"==typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),e.protocolState.branchKeyToStreamIdMap.filter((function(e){return!n||0===n.length||n.indexOf(e.key)>=0})).map((function(e){return e.streamId})).forEach((function(e){var n={type:"publish",stream_id:e,data:t};i.session.sendFireAndForget(n)}))}},e.prototype.pushDataToSingle=function(e,t,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(i)},e.prototype.closeSingleSubscription=function(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];var n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n),t.instance,this.callbacks.execute(Ye,t,e)},e.prototype.closeMultipleSubscriptions=function(e,t){var n=this;if("object"==typeof e&&"object"==typeof e.protocolState.subscriptionsMap&&e.protocolState.subscriptionsMap){var i=e.protocolState.subscriptionsMap,r=Object.keys(i).map((function(e){return i[e]}));"string"==typeof t&&(r=r.filter((function(e){return e.branchKey===t}))),r.forEach((function(e){delete i[e.id];var t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};n.session.sendFireAndForget(t)}))}},e.prototype.getSubscriptionList=function(e,t){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var n=e.protocolState.subscriptionsMap,i=Object.keys(n).map((function(e){return n[e]}));return"string"!=typeof t?i:i.filter((function(e){return e.branchKey===t}))},e.prototype.getBranchList=function(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var t=e.protocolState.subscriptionsMap,n=Object.keys(t).map((function(e){return t[e]})),i=[];return n.forEach((function(e){var t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===i.indexOf(t)&&i.push(t)})),i},e.prototype.onSubAdded=function(e){this.onSubscriptionLifetimeEvent(Xe,e)},e.prototype.onSubRequest=function(e){this.onSubscriptionLifetimeEvent(Ze,e)},e.prototype.onSubRemoved=function(e){this.onSubscriptionLifetimeEvent(Ye,e)},e.prototype.handleRemoveInterest=function(e){var t=this.serverRepository.getById(e.method_id);if("string"==typeof e.subscription_id&&"object"==typeof t&&t.protocolState.subscriptionsMap&&"object"==typeof t.protocolState.subscriptionsMap[e.subscription_id]){var n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(Ye,n,t)}},e.prototype.onSubscriptionLifetimeEvent=function(e,t){this.callbacks.add(e,t)},e.prototype.getNextStreamId=function(){return this.nextStreamId+++""},e.prototype.handleAddInterest=function(e){var t=this.repository.getServerById(e.caller_id).instance,n={msg:e,arguments:e.arguments_kv||{},instance:t},i=this.serverRepository.getById(e.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(Ze,n,i);else{var r="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(r,e.subscription_id)}},e.prototype.sendSubscriptionFailed=function(e,t){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)},e.prototype.getStreamId=function(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+e.definition.name+" method without protocol state");var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:i})),i},e}(),tt=function(){function e(e,t,n,i){var r=this;this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=i,this.callbacks=E(),this.streaming=new et(e,t,n),this.session.on("invoke",(function(e){return r.handleInvokeMessage(e)}))}return e.prototype.createStream=function(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)},e.prototype.register=function(e,t){var n,i=this,r=e.definition,o=Object.assign({},{metadata:null!==(n=r.flags)&&void 0!==n?n:{}},{streaming:t||!1}),s={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:o,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(s,{methodId:e.repoId}).then((function(){i.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((function(t){throw i.logger.warn("failed to register method "+e.definition.name+" with id "+e.repoId+" - "+JSON.stringify(t)),t}))},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,n,i){var r;r=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(r)},e.prototype.unregister=function(e){return i(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return t={type:"unregister",methods:[e.repoId]},[4,this.session.send(t)];case 1:return n.sent(),[2]}}))}))},e.prototype.getBranchList=function(e){return this.streaming.getBranchList(e)},e.prototype.getSubscriptionList=function(e,t){return this.streaming.getSubscriptionList(e,t)},e.prototype.closeAllSubscriptions=function(e,t){this.streaming.closeMultipleSubscriptions(e,t)},e.prototype.pushData=function(e,t,n){this.streaming.pushData(e,t,n)},e.prototype.pushDataToSingle=function(e,t,n){this.streaming.pushDataToSingle(e,t,n)},e.prototype.closeSingleSubscription=function(e,t){this.streaming.closeSingleSubscription(e,t)},e.prototype.acceptRequestOnBranch=function(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)},e.prototype.rejectRequest=function(e,t,n){this.streaming.rejectRequest(e,t,n)},e.prototype.onSubRequest=function(e){this.streaming.onSubRequest(e)},e.prototype.onSubAdded=function(e){this.streaming.onSubAdded(e)},e.prototype.onSubRemoved=function(e){this.streaming.onSubRemoved(e)},e.prototype.handleInvokeMessage=function(e){var t=e.invocation_id,n=e.caller_id,i=e.method_id,r=e.arguments_kv,o=this.serverRepository.getList().filter((function(e){return e.repoId===i}))[0];if(void 0!==o){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,t,s)}},e}(),nt=function(){function e(e,t){this.repository=e,this.subscriptionData=t}return Object.defineProperty(e.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"servers",{get:function(){var e=this;return this.subscriptionData.trackedServers.filter((function(e){return e.subscriptionId})).map((function(t){return e.repository.getServerById(t.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),e.prototype.onData=function(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(t){e(t)}))},e.prototype.onClosed=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)},e.prototype.onFailed=function(e){},e.prototype.onConnected=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)},e.prototype.close=function(){this.subscriptionData.close()},e.prototype.setNewSubscription=function(e){this.subscriptionData=e},e}(),it=function(){function e(e){this.config=e,this.cache=[],this.timeoutIds=[]}return e.prototype.add=function(e){var t=this,n=ne();this.cache.push({id:n,element:e});var i=setTimeout((function(){var e=t.cache.findIndex((function(e){return e.id===n}));e<0||t.cache.splice(e,1)}),this.config.ELEMENT_TTL_MS);this.timeoutIds.push(i)},e.prototype.flush=function(){var e=this.cache.map((function(e){return e.element}));return this.timeoutIds.forEach((function(e){return clearInterval(e)})),this.cache=[],this.timeoutIds=[],e},e}(),rt="awaitingAccept",ot="subscribed",st="Subscription failed.",at="ClientInitiated",ct=function(){function e(e,t,n){var i=this;this.session=e,this.repository=t,this.logger=n,this.subscriptionsList={},this.timedCache=new it({ELEMENT_TTL_MS:1e4}),this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(e){var t=e._tag,n=t.subLocalKey,r=i.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(e){return e.serverId!==t.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===rt){var o="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===ot&&i.callOnClosedHandlers(r);delete i.subscriptionsList[n]}},this.handleSubscribed=function(e){var t=e._tag.subLocalKey,n=i.subscriptionsList[t];if("object"==typeof n){var r=e._tag.serverId,o=n.trackedServers.filter((function(e){return e.serverId===r}))[0];if("object"==typeof o){o.subscriptionId=e.subscription_id,i.subscriptionIdToLocalKeyMap[e.subscription_id]=t;var s=n.status===rt;if(n.status=ot,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new nt(i.repository,n),n.subscription=c,n.success(c));for(var d=0,u=n.handlers.onConnected;d<u.length;d++){var h=u[d];try{h(c.serverInstance,a)}catch(e){}}}}}},this.handleEventData=function(e){var t=i.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=i.subscriptionsList[t];if("object"==typeof n){var r=n.trackedServers.filter((function(t){return t.subscriptionId===e.subscription_id}));if(1===r.length){var o=e.oob,s=r[0].serverId,a=function(){return{data:e.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,d=n.queued.data;c.length>0?c.forEach((function(e){"function"==typeof e&&e(a())})):d.push(a())}}}},this.handleSubscriptionCancelled=function(e){var t=i.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=i.subscriptionsList[t];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(t){return t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(i.timedCache.add(n),clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[t]),delete i.subscriptionIdToLocalKeyMap[e.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return e.prototype.subscribe=function(e,t,n,i,r,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,e,t,i,r,t.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var i=n.server.id,r=n.methods.find((function(t){return t.name===e.name}));if(r){c.trackedServers.push({serverId:i,subscriptionId:void 0});var o={type:"subscribe",server_id:i,method_id:r.gatewayId,arguments_kv:t.arguments};s.session.send(o,{serverId:i,subLocalKey:a}).then((function(e){return s.handleSubscribed(e)})).catch((function(e){return s.handleErrorSubscribing(e)}))}else s.logger.error("can not find method "+e.name+" for target "+n.server.id)})):r({method:e,called_with:t.arguments,message:st+" Unable to register the user callbacks."})}else r({method:e,called_with:t.arguments,message:st+" No available servers matched the target params."})},e.prototype.drainSubscriptions=function(){var e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e},e.prototype.drainSubscriptionsCache=function(){return this.timedCache.flush()},e.prototype.getNextSubscriptionLocalKey=function(){var e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e},e.prototype.registerSubscription=function(e,t,n,i,r,o,s){var a=this,c={localKey:e,status:rt,method:t,params:n,success:i,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(e)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[e]){var i=a.subscriptionsList[e];i.status===rt?(r({method:t,called_with:n.arguments,message:st+" Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[e]):i.status===ot&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(e){return void 0!==e.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[e]))}}),o),c},e.prototype.callOnClosedHandlers=function(e,t){var n,i=e.queued.closers.length,r=i>0?e.queued.closers[i-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),e.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:n,stream:e.method})}))},e.prototype.closeSubscription=function(e){var t=this,n=this.subscriptionsList[e];"object"==typeof n&&(n.trackedServers.forEach((function(e){void 0!==e.subscriptionId&&(n.queued.closers.push(e.serverId),t.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:at}),delete t.subscriptionIdToLocalKeyMap[e.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,at),delete this.subscriptionsList[e])},e}(),dt=function(){function e(e,t,n){var i=this;this.session=e,this.repository=t,this.logger=n,e.on("peer-added",(function(e){return i.handlePeerAdded(e)})),e.on("peer-removed",(function(e){return i.handlePeerRemoved(e)})),e.on("methods-added",(function(e){return i.handleMethodsAddedMessage(e)})),e.on("methods-removed",(function(e){return i.handleMethodsRemovedMessage(e)})),this.streaming=new ct(e,t,n)}return e.prototype.subscribe=function(e,t,n,i,r,o){this.streaming.subscribe(e,t,n,i,r,o)},e.prototype.invoke=function(e,t,n,i){var r=this,o=i.id,s={type:"call",server_id:o,method_id:t.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:o}).then((function(e){return r.handleResultMessage(e)})).catch((function(e){return r.handleInvocationError(e)}))},e.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},e.prototype.drainSubscriptionsCache=function(){return this.streaming.drainSubscriptionsCache()},e.prototype.handlePeerAdded=function(e){var t=e.new_peer_id,n=e.identity,i=!e.meta||e.meta.local,r=Number(n.process),o={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:i};this.repository.addServer(o,t)},e.prototype.handlePeerRemoved=function(e){var t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)},e.prototype.handleMethodsAddedMessage=function(e){var t=this,n=e.server_id;e.methods.forEach((function(e){t.repository.addServerMethod(n,e)}))},e.prototype.handleMethodsRemovedMessage=function(e){var t=this,n=e.server_id,i=e.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(e){var o=r.methods[e];i.indexOf(o.gatewayId)>-1&&t.repository.removeServerMethod(n,e)}))},e.prototype.handleResultMessage=function(e){var t=e._tag.invocationId,n=e.result,i=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(i).instance,status:Oe.Success,message:""}},e.prototype.handleInvocationError=function(e){if(this.logger.debug("handle invocation error "+JSON.stringify(e)),"_tag"in e){var t=e._tag.invocationId,n=e._tag.serverId,i=this.repository.getServerById(n),r=e.reason;return{invocationId:t,result:e.context,instance:i.instance,status:Oe.Error,message:r}}return{invocationId:"",message:e.message,status:Oe.Error,error:e}},e}();function ut(e,t,n,o,s,a){var c,d=s.logger.subLogger("gw3-protocol"),u=new Promise((function(e){c=e})),h=t.domain("agm",["subscribed"]),l=new tt(h,n,o,d.subLogger("server")),p=new dt(h,n,d.subLogger("client"));return h.onJoined((function(s){n.addServer(e,t.peerId),s?function(){return i(this,void 0,void 0,(function(){var e,t,n,i,s,c,u,h,l,g,f;return r(this,(function(r){switch(r.label){case 0:for(d.info("reconnected - will replay registered methods and subscriptions"),p.drainSubscriptionsCache().forEach((function(e){var t=e.method,n=Object.assign({},e.params);d.info("trying to soft-re-subscribe to method "+t.name+", with params: "+JSON.stringify(n)),a.client.subscribe(t,n,void 0,void 0,e).then((function(){return d.info("soft-subscribing to method "+t.name+" DONE")})).catch((function(e){return d.warn("subscribing to method "+t.name+" failed: "+JSON.stringify(e)+"}")}))})),e=[],t=p.drainSubscriptions(),n=function(t){var n=t.method,i=Object.assign({},t.params);d.info("trying to re-subscribe to method "+n.name+", with params: "+JSON.stringify(i)),e.push(a.client.subscribe(n,i,void 0,void 0,t).then((function(){return d.info("subscribing to method "+n.name+" DONE")})))},i=0,s=t;i<s.length;i++)c=s[i],n(c);for(u=o.getList(),o.reset(),h=function(t){var n=t.definition;d.info("re-publishing method "+n.name),t.stream?e.push(a.server.createStream(n,t.streamCallbacks,void 0,void 0,t.stream).then((function(){return d.info("subscribing to method "+n.name+" DONE")}))):t.theFunction&&t.theFunction.userCallback?e.push(a.register(n,t.theFunction.userCallback).then((function(){return d.info("subscribing to method "+n.name+" DONE")}))):t.theFunction&&t.theFunction.userCallbackAsync&&e.push(a.registerAsync(n,t.theFunction.userCallbackAsync).then((function(){return d.info("subscribing to method "+n.name+" DONE")}))),d.info("re-publishing method "+n.name+" DONE")},l=0,g=u;l<g.length;l++)f=g[l],h(f);return[4,Promise.all(e)];case 1:return r.sent(),d.info("Interop is re-announced"),[2]}}))}))}().then((function(){return t.setLibReAnnounced({name:"interop"})})).catch((function(e){return d.warn("Error while re-announcing interop: "+JSON.stringify(e))})):c&&(c({client:p,server:l}),c=void 0)})),h.onLeft((function(){n.reset()})),h.join(),u}var ht=function(){function e(e){var t=this;if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");var n,i=e.connection;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new ze(this,void 0,i),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new Ke(e.logger.subLogger("cRep"),this),this.serverRepository=new Qe,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=ut(this.instance,i,this.clientRepository,this.serverRepository,e,this),this.readyPromise=n.then((function(n){return t.protocol=n,t.client=new Ge(t.protocol,t.clientRepository,t.instance,e),t.server=new Je(t.protocol,t.serverRepository),t}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.serverRemoved=function(e){return this.client.serverRemoved(e)},e.prototype.serverAdded=function(e){return this.client.serverAdded(e)},e.prototype.serverMethodRemoved=function(e){return this.client.serverMethodRemoved(e)},e.prototype.serverMethodAdded=function(e){return this.client.serverMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.client.methodRemoved(e)},e.prototype.methodAdded=function(e){return this.client.methodAdded(e)},e.prototype.methodsForInstance=function(e){return this.client.methodsForInstance(e)},e.prototype.methods=function(e){return this.client.methods(e)},e.prototype.servers=function(e){return this.client.servers(e)},e.prototype.subscribe=function(e,t,n,i){return this.client.subscribe(e,t,n,i)},e.prototype.createStream=function(e,t,n,i){return this.server.createStream(e,t,n,i)},e.prototype.unregister=function(e){return this.server.unregister(e)},e.prototype.registerAsync=function(e,t){return this.server.registerAsync(e,t)},e.prototype.register=function(e,t){return this.server.register(e,t)},e.prototype.invoke=function(e,t,n,i,r,o){return this.client.invoke(e,t,n,i,r,o)},e.prototype.waitForMethod=function(e){var t=new O,n=this.client.methodAdded((function(i){i.name===e&&(n(),t.resolve(i))}));return t.promise},e}(),lt=["subscribed","success"],pt=function(){function e(e,t){var n=this;this.publish=function(e,t,i){var r=i||{},o=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(e,t,i){return new Promise((function(r,o){var s=i||{},a=s.routingKey,c=s.target,d=n.removeEmptyValues({type:"subscribe",topic:e,peer_id:n.peerId,routing_key:a,source:c});n.session.send(d).then((function(i){var o=i.subscription_id;n.subscriptions.push({subscription_id:o,topic:e,callback:t,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(e){return e.subscription_id!==o})),Promise.resolve()}})})).catch((function(e){return o(e)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(e){var t=e.data,i=e.subscription_id,r=e["publisher-identity"],o=n.subscriptions.find((function(e){return e.subscription_id===i}));o&&(o.source?n.keysMatch(o.source,r)&&o.callback(t,o.topic,r):o.callback(t,o.topic,r))}))},this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",lt),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.removeEmptyValues=function(e){var t={};return Object.keys(e).forEach((function(n){void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t},e.prototype.keysMatch=function(e,t){var n=Object.keys(e),i=!0;return n.forEach((function(n){e[n]!==t[n]&&(i=!1)})),i},e}(),gt=function(e,t){var n,o=W.getGDMajorVersion(),s=Promise.resolve();if(o){if(o<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");o>=3&&(n=window.glue42gd,s=window.gdPreloadPromise||s)}var a,c,d,u,h,l,p,g=F("glue"),f=function(e,t,n){var i,r,o,s,a;if(W.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(e){}}function d(){if(e.application)return e.application;if(n)return n.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;var t=ne();return W.isNode()?a?a.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+t+")":t}var u=function(){var i,r,o,s,c,u,h,l,p,g,f,y=e.gateway,m=null!==(i=null==y?void 0:y.protocolVersion)&&void 0!==i?i:3,v=null==y?void 0:y.reconnectInterval,w=null==y?void 0:y.reconnectAttempts,b=null==y?void 0:y.ws,_=null==y?void 0:y.sharedWorker,I=null==y?void 0:y.inproc,C=null!==(r=null==y?void 0:y.webPlatform)&&void 0!==r?r:void 0;n&&(b=n.gwURL),W.isNode()&&a&&a.gwURL&&(b=a.gwURL),b||_||I||(b="ws://localhost:8385");var A=d(),x=A;void 0!==n?(l=n.windowId,p=n.pid,n.env&&(g=n.env.env,f=n.env.region),x=null!==(o=n.application)&&void 0!==o?o:"glue-app",h=n.appInstanceId):W.isNode()?(p=process.pid,a&&(g=a.env,f=a.region,h=a.instanceId)):void 0!==(null===window||void 0===window?void 0:window.glue42electron)&&(l=null===window||void 0===window?void 0:window.glue42electron.instanceId,p=null===window||void 0===window?void 0:window.glue42electron.pid,g=null===window||void 0===window?void 0:window.glue42electron.env,f=null===window||void 0===window?void 0:window.glue42electron.region,x=null!==(s=null===window||void 0===window?void 0:window.glue42electron.application)&&void 0!==s?s:"glue-app",h=null===window||void 0===window?void 0:window.glue42electron.instanceId);var T=null!==(u=null===(c=e.gateway)||void 0===c?void 0:c.replaySpecs)&&void 0!==u?u:[];T.push(xe);var k={application:x,applicationName:A,windowId:l,instance:h,process:p,region:f,environment:g,api:t.version||Te};return e.identity&&(k=Object.assign(k,e.identity)),{identity:k,reconnectInterval:v,ws:b,sharedWorker:_,webPlatform:C,inproc:I,protocolVersion:m,reconnectAttempts:w,replaySpecs:T}}(),h=d();if("undefined"!=typeof window){var l=window,p=l.htmlContainer?l.htmlContainer.containerName+"."+l.htmlContainer.application:null===(i=null==l?void 0:l.glue42gd)||void 0===i?void 0:i.application;p&&(h=p)}return{bus:null!==(r=e.bus)&&void 0!==r&&r,application:h,auth:function(){var t,n,i;return"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:W.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(t=e.gateway)||void 0===t?void 0:t.webPlatform)||(null===(n=e.gateway)||void 0===n?void 0:n.inproc)||(null===(i=e.gateway)||void 0===i?void 0:i.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var t,i,r,o=e.logger,s="warn";return o||(o=s),n&&(r=n.consoleLogLevel),"string"==typeof o?{console:null!=r?r:o,publish:s}:{console:null!==(t=null!=r?r:o.console)&&void 0!==t?t:s,publish:null!==(i=o.publish)&&void 0!==i?i:s}}(),connection:u,metrics:null===(o=e.metrics)||void 0===o||o,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||Te,libs:null!==(s=t.libs)&&void 0!==s?s:[],customLogger:e.customLogger}}(e=e||{},t=t||{},n),y={};function m(e,t,n){(p=d.canPublish("trace"))&&d.trace("registering "+e+" module");var i=function(){t.initTime=n.stop(),t.initEndTime=n.endTime,t.marks=n.marks,p&&d.trace(e+" is ready - "+(n.endTime-n.startTime))};t.initStartTime=n.startTime,t.ready?t.ready().then((function(){i()})):i(),Array.isArray(e)||(e=[e]),e.forEach((function(e){y[e]=t,gt[e]=t}))}function v(){var e=F("interop"),t={connection:a,logger:d.subLogger("interop")};return c=new ht(t),he.Interop=c,m(["interop","agm"],c,e),Promise.resolve()}function w(){var e=f.activities&&3===a.protocolVersion;if(f.contexts||e){var t=F("contexts");return m("contexts",h=new Fe({connection:a,logger:d.subLogger("contexts"),trackAllContexts:"object"==typeof f.contexts&&f.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof f.contexts&&f.contexts.reAnnounceKnownContexts}),t),h}var n=a.replayer;n&&n.drain(xe.name)}function b(){return i(this,void 0,void 0,(function(){var e;return r(this,(function(t){return f.bus?(e=F("bus"),m("bus",l=new pt(a,d.subLogger("bus")),e),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function _(e){try{return e.forEach((function(e){!function(e,t){var n=F(e),i=t(y);i&&m(e,i,n)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return s.then((function(){var e,t=F("logger");return(d=new he(""+(null===(e=f.connection.identity)||void 0===e?void 0:e.application),void 0,f.customLogger)).consoleLevel(f.logger.console),d.publishLevel(f.logger.publish),d.canPublish("debug")&&d.debug("initializing glue..."),m("logger",d,t),Promise.resolve(void 0)})).then((function(){var e=F("connection");a=new de(f.connection,d.subLogger("connection"));var t=Promise.resolve(f.auth);return f.connection&&!f.auth&&(n?t=n.getGWToken().then((function(e){return{gatewayToken:e}})):"undefined"!=typeof window&&(null===window||void 0===window?void 0:window.glue42electron)?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((function(t){var n;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return n=t,a.login(n)})).then((function(){return m("connection",a,e),f})).catch((function(e){throw a&&a.logout(),e}))})).then((function(){return Promise.all([(s=F("metrics"),c=f.metrics,h=null==n?void 0:n.getMetricsPublishingEnabled,l=f.connection.identity,p=h||function(){return!0},g=null!==(e="boolean"!=typeof c&&c.disableAutoAppSystem)&&void 0!==e&&e,m("metrics",u=P({connection:c?a:void 0,logger:d.subLogger("metrics"),canUpdateMetric:p,system:"Glue42",service:null!==(i=null!==(t=null==l?void 0:l.service)&&void 0!==t?t:null==n?void 0:n.applicationName)&&void 0!==i?i:f.application,instance:null!==(o=null!==(r=null==l?void 0:l.instance)&&void 0!==r?r:null==l?void 0:l.windowId)&&void 0!==o?o:ne(),disableAutoAppSystem:g,pagePerformanceMetrics:"boolean"!=typeof c?null==c?void 0:c.pagePerformanceMetrics:void 0}),s),Promise.resolve()),v(),w(),b()]);var e,t,i,r,o,s,c,h,l,p,g})).then((function(){return c.readyPromise})).then((function(){return function(){return i(this,void 0,void 0,(function(){var t,n,i;return r(this,(function(r){switch(r.label){case 0:if(t="T42.ACS.RegisterInstance",!W.isNode()||void 0!==process.env._GD_STARTING_CONTEXT_||void 0===(null==e?void 0:e.application))return[3,4];if(!(c.methods({name:t}).length>0))return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,c.invoke(t,{appName:null==e?void 0:e.application,pid:process.pid})];case 2:return r.sent(),[3,4];case 3:return n=r.sent(),i=n,d.error("Cannot register as an instance: "+JSON.stringify(i.message)),[3,4];case 4:return[2]}}))}))}()})).then((function(){return _(f.libs||[])})).then((function(){var e=Object.keys(y).map((function(e){var t=y[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){var i={coreVersion:Te,version:f.version};g.stop();var r={feedback:function(e){c&&c.invoke("T42.ACS.Feedback",e,"best")},info:i,logger:d,interop:c,agm:c,connection:a,metrics:u,contexts:h,bus:l,version:f.version,userConfig:e,done:function(){return null==d||d.info("done called by user..."),a.logout()}};if(r.performance={get glueVer(){return f.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var e=N;return Object.keys(e).map((function(t){var n=e[t];return{name:t,duration:n.endTime-n.startTime,marks:n.marks,startTime:n.startTime,endTime:n.endTime}}))}},Object.keys(y).forEach((function(e){var t=y[e];r[e]=t})),r.config={},Object.keys(f).forEach((function(e){r.config[e]=f[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((function(e){r.config[e]=null==t?void 0:t.extOptions[e]})),(null==t?void 0:t.enrichGlue)&&t.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r.agm){var o=function(e,t,n){return function(){return r.logger.warn("glue.js - 'glue.agm."+t+"' method is deprecated, use 'glue.interop."+n+"' instead."),e.apply(r.agm,arguments)}},s=r.agm;s.method_added=o(r.agm.methodAdded,"method_added","methodAdded"),s.method_removed=o(r.agm.methodRemoved,"method_removed","methodRemoved"),s.server_added=o(r.agm.serverAdded,"server_added","serverAdded"),s.server_method_aded=o(r.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),s.server_method_removed=o(r.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return r})).catch((function(e){return Promise.reject({err:e,libs:y})}))};"undefined"!=typeof window&&(window.GlueCore=gt),gt.version=Te,gt.default=gt;class ft{constructor(e){this._id=e}get id(){return this._id}_update(e){if(e._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(e)}_updateCore(e){}_beforeDelete(e){}}function yt(e){return"number"==typeof e}function mt(e){return"string"==typeof e}function vt(e){return"object"==typeof e&&null!==e}function wt(e){return Array.isArray?Array.isArray(e):"[object Array]"===toString.call(e)}function bt(e){return void 0===e}function _t(e){return null==e}function It(e){return"string"!=typeof e||!e||0===e.length||/^\s*$/.test(e)}function Ct(e){return!0===e||!1===e||"[object Boolean]"===toString.call(e)}function At(e){return!!(e&&e.constructor&&e.call&&e.apply)}function xt(e,t){void 0!==e&&t(e)}class Tt extends ft{constructor(e,t,n,i){super(e),this._name=e,this._description=i,this._ownerWindow=t,this._helperWindows=n||[]}get name(){return this._name}get description(){return this._description}get helperWindows(){return this._helperWindows.map((e=>this.covertToWindowDef(e)))}get ownerWindow(){return this.covertToWindowDef(this._ownerWindow)}initiate(e,t,n){return this._manager.initiate(this._name,e,t,n)}_updateCore(e){super._updateCore(e),xt(e._description,(e=>this._description=e)),xt(e._ownerWindow,(e=>this._ownerWindow=e)),xt(e._helperWindows,(e=>this._helperWindows=e))}covertToWindowDef(e){var t,n;return{type:null===(t=null==e?void 0:e.id)||void 0===t?void 0:t.type,name:null===(n=null==e?void 0:e.id)||void 0===n?void 0:n.name}}}class kt extends ft{constructor(e,t){super(e),this._name=e,this._appByWindowTypeGetter=t}get name(){return this._name}get config(){return this._appByWindowTypeGetter(this._name)}get windows(){return this._manager.getWindows({type:this._name})}create(e,t){const n=Object.assign({type:this.name,name:this.name,isIndependent:!1},t);return this._manager.createWindow(e,n)}}class St{constructor(e,t){this.entity=e,this.context=t}}class Pt{constructor(e){this.type=e}}class Mt extends Pt{constructor(e,t){super(Rt.StatusChange),this.newStatus=e,this.oldStatus=t}}class Et extends Pt{constructor(e,t,n){super(Rt.ActivityContextChange),this.context="string"==typeof e?JSON.parse(e):e,this.updated=t,this.removed=n}}class Rt{}Rt.Added="added",Rt.Removed="removed",Rt.Updated="updated",Rt.Closed="closed",Rt.StatusChange="statusChange",Rt.ActivityContextChange="activityContextUpdate",Rt.ActivityWindowEvent="activityWindowEvent",Rt.ActivityWindowJoinedActivity="joined",Rt.ActivityWindowLeftActivity="left";class jt{}jt.Created="created",jt.Started="started",jt.Destroyed="destroyed";class Wt{constructor(e){this._activity=e}register(e,t){this._ensureHasAgm(),Wt.AGM.register(e,t)}servers(){return this._ensureHasAgm(),_t(this._activity)?[]:this._activity.windows.map((e=>e.instance))}methods(){if(this._ensureHasAgm(),_t(this._activity))return[];const e=this._activity.windows,t=[],n=[];return e.forEach((e=>{this.methodsForWindow(e).forEach((e=>{-1===t.indexOf(e.name)&&(t.push(e.name),n.push(e))}))})),n}methodsForWindow(e){return this._ensureHasAgm(),e.instance?Wt.AGM.methodsForInstance(e.instance):[]}invoke(e,t,n,i,r,o){this._ensureHasAgm();const s=this.servers();if(_t(n)&&(n="activity.all"),mt(n))if("activity.all"===n);else{if("activity.best"!==n){if("all"===n||"best"===n)return function(e,t,n){if("function"!=typeof t&&"function"!=typeof n)return e;"function"!=typeof t?t=()=>{}:"function"!=typeof n&&(n=()=>{}),e.then(t,n)}(Wt.AGM.invoke(e,t,n,i),r,o);throw new Error("Invalid invoke target "+n)}{const t=s.filter((t=>Wt.AGM.methodsForInstance(t).filter((t=>t.name===e)).length>0));t.length>0&&t[0]}}else if(wt(n)){if(n.length>=0){const e=n[0];if(this._isInstance(e))n.map((e=>e));else{if(!this._isActivityWindow(e))throw new Error("Unknown target object");n.map((e=>e.instance))}}}else if(this._isInstance(n));else{if(!this._isActivityWindow(n))throw new Error("Unknown target object");n.instance}throw new Error("Not implemented")}unregister(e){return this._ensureHasAgm(),Wt.AGM.unregister(e)}createStream(e,t,n){this._ensureHasAgm(),Wt.AGM.createStream(e,{subscriptionAddedHandler:t,subscriptionRemovedHandler:n,subscriptionRequestHandler:void 0})}subscribe(e,t,n){return this._ensureHasAgm(),Wt.AGM.subscribe(e,t)}_ensureHasAgm(){if(_t(Wt.AGM))throw new Error("Agm should be configured to be used in activity")}_isInstance(e){return void 0!==e.application}_isActivityWindow(e){return void 0!==e.instance}}class Ot{constructor(e,t,n){this._manager=e,this._ownerActivityId=t,this._state=n}get ownerId(){return this._state.ownerId}get windowIds(){return this._state.windowIds}get frameColor(){return this._state.frameColor}get context(){return this._state.context}get tag(){return this._state.tag}detach(e){e=e||{};const t={};return Object.keys(this._state).forEach((e=>{t[e]=this._state[e]})),t.context=e.context||t.context,t.frameColor=e.frameColor||t.frameColor,this._manager.detachActivities(this._ownerActivityId,t)}}const Nt=e=>{setTimeout(e,0)};function Ft(e,t){if(!At(t))return e;e.then((e=>{Nt((()=>{t(null,e)}))}),(e=>{Nt((()=>{t(e,null)}))}))}class Lt extends ft{constructor(e,t,n,i,r){super(e),this._id=e,this._actType=t,this._status=n,this._context=i,this._ownerId=r,this._agm=new Wt(this)}get type(){if(this._manager)return this._manager.getActivityType(this._actType)}get context(){return this._context}get status(){return this._status}get owner(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null}get windows(){return this._manager.getWindows({activityId:this._id})}get agm(){return this._agm}addWindow(e,t){return this._manager.addWindowToActivity(this,e,t)}createWindow(e,t){return this._manager.createWindow(this,e,t)}createStackedWindows(e,t,n){return this._manager.createStackedWindows(this,e,t,n)}leave(e,t){return this._manager.leaveWindowFromActivity(this,e,t)}getWindowsByType(e){const t={activityId:this._id,type:e};return this._manager.getWindows(t)}setContext(e,t){return this._manager.setActivityContext(this,e,t)}updateContext(e,t){return this._manager.updateActivityContext(this,e,t)}onStatusChange(e){return this._manager.subscribeActivityEvents(((t,n,i)=>{t.id===this.id&&e(t,n,i)}))}onWindowEvent(e){return this._manager.subscribeWindowEvents(((t,n,i)=>{t.id===this.id&&e(t,n,i)}))}onContextChanged(e){this._manager.subscribeActivityContextChanged(((t,n,i,r)=>{t.id===this.id&&e(n,i,r,t)}));try{e(this.context,this.context,[],this)}catch(e){return}}stop(){this._manager.stopActivity(this)}clone(e){return this._manager.clone(this,e)}attach(e,t){let n;return n="string"==typeof e?e:e.id,this._manager.attachActivities(n,this.id,t)}onActivityAttached(e){this._manager.subscribeActivitiesAttached(((t,n,i)=>{t===this._id&&e(i)}))}onDetached(e){this._manager.subscribeActivitiesDetached(((t,n,i)=>{n.id===this._id&&e(t,i)}))}_updateCore(e){super._updateCore(e),xt(e._actType,(e=>this._actType=e)),xt(e._context,(e=>this._context=e)),xt(e._ownerId,(e=>this._ownerId=e)),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)}_updateDescriptors(e){this._attached=e.map((e=>new Ot(this._manager,this._id,e)))}get attached(){return this._attached}setFrameColor(e,t){return Ft(new Promise(((t,n)=>{let i=this.windows.length;0===i&&t(this),this.windows.forEach((n=>{n.underlyingWindow.setFrameColor(e,(()=>{i--,i<=0&&t(this)}))})),setTimeout((()=>{i>0&&n(this.id+" - timed out waiting for setFrameColor with"+e)}),5e3)})),t)}getFrameColor(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""}}class Dt{}Dt.Trace="trace",Dt.Debug="debug",Dt.Info="info",Dt.Warn="warn",Dt.Error="error";class Gt{constructor(e){this._name=e,_t(Gt.GlueLogger)||(this._glueLogger=Gt.GlueLogger.subLogger(e))}static GetNamed(e){return new Gt(e)}static Get(e){return new Gt(Gt.GetTypeName(e))}trace(e){_t(this._glueLogger)?Gt.Level===Dt.Trace&&console.info(this._getMessage(e,Dt.Trace)):this._glueLogger.trace(e)}debug(e){_t(this._glueLogger)?Gt.Level!==Dt.Debug&&Gt.Level!==Dt.Trace||console.info(this._getMessage(e,Dt.Debug)):this._glueLogger.debug(e)}info(e){_t(this._glueLogger)?Gt.Level!==Dt.Debug&&Gt.Level!==Dt.Trace&&Gt.Level!==Dt.Info||console.info(this._getMessage(e,Dt.Info)):this._glueLogger.info(e)}warn(e){_t(this._glueLogger)?Gt.Level!==Dt.Debug&&Gt.Level!==Dt.Trace&&Gt.Level!==Dt.Info&&Gt.Level!==Dt.Warn||console.info(this._getMessage(e,Dt.Info)):this._glueLogger.warn(e)}error(e){_t(this._glueLogger)?(console.error(this._getMessage(e,Dt.Error)),console.trace()):this._glueLogger.error(e)}_getMessage(e,t){return"["+t+"] "+this._name+" - "+e}static GetTypeName(e){const t=/function (.{1,})\(/.exec(e.constructor.toString());return t&&t.length>1?t[1]:""}}Gt.Level=Dt.Info;class Bt extends ft{constructor(e,t,n,i,r,o,s,a){super(e),this._logger=Gt.Get("window"),this._type=n,this._activityId=i,this._name=t,this._instance=r,this._isIndependent=o,this._windowGetter=s,this._hcWindowId=a}getBounds(){return this._manager.getWindowBounds(this.id)}get name(){return this._name}get isIndependent(){return this._isIndependent}get type(){if(this._manager)return this._manager.getWindowType(this._type)}get activity(){if(!bt(this._activityId))return this._manager.getActivityById(this._activityId)}get isOwner(){const e=this.activity;return!bt(e)&&e.owner.id===this.id}setVisible(e,t){return this._manager.setWindowVisibility(this.id,e)}activate(e){return this._manager.activateWindow(this.id,e)}setBounds(e,t){return this._manager.setWindowBounds(this.id,e,t)}close(){return this._manager.closeWindow(this.id)}get instance(){return this._instance}get underlyingWindow(){const e=this._windowGetter();return e||{id:this._hcWindowId}}onActivityJoined(e){this._subscribeForActivityWindowEvent(Rt.ActivityWindowJoinedActivity,e)}onActivityRemoved(e){this._subscribeForActivityWindowEvent(Rt.ActivityWindowLeftActivity,e)}_updateCore(e){xt(e._activityId,(e=>this._activityId=e)),xt(e._isIndependent,(e=>this._isIndependent=e)),xt(e._hcWindowId,(e=>this._hcWindowId=e)),xt(e._type,(e=>this._type=e)),xt(e._name,(e=>this._name=e)),_t(e._instance)||(this._instance=e._instance)}_subscribeForActivityWindowEvent(e,t){this._manager.subscribeWindowEvents(((n,i,r)=>{i.id===this.id&&r===e&&t(n)}))}_beforeDelete(e){this._hcWindowId=e._hcWindowId}}class qt{constructor(e,t,n){this.state=e,this.message=t,this.time=n}getState(){return this.state}getMessage(){return this.message}getTime(){return this.time}}const Ht="error",Ut="add-types",Vt="created",Jt="destroyed",zt="initiated",$t="joined",Kt="activity-joined",Qt="left",Zt="owner-changed",Xt="add-peer-factories",Yt="peer-factories-added",en="peer-factories-removed",tn="peer-created";class nn{constructor(e){if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=e,this._connection=e.connection,this._logger=e.logger,this._contexts=e.contexts,this._windows=e.windows,this._sessionJoinedPromise=new Promise((e=>{this._sessionJoinedPromiseResolve=e})),this._activityJoinedPromise=new Promise((e=>{this._activityJoinedPromiseResolve=e})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=this._connection.domain("activity",["joined","initiated","peer-created","token"]),"undefined"!=typeof window){const e=window.glue42gd;e&&e.activityInfo&&("function"==typeof e.addRefreshHandler&&e.addRefreshHandler(((t,n)=>{this._gw3Session.send({type:"reload"}).then((i=>{if(i.token){try{e.setGWToken(i.token)}catch(e){return void n(e.message||e)}t()}else n("Expected gateway token for refreshing.")}),n)})),e&&"function"==typeof e.addWillNavigateHandler&&e.addWillNavigateHandler(((t,n)=>{this._gw3Session.send({type:"reload"}).then((i=>{if(i.token){try{e.setGWToken(i.token)}catch(e){return void n(e.message||e)}t()}else n("Expected gateway token for refreshing.")}),n)})))}}static activityTypeGwMessageEntityToActivityType(e,t){const n=e=>new kt(e,void 0);return new Tt(e.name,e.owner_type&&n(e.owner_type),e.helper_types&&e.helper_types.map(n),t)}static peerFactoryGwMessageEntityToWindowType(e){return new kt(e.peer_type,(e=>{}))}static activityGwMessageToActivity(e,t){const n=void 0!==e.owner?e.owner.peer_id:e.owner_id;return new Lt(e.activity_id,e.activity_type,t,e.context_snapshot,n)}static activityToActivityStatusChangeEvent(e){return new St(e,new Mt(e.status,void 0))}get bridgeType(){return"GW3"}init(){this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe(Vt,this.handleActivityCreatedMessage),this.subscribe(Jt,this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe(Yt,this.handlePeerFactoriesAdded),this.subscribe(en,this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(()=>{if("dispose"!==this._config.disposeRequestHandling){if("exit"===this._config.disposeRequestHandling){if(this._windows&&void 0!==this._windows.my())return void this._windows.my().close();if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else this.dispose()})),this._gw3Session.onJoined((()=>{"trackMyOnly"===this._config.mode||"trackMyTypeAndInitiatedFromMe"===this._config.mode?this._sessionJoinedPromiseResolve(this):this._gw3Session.send({type:"subscribe",activity_types:"trackAll"===this._config.mode?[]:"trackTypes"===this._config.mode?this._config.typesToTrack:[]}).then((()=>{this._sessionJoinedPromiseResolve(this)}))})),this._gw3Session.join()}dispose(){this._gw3Subscriptions.forEach((e=>e&&this._connection.off(e))),this._gw3Subscriptions.length=0}ready(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])}initReady(){return this._sessionJoinedPromise}onActivityTypeStatusChange(e){this._activityTypeStatusChangeCallbacks.push(e)}registerActivityType(e,t,n,i,r){const o={};o.name=e;const s=e=>({type:e.type,name:e.name,configuration:e});return o.owner_type=s(t),o.helper_types=n.map(s),this._gw3Session.send({type:Ut,types:[o]}).then((()=>{const e=nn.activityTypeGwMessageEntityToActivityType(o,r);return this.invokeCallbacks(this._activityTypeStatusChangeCallbacks,new St(e,new Pt(Rt.Added)),Ut),e}))}unregisterActivityType(e){return this._gw3Session.send({type:"remove-types",types:[e]}).then((()=>{const t=new Tt(e,void 0,void 0,void 0);this.invokeCallbacks(this._activityTypeStatusChangeCallbacks,new St(t,new Pt(Rt.Removed)),Ut)}))}onWindowTypeStatusChange(e){this._windowTypeStatusChangeCallbacks.push(e)}registerWindowFactory(e,t,n){if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error(`Factory for windowType ${e} already registered.`));this._peerFactoriesRegisteredByUs[e]=t;const i={id:e,peer_type:e,configuration:n};return this._gw3Session.send({type:Xt,factories:[i]}).then((()=>{this.invokeCallbacks(this._windowTypeStatusChangeCallbacks,new St(nn.peerFactoryGwMessageEntityToWindowType(i),new Pt(Rt.Added)),Xt)})).catch((()=>{delete this._peerFactoriesRegisteredByUs[e]}))}unregisterWindowFactory(e){return this._peerFactoriesRegisteredByUs[e]?(delete this._peerFactoriesRegisteredByUs[e],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[e]}).then((()=>{this.invokeCallbacks(this._windowTypeStatusChangeCallbacks,new St(new kt(e,void 0),new Pt(Rt.Removed)),Xt)}))):Promise.reject(new Error(`Factory for windowType ${e} not registered.`))}onActivityStatusChange(e){this._activityChangeCallbacks.push(e)}initiateActivity(e,t,n){const i={type:"create",activity_type:e,initial_context:t};return this.isOverrideTypeDefinition(n)?i.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((e=>({type:e.type,name:e.name,configuration:e})))}:i.configuration=n&&n.map((e=>({type:e.type,name:e.name,configuration:e}))),this.sendCreateAndMapResultingMessagesToPromise(i,zt,((e,t)=>e.request_id===t),Vt,((e,t,n)=>e.activity_id===n.activity_id),Jt,((e,t,n)=>e.activity_id===n.activity_id),(e=>e.activity_id),null).then((t=>"trackMyTypeAndInitiatedFromMe"!==this._config.mode||this._activityTypesInitiatedFromMe[e]?t:(this._activityTypesInitiatedFromMe[e]=!0,this._gw3Session.send({type:"subscribe",activity_types:[e]}).then((()=>t)))))}stopActivity(e){return this._gw3Session.send({type:"destroy",activity_id:e.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((e=>!0))}updateActivityContext(e,t,n,i){if(n)return this._contexts.set(e.id,t);i=i||[];for(const e of i)t[e]=null;return this._contexts.update(e.id,t)}announceWindow(e,t){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")}registerWindow(e,t,n){let i=void 0!==this._connection.gatewayToken;const r=this._connection.peerId;if("undefined"!=typeof window){const e=window.glue42gd;e&&(i=void 0!==e.activityInfo)}return i&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new St(new Bt(r,t,e,void 0,this.getAgmInstance(r),n,this.generateWindowGetter(r),void 0),new Pt(Rt.Added)),"register window"),Promise.resolve(r)}onActivityWindowChange(e){this._activityWindowChangeCallbacks.push(e)}createWindow(e,t){t.layout||(t.left||t.width||t.height||t.top)&&(t.layout={mode:"pixels",cellSize:1});const n=n=>{if(e)return this.joinActivity(e,n,t.name).then((()=>n))};return this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:t.type,peer_name:t.name||t.type,configuration:t,activity_id:e},void 0,void 0,tn,((e,t)=>e.request_id===t),void 0,void 0,(e=>e.created_id),n).then(n)}closeWindow(e){return this._gw3Session.send({type:"destroy-peer",destroy_peer_id:e}).then((e=>{}))}getAnnouncementInfo(){let e=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,t=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,i=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){const r=new URLSearchParams(location.search.slice(1));t=t||r.get("t42PeerType"),t=t||r.get("t42ActivityWindowType"),void 0===n&&(n=r.get("t42ActivityWindowIndependent")),i=i||r.get("t42ActivityWindowName"),e=e||r.get("t42ActivityId")}return t=t||"unknown",n=n||!1,i=i||this._connection.peerId,{activityWindowId:void 0,activityId:e,activityWindowType:t,activityWindowIndependent:n,activityWindowName:i}}joinActivity(e,t,n){const i=n&&{name:n}||{};return this._gw3Session.send({type:"join-activity",target_id:t,activity_id:e,...i}).then((()=>{this.invokeCallbacks(this._activityWindowChangeCallbacks,new St(new Bt(t,void 0,void 0,e,this.getAgmInstance(t),void 0,this.generateWindowGetter(t),void 0),new Pt(Rt.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),this.invokeCallbacks(this._activityChangeCallbacks,new St(new Lt(e,void 0,new qt("created",void 0,void 0),void 0,void 0),new Pt(Rt.Updated)),"activity joined - Activity")}))}leaveActivity(e,t){return this._gw3Session.send({type:"leave-activity",target_id:t,activity_id:e}).then((()=>{this.invokeCallbacks(this._activityWindowChangeCallbacks,new St(new Bt(t,void 0,void 0,null,this.getAgmInstance(t),void 0,this.generateWindowGetter(t),void 0),new Pt(Rt.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),this.invokeCallbacks(this._activityChangeCallbacks,new St(new Lt(e,void 0,new qt("created",void 0,void 0),void 0,void 0),new Pt(Rt.Updated)),"activity left - Activity")}))}getActivityTypes(){return Promise.resolve([])}getWindowTypes(){return Promise.resolve([])}getActivities(){return Promise.resolve([])}getActivityWindows(){return Promise.resolve([])}createStackedWindows(e,t,n){}getWindowBounds(e){}setWindowBounds(e,t){}activateWindow(e,t){}setWindowVisibility(e,t){}cloneActivity(e,t){}attachActivities(e,t,n){return this._gw3Session.send({type:"merge",into:t,merge:e})}detachActivities(e,t){return this._gw3Session.send({type:"split",from:e}).then((()=>""))}onActivitiesAttached(e){}onActivitiesDetached(e){}onActivityAttachedDescriptorsRefreshed(e){}getAttachedDescriptors(){return Promise.resolve([])}getRandomRequestId(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())}forwardAddedAndRemovedMessagesToEventHandler(e,t,n,i){const r=e=>t=>new St(t,new Pt(e?Rt.Added:Rt.Removed));let o,s;return o=e&&this.forwardMessageToEventHandler(e,(e=>n(e,!0)),r(!0),i),s=t&&this.forwardMessageToEventHandler(t,(e=>n(e,!1)),r(!1),i),[o,s].filter((e=>e))}forwardMessageToEventHandler(e,t,n,i){return this.subscribe(e,(e=>{t(e).forEach((t=>i.forEach((i=>i(n(t,e))))))}))}sendCreateAndMapResultingMessagesToPromise(e,t,n,i,r,o,s,a,c){const d=this.getRandomRequestId();let u,h;const l=new Promise(((e,t)=>{u=e,h=t}));let p,g,f,y,m=null;const v=()=>{this.dropSubscription(p),c||this.dropSubscription(g),this.dropSubscription(f),this.dropSubscription(y)};p=t&&this.subscribe(t,(e=>{n(e,d)&&(m=e,this.dropSubscription(p))}));let w=!1;g=this.subscribe(i,(e=>{r(e,d,m)&&(w?c&&c(a(e)):(w=!0,u(a(e))))})),f=o&&this.subscribe(o,(e=>{s(e,d,m)&&h(e)})),y=o&&this.subscribe(Ht,(e=>{e.request_id===d&&h(e)})),e.request_id=d;const b=this._gw3Session.send(e).then((()=>l));return b.then(v,v),b}peerFactoryIdAndOwnerIdToWindowType(e,t){const n=this._peerIdAndFactoryIdToPeerType[t+":"+e];return n?new kt(n,void 0):null}subscribe(e,t){const n=this._connection.on(e,(e=>t.bind(this)(e)));return this._gw3Subscriptions.push(n),n}dropSubscription(e){e&&(this._connection.off(e),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(e)])}invokeCallbacks(e,t,n){e.forEach((e=>{try{e(t)}catch(e){this._logger.error(`Error in ${n||t.context.type} callback: `+JSON.stringify(e))}}))}handleActivityCreatedMessage(e){e.context_id?this._contextSubscriptions[e.activity_id]||this.subscribeToContext(e):this._logger.error("Activity created with unknown context_id: "+e.activity_id)}async subscribeToContext(e){const t=e.activity_id;this._contextSubscriptions[t]=await this._contexts.subscribe(t,((e,n,i)=>{const r=new St(new Lt(t,void 0,void 0,e,void 0),new Et(e,n,i));this.invokeCallbacks(this._activityChangeCallbacks,r,"context updated")}))}handleActivityDestroyedMessage(e){const t=this._contextSubscriptions[e.activity_id];"function"==typeof t&&t(),delete this._contextSubscriptions[e.activity_id]}handlePeerFactoriesAdded(e){e.factories.forEach((t=>{this._peerIdAndFactoryIdToPeerType[e.owner_id+":"+t.id]=t.peer_type}))}handlePeerFactoriesRemoved(e){e.factory_ids.forEach((t=>{delete this._peerIdAndFactoryIdToPeerType[e.owner_id+":"+t]}))}forwardActivityTypeMessagesToStatusEventHandlers(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",((e,t)=>t?e.types.map((e=>nn.activityTypeGwMessageEntityToActivityType(e,void 0))):e.types.map((e=>new Tt(e.name,void 0,void 0,void 0)))),this._activityTypeStatusChangeCallbacks)}forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(){for(const e of[Vt,$t,Zt])this.forwardMessageToEventHandler(e,(e=>[e.owner||{...e,type:e.peer_type,name:e.peer_name,peer_id:e.owner_id}].concat(e.participants||[]).map((t=>new Bt(t.peer_id,t.name,t.type,e.activity_id,this.getAgmInstance(t.peer_id),void 0,this.generateWindowGetter(t.peer_id),void 0)))),((e,t)=>new St(e,new Pt(Rt.ActivityWindowJoinedActivity))),this._activityWindowChangeCallbacks)}forwardActivityMessagesToStatusEventHandlers(){for(const e of[Vt,$t])this.forwardMessageToEventHandler(e,(e=>[nn.activityGwMessageToActivity(e,new qt("started","",new Date))]),((e,t)=>nn.activityToActivityStatusChangeEvent(e)),this._activityChangeCallbacks);this.forwardMessageToEventHandler(Jt,(e=>[nn.activityGwMessageToActivity(e,new qt("destroyed",e.reason,new Date))]),((e,t)=>nn.activityToActivityStatusChangeEvent(e)),this._activityChangeCallbacks),this.forwardMessageToEventHandler(zt,(e=>[nn.activityGwMessageToActivity(e,new qt("created","",new Date))]),((e,t)=>nn.activityToActivityStatusChangeEvent(e)),this._activityChangeCallbacks),this.forwardMessageToEventHandler(Zt,(e=>[nn.activityGwMessageToActivity(e,new qt("created","",new Date))]),((e,t)=>nn.activityToActivityStatusChangeEvent(e)),this._activityChangeCallbacks)}forwardPeerFactoryMessagesToStatusEventHandlers(){this.forwardAddedAndRemovedMessagesToEventHandler(Yt,en,((e,t)=>t?e.factories.map(nn.peerFactoryGwMessageEntityToWindowType):e.factory_ids.map((t=>this.peerFactoryIdAndOwnerIdToWindowType(t,e.owner_id))).filter((e=>null!=e))),this._windowTypeStatusChangeCallbacks)}forwardPeerFactoryMessagesToPeerFactoryRequests(){this.subscribe("peer-requested",(e=>{const t=this._peerFactoriesRegisteredByUs[e.peer_factory];if(t)try{const n=e.configuration||{};n.gateway_token=n.gateway_token||e.gateway_token,n.peer_factory=n.peer_factory||e.peer_factory;const i=t({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:n.gateway_token,configuration:n});i&&i.then&&i.catch&&i.catch((t=>this._gw3Session.send({type:Ht,request_id:e.request_id,reason:t&&(t.message||JSON.stringify(t))})))}catch(t){this._gw3Session.send({type:Ht,request_id:e.request_id,reason:t&&(t.message||JSON.stringify(t))})}else this._gw3Session.send({type:Ht,request_id:e.request_id,reason:`Unknown peer factory ${e.peer_factory}`})}))}forwardActivityWindowMessagesToEventHandlers(){for(const e of[Kt,$t])this.subscribe(e,(t=>{const n=e===Kt?t.joined_id:t.peer_id,i=e===Kt?t.joined_type:t.peer_type,r=e===Kt?t.joined_name:t.peer_name,o=new Bt(n,r,i,t.activity_id,this.getAgmInstance(n),void 0,this.generateWindowGetter(n),void 0);this._contextSubscriptions[t.activity_id]?e===$t&&this._activityJoinedPromiseResolve({}):this.subscribeToContext(t).then((()=>{e===$t&&this._activityJoinedPromiseResolve({})})),this.invokeCallbacks(this._activityWindowChangeCallbacks,new St(o,new Pt(Rt.ActivityWindowJoinedActivity)),e)}));this.subscribe(Qt,(e=>{const t=new Bt(e.left_id,void 0,void 0,null,this.getAgmInstance(e.left_id),void 0,this.generateWindowGetter(e.left_id),void 0);this.invokeCallbacks(this._activityWindowChangeCallbacks,new St(t,new Pt(Rt.ActivityWindowLeftActivity)),Qt)})),this.forwardAddedAndRemovedMessagesToEventHandler(tn,void 0,(e=>[new Bt(e.created_id,void 0,void 0,void 0,void 0,void 0,this.generateWindowGetter(e.created_id),void 0)]),this._activityWindowChangeCallbacks)}getAgmInstance(e){return this._config.agm.servers().find((t=>t.peerId===e||t.windowId===e))}generateWindowGetter(e){return()=>{const t=this.getAgmInstance(e);if(!t)return;const n=t.windowId;return this._config.windows.list().filter((e=>e.id===n))[0]}}isOverrideTypeDefinition(e){return void 0!==e&&!!e.owner}}class rn{constructor(e,t){this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=Gt.Get(this),this._m=e,e.ready().then((e=>{e.subscribeActivityContextChanged(this._subscribeMyContextChanged.bind(this)),e.subscribeWindowEvents(this._subscribeMyWindowEvent.bind(this)),e.subscribeActivitiesAttached(this._subscribeActivitiesAttached.bind(this)),e.subscribeActivitiesDetached(this._subscribeActivitiesDetached.bind(this)),t&&t.onWindowFrameColorChanged(this._subscribeWindowFrameColorChanged.bind(this))}))}get window(){if(_t(this._w)){const e=this._m.announcedWindows;e.length>0&&(this._w=e[0])}return this._w}get activity(){const e=this.window;if(!_t(e))return e.activity}createWindow(e){return this._m.createWindow(this.activity,e)}createStackedWindows(e,t){return this._m.createStackedWindows(this.activity,e,t)}get context(){const e=this.activity;return bt(e)?{}:e.context}updateContext(e,t){const n=this.activity;return bt(n)?new Promise(((e,t)=>{t("Not in activity")})):n.updateContext(e,t)}setContext(e,t){const n=this.activity;return bt(n)?new Promise(((e,t)=>{t("Not in activity")})):n.setContext(e,t)}onActivityJoined(e){this._myActivityJoinedCallbacks.push(e);const t=this.window;_t(t)||_t(t.activity)||e(t.activity)}onActivityLeft(e){this._myActivityRemovedCallbacks.push(e)}onContextChanged(e){this._myContextUpdateCallbacks.push(e);const t=this.window;if(_t(t))return;const n=t.activity;_t(n)||e(n.context,n.context,[],n)}clone(e,t){const n=this.activity;return this._m.clone(n,e,t)}attach(e,t){let n;return n="string"==typeof e?e:e.id,this._m.attachActivities(n,this.activity.id,t)}onActivityAttached(e){this._myAttached.push(e)}onActivityDetached(e){this._myDetached.push(e)}onAttachedToActivity(e){this._myAttachedTo.push(e)}onDetachedFromActivity(e){this._myDetachedFrom.push(e)}get attached(){return this.activity?this.activity.attached:[]}setFrameColor(e,t){return this.activity?this.activity.setFrameColor(e,t):Promise.resolve(null)}getFrameColor(){return this.activity?this.activity.getFrameColor():""}onFrameColorChanged(e){this._myActivityFrameColorChanged.push(e)}_subscribeMyContextChanged(e,t,n,i){const r=this.window;if(_t(r))return;const o=r.activity;_t(o)||e.id===o.id&&this._notifyMyContextChanged(e,t,n,i)}_subscribeMyWindowEvent(e,t,n){_t(this.window)||this.window.id===t.id&&(n===Rt.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(e,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(e,e.context,null,null)):n===Rt.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(e,this._myActivityRemovedCallbacks))}_notifyMyWindowEvent(e,t){t.forEach((t=>{try{t(e,event)}catch(e){this._logger.warn("error in user callback "+e)}}))}_notifyMyContextChanged(e,t,n,i){n=n||{},i=i||[],this._myContextUpdateCallbacks.forEach((r=>{try{r(t,n,i,e)}catch(e){this._logger.warn("error in user callback "+e)}}))}_notifyAttached(e){this._myAttached.forEach((t=>{try{t(e)}catch(e){this._logger.warn("error in user callback "+e)}}))}_notifyDetached(e){this._myDetached.forEach((t=>{try{t(e)}catch(e){this._logger.warn("error in user callback "+e)}}))}_notifyAttachedTo(e){this._myAttachedTo.forEach((t=>{try{t(this.activity,e)}catch(e){this._logger.warn("error in user callback "+e)}}))}_notifyDetachedFrom(e,t,n){this._myDetachedFrom.forEach((i=>{try{i(e,t,n)}catch(e){this._logger.warn("error in user callback "+e)}}))}_subscribeActivitiesAttached(e,t){const n=this.window;if(_t(n))return;const i=n.activity;_t(i)||e.id===i.id&&(t.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(t):this._notifyAttached(t))}_subscribeActivitiesDetached(e,t,n){const i=this.window;if(_t(i))return;const r=i.activity;_t(r)||(t.id===r.id&&this._notifyDetached(n),e.id===r.id&&this._notifyDetachedFrom(e,t,n))}_subscribeWindowFrameColorChanged(e){const t=this.activity;t&&t.owner&&t.owner.underlyingWindow.id===e.id&&this._myActivityFrameColorChanged.forEach((t=>{t(e.frameColor)}))}}class on{constructor(e,t){if(this._logger=Gt.Get("ReadyMarker ["+e+"]"),this._logger.debug("Initializing ready marker for '"+e+"' with "+t+" signals to wait"),t<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=t,this._callbacks=[],this._name=e}setCallback(e){this.isSet()?e(void 0):this.isError()?e(this._error):this._callbacks.push(e)}signal(e){if(this._logger.debug("Signaled - "+e+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((e=>{e(void 0)}))}error(e){this._error=e,this._callbacks.forEach((t=>{t(e)}))}isSet(){return!this.isError()&&0===this._signals}isError(){return!bt(this._error)}getError(){return this._error}}class sn{constructor(e){this._items={},this._listeners=[],this._processNew=e}addOne(e){this.add([e])}add(e){e.forEach((e=>{this.process(new St(e,new Pt(Rt.Added)))}))}process(e){const t=e.context,n=t.type,i=e.entity;if(n===Rt.StatusChange&&!t.oldStatus){const e=this._items[i.id];e&&(t.oldStatus=e.status)}n===Rt.StatusChange&&t.oldStatus&&t.newStatus&&t.oldStatus.state===t.newStatus.state&&(t.type=Rt.Updated),"undefined"==typeof htmlContainer&&(n===Rt.ActivityWindowJoinedActivity&&this._items[i.id]&&this._items[i.id].activity&&(t.type=Rt.Updated),n===Rt.ActivityWindowLeftActivity&&this._items[i.id]&&!this._items[i.id].activity&&(t.type=Rt.Updated));const r=this._updateInternalCollections(i,n,t);return this._notifyListeners(r,t),r}get(){const e=[];for(const t in this._items)if(this._items.hasOwnProperty(t)){const n=this._items[t];e.push(n)}return e}getByName(e){for(const t in this._items)if(t===e)return this._items[t]}getOrWait(e){return new Promise((t=>{const n=i=>{i.id===e&&(t(i),this.unsubscribe(n))};this.subscribe(n);const i=this.getByName(e);if(i)return this.unsubscribe(n),void t(i)}))}subscribe(e){return this._listeners.push(e),Object.keys(this._items).forEach((t=>{const n=this._items[t];e(n,new Pt(Rt.Added.toString()))})),()=>{this.unsubscribe(e)}}unsubscribe(e){const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}_notifyListeners(e,t){this._listeners.forEach((n=>{try{n(e,t)}catch(e){return}}))}_updateInternalCollections(e,t,n){const i=e,r=t===Rt.StatusChange&&i.status&&i.status.state===jt.Destroyed||t===Rt.StatusChange&&n&&n.newStatus&&n.newStatus.state===jt.Destroyed,o=t===Rt.Closed;if(t===Rt.Removed&&void 0===i.isIndependent||o||r){const t=this._items[e.id];return delete this._items[e.id],this._processNew(e),t&&e._beforeDelete(t),e}{const t=e.id;this._items.hasOwnProperty(t)?this._items[e.id]._update(e):(this._processNew(e),this._items[e.id]=e)}return this._items[e.id]}}class an{constructor(e,t,n){this._logger=Gt.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=e,this._activityTypes=new sn((e=>this._grabEntity(e))),this._windowTypes=new sn((e=>this._grabEntity(e))),this._activities=new sn((e=>this._grabEntity(e))),this._windows=new sn((e=>this._grabEntity(e))),this._dataReadyMarker=new on("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new on("Attached Activities Descriptors",["GetDescriptors"].length),t?(this._readyMarker=new on("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((e=>{e&&this._readyMarker.error(e),this._descriptorsMarker.setCallback((e=>{e&&this._readyMarker.error(e),this._logger.debug("Auto announcing window"),this.announceWindow().then((e=>{this._announcedWindows.push(e),this._readyMarker.signal("Successfully announced window with id '"+e.id+"'")})).catch((e=>{this._logger.debug("Will not announce window - "+e),this._readyMarker.signal()}))})),this.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((e=>{this._handleActivitiesAttached(e)})),this._bridge.onActivitiesDetached((e=>{this._handleActivitiesDetached(e)})),this._bridge.onActivityAttachedDescriptorsRefreshed((e=>{this._handleActivityDescriptorsRefreshed(e)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((e=>{this._getInitialData()})).catch((e=>{console.log(e)}))}get usingHc(){return"HC"===this._bridge.bridgeType}get announcedWindows(){return this._announcedWindows}set announcedWindows(e){throw new Error("not allowed")}ready(e){const t=new Promise(((e,t)=>{this._readyMarker.setCallback((n=>{n?t(this._readyMarker.getError()):e(this)}))}));return Ft(Promise.all([this._bridge.ready(),t]).then((()=>this)),e)}getActivityTypes(){return this._activityTypes.get()}getActivityType(e){return this._activityTypes.getByName(e)}registerActivityType(e,t,n,i,r,o){return Ft(new Promise(((o,s)=>{if(_t(e))return void s("activityTypeName argument can not be undefined");if(!mt(e))return void s("activityTypeName should be string");if(!_t(this.getActivityType(e)))return void s("Activity type '"+e+"' already exists");let a;if(bt(t))return void s("Owner window type can not be undefined");a=mt(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t;const c=[];if(!bt(n)&&wt(n))for(const e in n){const t=n[e];if(mt(t)){const e={type:t,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};c.push(e)}else c.push(t)}this._bridge.registerActivityType(e,a,c,i,r).then((e=>{this._grabEntity(e),o(e)})).catch((e=>{s(e)}))})),o)}unregisterActivityType(e,t){return Ft(new Promise(((t,n)=>{const i=this.getActivityType(e);bt(i)?n("Activity type '"+e+"' does not exists"):this._bridge.unregisterActivityType(e).then((()=>t(i)),n)})),t)}initiate(e,t,n,i){return Ft(new Promise(((n,r)=>{bt(this.getActivityType(e))?r("Activity type '"+e+"' does not exists"):this._bridge.initiateActivity(e,t,i).then((e=>{this._activities.getOrWait(e).then((e=>{n(e)})).catch((e=>r(e)))})).catch((e=>{r(e)}))})),n)}subscribeActivityTypeEvents(e){this._activityTypes.subscribe(((t,n)=>{e(t,n.type)}))}getWindowTypes(){return this._windowTypes.get()}getWindowType(e){return this._windowTypes.getByName(e)}registerWindowFactory(e,t,n){return Ft(new Promise(((n,i)=>{if(_t(e))i("no windowType specified");else{if(vt(e))e=e.getName();else if(!mt(e))return void i("windowType should be string or object that has getName method");this._bridge.registerWindowFactory(e,t).then((e=>{n(e)})).catch((e=>{i(e)}))}})),n)}unregisterWindowFactory(e,t){return Ft(new Promise(((t,n)=>{_t(e)?n("no windowType specified"):mt(e)?this._bridge.unregisterWindowFactory(e).then((e=>{t(e)})).catch((e=>{n(e)})):n("windowType should be a string")})),t)}getActivities(e){let t=this._activities.get();if(t=t.filter((e=>e._ownerId)),!e)return t;let n=e;if(mt(e))n=[e];else if(e instanceof Tt)n=[e.name];else if(!(e instanceof Array))throw new Error("Invalid input argument 'activityType' = "+e);return t.filter((e=>{const t=e.type;return function(e,t){for(let n=0;n<e.length;n++)if(t(e[n],n))return!0;return!1}(n,(e=>t.id===e.id))}))}getActivityById(e){return this._activities.getByName(e)}announceWindow(e,t){return new Promise(((n,i)=>{const r=this._bridge.getAnnouncementInfo();if(bt(e)&&(e=r.activityWindowId),bt(t)&&(t=r.activityWindowType),_t(t))throw new Error("Can not announce - unknown windowType");const o=r&&r.activityId;if(_t(e))this._logger.debug("Registering window with type:'"+t+"', name:'"+r.activityWindowName+"', ind.:'"+r.activityWindowIndependent+"'"),this._bridge.registerWindow(t,r.activityWindowName,r.activityWindowIndependent).then(this._windows.getOrWait.bind(this._windows)).then((e=>o?this._activities.getOrWait(o).then((t=>e)):e)).then((e=>{n(e)})).catch((e=>{this._logger.error(e)}));else{this._logger.debug("Announcing window with id '"+e+"' and type '"+t+"'");const r=this._windows.getByName(e);if(!_t(r))return this._logger.debug("Window with id '"+e+"' already announced - reusing the window"),void n(r);const o=(t,r,s)=>{if(e===r.id&&s===Rt.ActivityWindowJoinedActivity){bt(r.activity)&&i("UNDEFINED ACTIVITY"),this._logger.trace("Got joined event for id '"+e+"'"),n(r),this.unsubscribeWindowEvents(o)}};this.subscribeWindowEvents(o),this._logger.trace("Waiting for joined event for id '"+e+"'"),this._bridge.announceWindow(t,e)}}))}subscribeWindowTypeEvents(e){this._windowTypes.subscribe(((t,n)=>{e(t,n.type)}))}subscribeActivityEvents(e){return this._activities.subscribe(((t,n)=>{if(n.type===Rt.StatusChange){const i=n;e(t,i.newStatus,i.oldStatus)}if(n.type===Rt.Removed||n.type===Rt.StatusChange&&n.newStatus.getState()===jt.Destroyed)for(const e of this._windows.get())e.activity&&e.activity.id===t.id&&this._windows.process(new St(e,new Pt(Rt.ActivityWindowLeftActivity)))}))}subscribeWindowEvents(e){const t=(t,n)=>{let i=n.type;i===Rt.Added&&(i="opened"),e(t.activity,t,i)};return this._windowHandlers.push([e,t]),this._windows.subscribe(t)}unsubscribeWindowEvents(e){const t=this._windowHandlers.find((t=>t[0]===e));t&&(this._windowHandlers.splice(this._windowHandlers.indexOf(t),1),this._windows.unsubscribe(t[1]))}createWindow(e,t,n){return Ft(new Promise(((n,i)=>{let r,o;if(_t(t)&&i("windowType is undefined"),mt(t))r={type:t,name:"",isIndependent:!1,arguments:{}};else if(t instanceof kt)r={type:t.type||t.id,name:t.name||t.type||t.id,isIndependent:!1};else{const e=["url"],n={};Object.keys(t).forEach((i=>{-1===e.indexOf(i)&&(n[i]=t[i])})),r=n}if(!_t(r.relativeTo))if(o=r.relativeTo,"string"==typeof o){const e=this.getWindows({type:o});!_t(e)&&e.length>0&&(r.relativeTo=e[0].id)}else if(_t(o.type))_t(o.windowId)||(r.relativeTo=o.windowId);else{const e=this.getWindows({type:o.type});!_t(e)&&e.length>0&&(r.relativeTo=e[0].id)}this._bridge.createWindow(e&&e.id,r).then((t=>{this._logger.debug("Window created, waiting for window entity with id "+t);const i=(r,o)=>{r.id!==t||e&&!r.activity||(this._logger.debug("Got entity window with id "+t),n(r),this._windows.unsubscribe(i))};this._windows.subscribe(i)})).catch((e=>{i(e)}))})),n)}createStackedWindows(e,t,n,i){return Ft(new Promise(((i,r)=>{_t(e)&&r("activity is undefined"),_t(t)&&r("relativeWindowTypes is undefined"),Array.isArray(t)||r("relativeWindowTypes has to be an array"),_t(n)&&(n=2e4);const o=[];t.forEach((e=>{let t,i;if(t=mt(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e,t.stackedWindow=!0,t.timeout=n,!_t(t.relativeTo))if(i=t.relativeTo,_t(i.type)){if(!_t(i.windowId)){const e=this.getWindows({id:i.windowId});!_t(e)&&e.length>0&&(t.relativeTo=e[0].type.name)}}else t.relativeTo=i.type;o.push(t)}));const s=[];o.forEach((t=>s.push(this.createWindow(e,t)))),Promise.all(s).then(i).catch(r)})),i)}addWindowToActivity(e,t,n){const i=this._bridge.joinActivity(e.id,t.id).then((()=>t));return Ft(i,n),i}leaveWindowFromActivity(e,t,n){const i=this._bridge.leaveActivity(e.id,t.id).then((()=>t));return Ft(i,n),i}setActivityContext(e,t,n){return Ft(new Promise(((n,i)=>{_t(e)&&i("activity can not be null"),this._bridge.updateActivityContext(e,t,!0).then((t=>{n(e)})).catch((e=>{i(e)}))})),n)}updateActivityContext(e,t,n){return Ft(new Promise(((n,i)=>{_t(e)&&i("activity can not be null");const r=[];for(const e in t)t.hasOwnProperty(e)&&null===t[e]&&r.push(e);for(const e of r)delete t[e];this._bridge.updateActivityContext(e,t,!1,r).then((t=>{n(e)})).catch((e=>{i(e)}))})),n)}subscribeActivityContextChanged(e){this._activities.subscribe(((t,n)=>{if(n.type===Rt.ActivityContextChange){const i=n;e(t,i.context,i.updated,i.removed)}}))}stopActivity(e,t){return Ft(this._bridge.stopActivity(e),t)}getWindows(e){if(bt(e))return this._windows.get();if(!bt(e.id))return[this._windows.getByName(e.id)];return this._windows.get().filter((t=>{if(!bt(e.type)&&t.type.id!==e.type)return!1;if(!bt(e.name)&&t.name!==e.name)return!1;if(!bt(e.activityId)){if(_t(t.activity))return!1;if(t.activity.id!==e.activityId)return!1}return!0}))}getWindowBounds(e){return this._bridge.getWindowBounds(e)}setWindowBounds(e,t,n){return Ft(new Promise(((n,i)=>{this._bridge.setWindowBounds(e,t).then((()=>n())).catch((e=>i(e)))})),n)}closeWindow(e){return this._bridge.closeWindow(e)}activateWindow(e,t){return this._bridge.activateWindow(e,t)}setWindowVisibility(e,t){return this._bridge.setWindowVisibility(e,t)}clone(e,t,n){return Ft(new Promise(((n,i)=>{e||i("activity can not be null"),this._bridge.cloneActivity(e.id,t).then((e=>{this._activities.getOrWait(e).then((e=>{n(e)})).catch((e=>i(e)))})).catch((e=>i(e)))})),n)}attachActivities(e,t,n,i){n=n||{};return Ft(new Promise(((i,r)=>{if(!this._activities.getByName(e))return void r("can not find activity with id "+e);if(this._activities.getByName(t))return this._bridge.attachActivities(e,t,n).then((e=>{const t=e.to,n=e.descriptor,r=e.descriptors;this._activities.getOrWait(t).then((e=>{e._updateDescriptors(r);const t=e.attached.filter((e=>e.ownerId===n.ownerId))[0];i(t)}))})).catch((e=>{r(e)}));r("can not find activity with id "+t)})),i)}detachActivities(e,t,n){return Ft(new Promise(((n,i)=>this._bridge.detachActivities(e,t).then((()=>{this._activities.getOrWait(undefined).then((e=>{e._updateDescriptors(undefined),this._activities.getOrWait(undefined).then((e=>{n(e)}))})).catch((e=>i(e)))})).catch((e=>{i(e)})))),n)}subscribeActivitiesAttached(e){this._attachedCallbacks.push(e)}subscribeActivitiesDetached(e){this._detachedCallbacks.push(e)}subscribeActivityFrameColorChanged(e){this._frameColorChangesCallbacks.push(e)}_grabEntity(e){e._manager=this}_getInitialData(){this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((e=>{this._activityTypes.add(e),this._dataReadyMarker.signal("Got act types")})).catch((e=>{this._logger.error(e),this._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((e=>{this._windowTypes.add(e),this._dataReadyMarker.signal("Got window types")})).catch((e=>{this._logger.error(e),this._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((e=>{this._activities.add(e),this._dataReadyMarker.signal("Got activities")})).catch((e=>{this._logger.error(e),this._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((e=>{this._windows.add(e),this._dataReadyMarker.signal("Got windows")})).catch((e=>{this._logger.error(e),this._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))}_subscribeForData(){this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((e=>{this._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((e=>{this._windowTypes.process(e)})),this._bridge.onActivityWindowChange((e=>{this._windows.process(e)})),this._bridge.onActivityStatusChange((e=>{this._activities.process(e)}))}_handleActivitiesAttached(e){const t=e.to,n=e.descriptor,i=e.descriptors;this._activities.getOrWait(t).then((e=>{e._updateDescriptors(i);const t=e.attached.filter((e=>e.ownerId===n.ownerId))[0];this._attachedCallbacks.forEach((n=>{try{n(e,t)}catch(e){return}}))}))}_handleActivitiesDetached(e){const t=e.oldActivityId,n=e.newActivityId,i=e.descriptors,r=e.descriptor;this._activities.getOrWait(t).then((e=>{e._updateDescriptors(i),this._activities.getOrWait(n).then((t=>{this._detachedCallbacks.forEach((n=>{try{n(t,e,r)}catch(e){return}}))}))}))}_handleActivityDescriptorsRefreshed(e){const t=e.id,n=e.descriptors,i=this._activities.getByName(t);i&&i._updateDescriptors(n)}refreshDescriptors(){this._bridge.getAttachedDescriptors().then((e=>{e&&Object.keys(e).forEach((t=>{const n=t,i=e[t],r=this._activities.getByName(n);r&&r._updateDescriptors(i)})),this._descriptorsMarker.signal("Successfully got descriptors")})).catch((e=>{this._descriptorsMarker.error("failed to get descriptors - "+e)}))}_handleWindowFrameColorChanged(e){if(!e.activityId)return;const t=this._activities.getByName(e.activityId);t&&t.owner&&t.owner.underlyingWindow.id===e.id&&this._frameColorChangesCallbacks.forEach((n=>{try{n(t,e.frameColor)}catch(e){return}}))}}class cn{constructor(e,t){this._m=e,this._my=t,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}onAttached(e){this._m.subscribeActivitiesAttached(e)}onDetached(e){this._m.subscribeActivitiesDetached(e)}onActivityFrameColorChanged(e){this._m.subscribeActivityFrameColorChanged(e)}_getActivityTypesWrapper(e){return bt(e)?this._m.getActivityTypes():this._m.getActivityType(e)}_getWindowTypesWrapper(e){return bt(e)?this._m.getWindowTypes():this._m.getWindowType(e)}}class dn{constructor(e,t){this._mgr=e,this._my=t,this.all=new cn(e,t)}ready(e){return Ft(new Promise(((e,t)=>{this._mgr.ready().then((()=>{e(this)})).catch((e=>{t(e)}))})),e)}get my(){return this._my}get aware(){return void 0!==this._my.window}get inActivity(){return this.aware&&void 0!==this._my.activity}get agm(){if(this.aware)return this.inActivity?this._my.activity.agm:new Wt(null)}getAvailableFrameColors(){return[]}}class un{constructor(e){if(!e)throw new Error("config can not be null");let t;if(bt(e.logLevel)||(Gt.Level=e.logLevel),_t(e.logger)||(Gt.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=un.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)throw new Error("GD2 not supported");if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");if(t=new nn(e),!t)throw new Error("A bridge to native activity is needed to create activity lib.");Wt.AGM=e.agm;const n=new an(t,!e.disableAutoAnnounce,e.windows),i=new rn(n,e.windows);this._api=new dn(n,i),this._readyPromise=n.ready().then((e=>this))}static checkIsUsingGW3Implementation(e){return 3===e.protocolVersion}get api(){return this._api}set api(e){this._api=e}get isUsingHCImplementation(){return this._isUsingHCImplementation}get isUsingGW3Implementation(){return this._isUsingGW3Implementation}ready(e){return Ft(this._readyPromise,e)}}const hn="T42.ACS.GetFunctionalEntitlement",ln="T42.ACS.CanI",pn="T42.ACS.OnEvent";function gn(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(t)t(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,r){var o=n[e];return o||(o=[],n[e]=o),o.push(t),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(r)?t.apply(void 0,r):t.apply(void 0,[r])}catch(t){i(t,e)}}))}),0),function(){var i=n[e];i&&(0===(i=i.reduce((function(e,n,i){return n===t&&e.length===i||e.push(n),e}),[])).length?delete n[e]:n[e]=i)}},execute:function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var o=n[e];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,t);s.push(r)}catch(t){s.push(void 0),i(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}gn.default=gn;var fn=gn;function yn(e){return e?Object.keys(e).map((t=>e[t])):[]}function mn(e){let t;try{t=JSON.parse(JSON.stringify(e||{}))}catch(e){t={}}return t}class vn{constructor(e,t,n){this._appManager=e,this._name=t,this._agm=n,this._registry=fn(),e.onInstanceStarted((e=>{e.application&&e.application.name!==this._name||this._registry.execute("instanceStarted",e)})),e.onInstanceStopped((e=>{e.application&&e.application.name!==this._name||this._registry.execute("instanceStopped",e)})),e.onAppRemoved((e=>{e.name===this._name&&this._registry.execute("appRemoved",e)})),e.onAppChanged((e=>{e.name===this._name&&this._registry.execute("appChanged",e)})),e.onAppAvailable((e=>{e.name===this._name&&(this._props.IsReady=!0,this._registry.execute("appAvailable",e))})),e.onAppUnavailable((e=>{e.name===this._name&&(this._props.IsReady=!1,this._registry.execute("appUnavailable",e))}))}get name(){return this._name}get title(){return this._props.Title}get version(){return this._props.Version}get autoStart(){return this._props.AutoStart}get isShell(){return this._props.IsShell}get caption(){return this._props.Caption}get hidden(){return this._props.IsHidden}get container(){return this._props.ApplicationName}get activityType(){return this._props.ActivityType}get activityWindowType(){return this._props.ActivityWindowType}get windowSettings(){return this._props.Arguments?mn(this._props.Arguments):{}}get allowMultiple(){return this._props.AllowMultiple}get available(){return this._props.IsReady||!0}get icon(){return this._props.Icon}get iconURL(){return this._props.IconUrl}get sortOrder(){return this._props.SortOrder}get userProperties(){return this._props.UserProperties?mn(this._props.UserProperties):{}}get isActivity(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType}get configuration(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}}get instances(){return this._appManager.instances().filter((e=>e.application.name===this._name))}get type(){return this._props.Type}get mode(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();let e=this._props.WindowStyleAttributes;if(e){e=e.split(" ").join("");const t='mode:"',n=e.indexOf(t);if(-1!==n){const i=n+t.length,r=e.indexOf('"',i),o=e.substr(i,r-i);if(o&&"string"==typeof o)return o.toLowerCase()}}return"flat"}updateFromProps(e){this._props||(this._props={Name:e.Name}),Object.keys(e).forEach((t=>{this._props[t]=e[t]}))}start(e,t){return new Promise((async(n,i)=>{var r;const o=this._name;let s=6e4;if(_t(e))e={};else if("object"!=typeof e)return i(new Error('Invalid "context" parameter - must be an object.'));if(_t(t))t={};else if("object"!=typeof t)return i(new Error('Invalid "options" parameter - must be an object.'));let a=null===(r=t.waitForAGMReady)||void 0===r||r;const c=e=>{let t;const r=setTimeout((()=>{t&&t(),i(`timed out while waiting for instance id ${e} for app ${this.name}`)}),s),o=i=>{i.id===e&&(t&&(t(),t=void 0),clearTimeout(r),n(i))};t=a?this._appManager.onInstanceAgmServerReady(o):this._appManager.onInstanceStarted(o)},d=(await this._agm.invoke("T42.ACS.StartApplication",{Name:o,Context:e,Options:t},"best",{methodResponseTimeoutMs:s})).returned;if(void 0!==d.timeout&&(s=1e3*d.timeout),void 0!==d.waitForInterop&&void 0===t.waitForAGMReady&&(a=d.waitForInterop),d&&d.Id)if("startOnly"===this._appManager.mode){const e=this._appManager.handleInstanceStarted({ActivityId:void 0,IsActivityOwner:void 0,Context:void 0,Title:void 0,AgmServers:void 0,Id:d.Id,Name:d.Name});n(e)}else c(d.Id);else n(void 0)}))}onInstanceStarted(e){return this._registry.add("instanceStarted",e)}onInstanceStopped(e){return this._registry.add("instanceStopped",e)}onAvailable(e){return this._props.IsReady&&setTimeout((()=>{this._registry.execute("appAvailable",this)}),0),this._registry.add("appAvailable",e)}onUnavailable(e){return!1===this._props.IsReady&&setTimeout((()=>{this._registry.execute("appUnavailable",this)}),0),this._registry.add("appUnavailable",e)}onChanged(e){this._registry.add("appChanged",e)}onRemoved(e){this._registry.add("appRemoved",e)}}class wn{constructor(e,t,n,i,r,o,s){this._id=e,this._appName=t,this._appManager=n,this._agm=i,this._activities=r,this._windows=o,this._registry=fn(),s||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((e=>{e.id===this._id&&this._registry.execute("stopped",e)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((e=>{e.id===this._id&&this._registry.execute("agmReady",e)})))}get id(){return this._id}get application(){return this._appManager.application(this._appName)}get activity(){if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((e=>e.id===this._activityId))[0]}get isActivityOwner(){return this._isActivityOwner}get activityInstances(){return this._appManager.instances().filter((e=>"activity"!==e.application.type&&e.activityId&&e.activityId===this._activityId))}get activityOwnerInstance(){if(this._activityId)return this.activityInstances.filter((e=>{var t;return null===(t=e)||void 0===t?void 0:t.isActivityOwner}))[0]}get window(){if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");let e=this._windows.list().filter((e=>e.id===this._id))[0];return!e&&this._activities&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e}get context(){var e,t,n;return null!==(n=null!==(e=this._startUpContext)&&void 0!==e?e:null===(t=this.window)||void 0===t?void 0:t.context)&&void 0!==n?n:{}}get title(){return this._title}get isActivityInstance(){return this._isActivityInstance}get activityId(){return this._activityId}get inActivity(){return this._inActivity}get isSingleWindowApp(){return!this._inActivity}get agm(){return this._agmInstance}onAgmReady(e){return this._agmInstance&&setTimeout((()=>{this._registry.execute("agmReady",this)}),0),this._registry.add("agmReady",e)}onStopped(e){return this._registry.add("stopped",e)}getWindow(){return new Promise(((e,t)=>{const n=this.window;if(n)return void e(n);const i=(n,i)=>{n&&t(n),i&&e(i),setTimeout((()=>{clearTimeout(r),o()}),0)},r=setTimeout((()=>{i(new Error(`can not find a window with id ${this._id}`))}),3e4),o=this._windows.onWindowAdded((e=>{e.id===this._id&&i(void 0,e)}))}))}updateFromProps(e){this._startUpContext=e.Context,this._title=e.Title,this._isActivityInstance=!1,e.ActivityId&&""!==e.ActivityId&&(this._activityId=e.ActivityId,this._isActivityInstance=!0),this._isActivityOwner=e.IsActivityOwner,!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(e)}updateAgmInstanceFromProps(e){if(!e.AgmServers)return;const t=e.AgmServers;t&&t.length>0&&!_t(t[0])&&(this._agmInstance=t[0])}stop(){return new Promise(((e,t)=>{const n=this._appManager.onInstanceStopped((t=>{t.id===this._id&&(n(),e())}));this._agm.invoke("T42.ACS.StopApplication",{Name:this._appName,Id:this._id}).then((()=>{"startOnly"===this._appManager.mode&&(this._appManager.handleInstanceStopped({Name:this._appName,Id:this.id,Context:void 0,Title:void 0,ActivityId:void 0,IsActivityOwner:void 0,AgmServers:void 0}),e())})).catch((e=>t(e)))}))}activate(){return this._agm.invoke("T42.ACS.ActivateApplication",{Name:this._appName,Id:this._id})}done(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()}getContext(){return Promise.resolve(this.context)}}class bn{constructor(e,t,n,i,r,o){this.mode=e,this._agm=t,this._activities=n,this._windows=i,this._logger=r,this._gdMajorVersion=o,this._apps={},this._instances=[],this._registry=fn(),this.application=e=>{if("string"!=typeof e)throw new Error('"name" must be string');return this._apps[e]},this.applications=()=>Object.keys(this._apps).map((e=>this._apps[e])),this.instances=()=>this._instances,this.getMyInstance=()=>{if(this._gdMajorVersion>=3){const e=window.glue42gd.appInstanceId;return this._instances.filter((t=>t.id===e))[0]}},this.handleAppAdded=e=>{const t=this._getAppId(e);this._logger.trace(`adding app ${t}`),this._apps[t]=new vn(this,t,this._agm);const n=this._updateAppFromProps(e);this._registry.execute("appAdded",n),this._registry.execute("appAvailable",n)},this.handleAppUpdated=e=>{const t=this._updateAppFromProps(e);this._registry.execute("appChanged",t)},this.handleAppRemoved=e=>{const t=this._getAppId(e);this._logger.trace(`removing app ${t}`);const n=this.application(t);this._instances=this._instances.filter((e=>e.application.name!==n.name)),delete this._apps[t],this._registry.execute("appRemoved",n)},this.handleAppReady=e=>{const t=this._getAppId(e),n=this._getAppOrThrow(t);n.updateFromProps(e),n.available?this._registry.execute("appAvailable",n):this._registry.execute("appUnavailable",n)},this.handleInstanceStarted=e=>{this._logger.trace(`started app ${e.Name} ${e.Id}`);const t=this._getInstanceId(e),n=this._getInstanceAppName(e),i=new wn(t,n,this,this._agm,this._activities,this._windows);return this._updateInstanceFromProps(i,e),this._instances.push(i),this._registry.execute("instanceStarted",i),i},this.handleInstanceStopped=e=>{this._logger.trace(`failed to start app ${e.Name} ${e.Id}`);const t=this._getInstanceId(e),n=this._getInstanceAppName(e),i=this._getInstanceOrThrow(t,n);this._instances=this._instances.filter((e=>!this._matchInstance(e,t,n))),this._registry.execute("instanceStopped",i),i.done()},this.handleInstanceAgmServerReady=e=>{const t=this._getInstanceId(e),n=this._getInstanceAppName(e),i=this._getInstanceOrThrow(t,n);i.updateAgmInstanceFromProps(e),this._registry.execute("instanceAgmServerReady",i)},this.handleInstanceStartFailed=e=>{const t=this._getInstanceId(e),n=this._getInstanceAppName(e),i=new wn(t,n,void 0,void 0,void 0,void 0,!0);this._updateInstanceFromProps(i,e),this._registry.execute("instanceStartFailed",i)},this.handleInstanceUpdated=e=>{const t=this._getInstanceId(e),n=this._getInstanceAppName(e),i=this._getInstanceOrThrow(t,n);this._updateInstanceFromProps(i,e)},this.onInstanceStarted=e=>this._registry.add("instanceStarted",e,this._instances),this.onInstanceStartFailed=e=>this._registry.add("instanceStartFailed",e),this.onInstanceStopped=e=>this._registry.add("instanceStopped",e),this.onInstanceUpdated=e=>this._registry.add("instanceChanged",e),this.onInstanceAgmServerReady=e=>this._registry.add("instanceAgmServerReady",e),this.onAppAdded=e=>this._registry.add("appAdded",e,Object.values(this._apps)),this.onAppRemoved=e=>this._registry.add("appRemoved",e),this.onAppAvailable=e=>this._registry.add("appAvailable",e),this.onAppUnavailable=e=>this._registry.add("appUnavailable",e),this.onAppChanged=e=>this._registry.add("appChanged",e)}_getAppOrThrow(e){const t=this.application(e);if(!t)throw Error(`app with id ${e} not found`);return t}_getAppId(e){return e.Name}_matchInstance(e,t,n){return e.id===t&&e.application.name===n}_getInstanceByIdAndName(e,t){return this._instances.filter((n=>this._matchInstance(n,e,t)))[0]}_getInstanceOrThrow(e,t){const n=this._getInstanceByIdAndName(e,t);if(!n)throw Error(`instance with id ${e} not found`);return n}_getInstanceId(e){return e.Id}_getInstanceAppName(e){return e.Name}_updateAppFromProps(e){const t=this._getAppId(e);this._logger.trace(`updating app with  + ${t}, ${e}`);const n=this._getAppOrThrow(t);return n.updateFromProps(e),n}_updateInstanceFromProps(e,t){this._logger.trace("updating instance with "+this._getInstanceId(t)+" for app "+this._getInstanceAppName(t)),e.updateFromProps(t)}}function _n(e,t,n){const i=e=>!!(e&&e.constructor&&e.call&&e.apply);return i(t)||i(n)?(i(t)?i(n)||(n=()=>{}):t=()=>{},e.then(t,n)):e}class In{constructor(e){this._agm=e,this._registry=fn(),this._isMethodRegistered=!1,this.handleBranchModified=e=>{this._registry.execute("branchChanged",e)},this.handleBranchesModified=e=>{this._registry.execute("branchesChanged",e)},this.getRegion=(e,t)=>_n(this._agmInvoke("T42.ACS.GetConfigurationRegion",(e=>e.returned.Region)),e,t),this.getBranches=(e,t)=>_n(this._agmInvoke("T42.ACS.GetBranches",(e=>{const t=e.returned.Branches;return Object.keys(t).map((e=>t[e]))})),e,t),this.getCurrentBranch=(e,t)=>_n(this._agmInvoke("T42.ACS.GetCurrentBranch",(e=>e.returned.Branch),void 0),e,t),this.setRegion=(e,t,n)=>_n(this._agmInvoke("T42.ACS.SetConfigurationRegion",(e=>e.returned.ResultMessage),{Region:e}),t,n),this.setCurrentBranch=(e,t,n)=>_n(this._agmInvoke("T42.ACS.SetCurrentBranch",(e=>e.returned.ResultMessage),{Branch:e}),t,n),this.currentUser=(e,t)=>_n(this._agmInvoke("T42.ACS.GetUser"),e,t),this.getFunctionalEntitlement=(e,t,n)=>_n(this._agmInvoke(hn,(e=>e.returned.Entitlement),{Function:e}),t,n),this.getFunctionalEntitlementBranch=(e,t,n,i)=>_n(this._agmInvoke(hn,(e=>e.returned.Entitlement),{Function:e,Branch:t}),n,i),this.canI=(e,t,n)=>_n(this._agmInvoke(ln,(e=>e.returned.Result),{Function:e}),t,n),this.canIBranch=(e,t,n,i)=>_n(this._agmInvoke(ln,(e=>e.returned.Result),{Function:e,Branch:t}),n,i),this.onBranchesChanged=e=>this._registry.add("branchesChanged",e),this.onBranchChanged=e=>this._registry.add("branchChanged",e),this.exit=e=>this._agmInvoke("T42.ACS.Shutdown",null,e),this.onShuttingDown=e=>(this.registerMethod(),this._registry.add("onShuttingDown",e)),this.restart=e=>this._agmInvoke("T42.ACS.Restart",null,e),this._agmInvoke=(e,t,n)=>(n=n||{},new Promise(((i,r)=>{this._agm.invoke(e,n).then((e=>{t||(t=e=>e.returned),i(t(e))})).catch((e=>r(e)))})))}registerMethod(){this._isMethodRegistered||(this._agm.register("T42.ACS.OnGDShutdown",(async e=>{try{const t=await Promise.all(this._registry.execute("onShuttingDown",e));return{prevent:t.some((e=>e.prevent))}}catch(e){}})),this._isMethodRegistered=!0)}}const Cn="T42.ACS.InMemoryStoreCommand";class An{constructor(e){this.interop=e}import(e,t){if(!e||!Array.isArray(e))return Promise.reject("invalid apps argument - should be an array of application definitions");if(t&&"replace"!==t&&"merge"!==t)return Promise.reject("invalid mode argument - should be 'replace' or 'merge'");const n={command:"import",args:{apps:e,mode:t=null!=t?t:"replace"}};return this.interop.invoke(Cn,n).then((e=>e.returned))}export(){return this.interop.invoke(Cn,{command:"export"}).then((e=>e.returned.apps))}remove(e){if(!e||"string"!=typeof e)return Promise.reject("invalid app name, should be a string value");const t={command:"remove",args:{apps:[e]}};return this.interop.invoke(Cn,t).then((e=>e.returned))}clear(){return this.interop.invoke(Cn,{command:"clear"}).then((e=>e.returned))}createAppDef(e,t){return t||(t="https://google.com"),{name:e,type:"window",title:e,details:{url:t}}}}var xn=e=>{if(!e)throw Error("config not set");if(!e.agm)throw Error("config.agm is missing");const t="startOnly",n="skipIcons",i=e.mode||t;if(i!==t&&i!==n&&"full"!==i)throw new Error(`Invalid mode for appManager lib - ${i} is not supported`);const r=e.activities,o=e.agm,s=e.logger,a=e.windows,c=new bn(i,o,r,a,s.subLogger("applications"),e.gdMajorVersion),d=new In(o);let u;if(i===t)u=function(e,t){return new Promise(((n,i)=>{e.invoke("T42.ACS.GetApplications",{skipIcon:!0}).then((e=>{const i=e.returned;i||n();const r=i.applications;r||n(),yn(r).map((e=>t.handleAppAdded(e))),n()})).catch((e=>i(`Error getting application snapshot: ${e.message}`)))}))}(o,c);else{const e=function(e,t,n,i){let r,o=!1;return{start:()=>{let s,a;const c=new Promise(((e,t)=>{s=e,a=t}));return e.subscribe(pn,{arguments:{skipIcon:i},waitTimeoutMs:1e4}).then((i=>{r=i,r.onData((i=>{const r=i.data,a=yn(r.OnApplicationAdded);a.map((e=>t.handleAppAdded(e))),yn(r.OnApplicationChanged).map((e=>t.handleAppUpdated(e))),yn(r.OnApplicationRemoved).map((e=>t.handleAppRemoved(e))),yn(r.OnApplicationReady).map((e=>t.handleAppReady(e)));const c=yn(r.OnApplicationStarted);if(c.map((e=>t.handleInstanceStarted(e))),yn(r.OnApplicationStartFailed).map((e=>t.handleInstanceStartFailed(e))),yn(r.OnApplicationStopped).map((e=>t.handleInstanceStopped(e))),yn(r.OnApplicationUpdated).map((e=>t.handleInstanceUpdated(e))),yn(r.OnApplicationAgmServerReady).map((e=>t.handleInstanceAgmServerReady(e))),yn(r.OnBranchChanged).map((e=>n.handleBranchModified(e))),yn(r.OnBranchesModified).map((e=>n.handleBranchesModified(e))),!o){o=!0;const n=a.some((t=>t.Name===e.instance.application)),i=c.some((t=>t.Id===e.instance.instance));if(n)if(i)s();else{const n=t.onInstanceStarted((t=>{t.id===e.instance.instance&&(n(),s())}))}else s()}})),r.onFailed((e=>a(e)))})).catch((e=>{var t;return a(`Error subscribing for T42.ACS.OnEvent stream. Err: ${null!==(t=e.message)&&void 0!==t?t:e}`)})),c},stop:()=>{r&&r.close()}}}(o,c,d,i===n);u=e.start()}return{ready:()=>u,applications:c.applications,application:c.application,onAppAdded:c.onAppAdded,onAppRemoved:c.onAppRemoved,onAppChanged:c.onAppChanged,onAppAvailable:c.onAppAvailable,onAppUnavailable:c.onAppUnavailable,instances:c.instances,get myInstance(){return c.getMyInstance()},onInstanceStarted:c.onInstanceStarted,onInstanceStopped:c.onInstanceStopped,onInstanceUpdated:c.onInstanceUpdated,onInstanceStartFailed:c.onInstanceStartFailed,getRegion:d.getRegion,getBranches:d.getBranches,getCurrentBranch:d.getCurrentBranch,getFunctionalEntitlement:d.getFunctionalEntitlement,getFunctionalEntitlementBranch:d.getFunctionalEntitlementBranch,setCurrentBranch:d.setCurrentBranch,setRegion:d.setRegion,currentUser:d.currentUser,canI:d.canI,canIBranch:d.canIBranch,onBranchesChanged:d.onBranchesChanged,exit:d.exit,restart:d.restart,onShuttingDown:d.onShuttingDown,inMemory:new An(o)}};var Tn=1;var kn,Sn,Pn,Mn={nextValue:function(){return(Tn=(9301*Tn+49297)%233280)/233280},seed:function(e){Tn=e}},En="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Rn(){Pn=!1}function jn(e){if(e){if(e!==kn){if(e.length!==En.length)throw new Error("Custom alphabet for shortid must be "+En.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+En.length+" unique characters. These characters were not unique: "+t.join(", "));kn=e,Rn()}}else kn!==En&&(kn=En,Rn())}function Wn(){return Pn||(Pn=function(){kn||jn(En);for(var e,t=kn.split(""),n=[],i=Mn.nextValue();t.length>0;)i=Mn.nextValue(),e=Math.floor(i*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var On={characters:function(e){return jn(e),kn},seed:function(e){Mn.seed(e),Sn!==e&&(Rn(),Sn=e)},lookup:function(e){return Wn()[e]},shuffled:Wn},Nn="object"==typeof window&&(window.crypto||window.msCrypto);var Fn=function(){if(!Nn||!Nn.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return Nn.getRandomValues(e),48&e[0]};var Ln=function(e,t){for(var n,i=0,r="";!n;)r+=e(t>>4*i&15|Fn()),n=t<Math.pow(16,i+1),i++;return r};var Dn,Gn,Bn=function(e){var t=On.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}};var qn=function(e){var t="",n=Math.floor(.001*(Date.now()-1459707606518));return n===Gn?Dn++:(Dn=0,Gn=n),t+=Ln(On.lookup,6),t+=Ln(On.lookup,e),Dn>0&&(t+=Ln(On.lookup,Dn)),t+=Ln(On.lookup,n)};var Hn=function(e){if(!e||"string"!=typeof e||e.length<6)return!1;for(var t=On.characters(),n=e.length,i=0;i<n;i++)if(-1===t.indexOf(e[i]))return!1;return!0},Un=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t=0;function n(){return qn(t)}e.exports=n,e.exports.generate=n,e.exports.seed=function(t){return On.seed(t),e.exports},e.exports.worker=function(n){return t=n,e.exports},e.exports.characters=function(e){return void 0!==e&&On.characters(e),On.shuffled()},e.exports.decode=Bn,e.exports.isValid=Hn}));Un.generate,Un.seed,Un.worker,Un.characters,Un.decode,Un.isValid;var Vn=Un;const Jn="T42.JumpList.Action";var zn=new class{constructor(){this._groupActionCallbacks=new Map,this._registered=!1}init(e,t,n){this._executor=e,this._agm=t,this._logger=n,this.registerCallbackMethod()}setEnabled(e,t){const n={enabled:t};return this._executor.updateJumpList(e,n)}createCategory(e,t,n){const i={category:{title:t,operation:"create",actions:this.toUpdateActions("create",t,n)}};return this._executor.updateJumpList(e,i)}removeCategory(e,t){const n={category:{title:t,operation:"remove",actions:[]}};return this.manageActionCallback(n.category.operation,t),this._executor.updateJumpList(e,n)}createActions(e,t,n){const i={category:{title:t,operation:"update",actions:this.toUpdateActions("create",t,n)}};return this._executor.updateJumpList(e,i)}removeActions(e,t,n){const i={category:{title:t,operation:"update",actions:this.toUpdateActions("remove",t,n)}};return this._executor.updateJumpList(e,i)}async getActions(e,t){const n=[],i=(await this.getJumpListSettings(e)).categories.find((e=>e.title===t));return i&&i.actions.forEach((e=>{const t=this.getActionCallback(e.callbackId);t&&(e.callback=t.callback),n.push({icon:e.icon,callback:e.callback,singleInstanceTitle:e.singleInstanceTitle,multiInstanceTitle:e.multiInstanceTitle})})),Promise.resolve(n)}getJumpListSettings(e){return this._executor.getJumpList(e)}toUpdateActions(e,t,n){return n.map((n=>{const i={icon:n.icon,callback:n.callback,callbackId:Vn.generate(),singleInstanceTitle:n.singleInstanceTitle,multiInstanceTitle:n.multiInstanceTitle,operation:e};return this.manageActionCallback(e,t,i),i}))}manageActionCallback(e,t,n){if("create"===e){this._groupActionCallbacks.has(t)||this._groupActionCallbacks.set(t,[]);this._groupActionCallbacks.get(t).push({callbackId:n.callbackId,callback:n.callback})}else if("remove"===e)if(n){let e=this._groupActionCallbacks.get(t);e=e.filter((e=>e.callbackId!==n.callbackId)),0===e.length?this._groupActionCallbacks.delete(t):this._groupActionCallbacks.set(t,e)}else this._groupActionCallbacks.delete(t)}registerCallbackMethod(){if(!this._registered){this._registered=!0;try{this._agm.register(Jn,((e,t)=>{const n=this.getActionCallback(e.callbackId);if(n)try{n.callback()}catch(e){this._logger.error("Unable to execute user callback for jump list action!",e)}}))}catch(e){return this._logger.error("Unable to register method T42.JumpList.Action for invoking jump list action callbacks!",e),Promise.reject(e)}}}getActionCallback(e){let t;return[...this._groupActionCallbacks.values()].forEach((n=>{const i=n.find((t=>t.callbackId===e));i&&(t=i)})),t}};var $n=new class{constructor(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=fn()}init(e){this._logger=e}get(e){return this._windows[e]||this._pendingWindows[e]}getIfReady(e){return this._windows[e]}get list(){return this._windows}add(e){if(!!this._pendingWindows[e.API.id])return void this._logger.error(`trying to add window with id ${e.API.id} from windowStore, which already exists`);const t="remote"===e.API.windowType;this._pendingWindows[e.API.id]=e,this._pendingWindowsStates[e.API.id]={ready:!1,urlChanged:t},this._registry.execute("on-added",e)}remove(e){delete this._windows[e.API.id],delete this._pendingWindows[e.API.id],delete this._pendingWindowsStates[e.API.id],this._registry.execute("on-removed",e)}setReadyState(e){const t=this._pendingWindowsStates[e];void 0!==t&&(t.ready=!0,t.urlChanged&&this.markReadyToShow(e))}setUrlChangedState(e){const t=this._pendingWindowsStates[e];void 0!==t&&(t.urlChanged=!0,t.ready&&this.markReadyToShow(e))}waitFor(e){return new Promise(((t,n)=>{let i;const r=setTimeout((()=>{i(),n("waitFor timed out.")}),this.waitForTimeoutInMilliseconds),o=this._windows[e];o?(clearTimeout(r),t(o)):i=this.onReadyWindow((n=>{n.API.id===e&&(clearTimeout(r),i(),t(n))}))}))}onReadyWindow(e){return this._registry.add("on-ready",e)}onAdded(e){return this._registry.add("on-added",e)}onRemoved(e){return this._registry.add("on-removed",e)}markReadyToShow(e){this._pendingWindows[e]&&(this._windows[e]=this._pendingWindows[e],delete this._pendingWindows[e],delete this._pendingWindowsStates[e]),this._registry.execute("on-ready",this._windows[e])}};class Kn{static getGDMajorVersion(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;const e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?-1:e}static callbackifyPromise(e,t,n){const i=e=>{let t=e;if(e instanceof Error&&(t=e.message),"function"!=typeof n)return Promise.reject(t);n(t)};try{return e().then((e=>("function"==typeof t&&t(e),e))).catch((e=>i(e)))}catch(e){return i(e)}}static getMonitor(e,t){return t.map((t=>{const{left:n,top:i,workingAreaWidth:r,workingAreaHeight:o}=t;return{monitor:t,totalOverlap:this.calculateTotalOverlap({left:n,top:i,width:r,height:o},e)}})).sort(((e,t)=>t.totalOverlap-e.totalOverlap))[0].monitor}static getDisplayCenterOfScreen(e,t){const n=Math.floor(Math.max(t.left,t.left+(t.workingAreaWidth-e.width)/2));return{top:Math.floor(Math.max(t.top,t.top+(t.workingAreaHeight-e.height)/2)),left:n}}static calculateTotalOverlap(e,t){const n=e.left,i=e.top,r=n+e.width,o=i+e.height,s=t.left,a=t.top,c=s+t.width,d=a+t.height;return Math.max(0,Math.min(r,c)-Math.max(n,s))*Math.max(0,Math.min(o,d)-Math.max(i,a))}}class Qn{constructor(e,t){this.windowId=e,this._categoryTitle=t.title}list(){return zn.getActions(this.windowId,this._categoryTitle)}create(e){return zn.createActions(this.windowId,this._categoryTitle,e)}remove(e){return zn.removeActions(this.windowId,this._categoryTitle,e)}}class Zn{constructor(e){this.windowId=e}list(){return this.getCategories()}create(e,t){return zn.createCategory(this.windowId,e,t)}remove(e){return zn.removeCategory(this.windowId,e)}async find(e){return(await this.getCategories()).find((t=>t.title===e))}async getCategories(){const e=[];return(await zn.getJumpListSettings(this.windowId)).categories.forEach((t=>{e.push({title:t.title,actions:new Qn(this.windowId,t)})})),e}}class Xn{constructor(e){this.windowId=e,this._categories=new Zn(e)}get categories(){return this._categories}async isEnabled(){return(await zn.getJumpListSettings(this.windowId)).enabled}setEnabled(e){return zn.setEnabled(this.windowId,e)}}var Yn=(e,t,n,i,r,o,s,a)=>{var c,d,u,h;const l=fn(),p=i.subLogger(`window ${e}`),g=()=>{const e=s();if(!e)throw new Error("To use this method you need to enable channels API - set the channels property to true when initializing the Glue42 library");return e};let f;const y=e,m=t.name,v=t.mode;let w,b=t.bounds,_=t.url,I=t.title,C=null!==(c=t.context)&&void 0!==c?c:{},A=t.frameColor,x=t.focus,T=null!==(d=t.neighbours)&&void 0!==d?d:{},k=t.groupId,S=t.isGroupHeaderVisible,P=t.isTabHeaderVisible,M=null!==(u=t.isTabSelected)&&void 0!==u&&u,E=t.settings,R=t.isVisible,j=t.isSticky,W=t.isCollapsed,O=t.state,N=t.tabGroupId,F=t.tabIndex,L=t.frameId,D=t.isLocked,G=null!==(h=t.frameButtons)&&void 0!==h?h:[],B=t.zoomFactor,q=t.placementSettings;const H=new Xn(e);function U(e,t,i){return Kn.callbackifyPromise((()=>{if(_t(e))throw new Error("The properties of `bounds` cannot be null or undefined.");return n.moveResize(f,e)}),t,i)}function V(e,t,i){return Kn.callbackifyPromise((()=>n.setVisible(f,e)),t,i)}function J(e){return z("group-changed",e)}function z(e,t,n){if(!At(t))throw new Error("callback must be a function");return l.add(e,t,n)}function $(e){const t=T[e];if(void 0!==t)return t.reduce(((e,t)=>{const n=$n.get(t);return n&&e.push(n.API),e}),[])}function K(){var t;if(C._APPLICATION_NAME)return C._APPLICATION_NAME;if(C&&C._t42&&C._t42.application)return C._t42.application;const n=Q();if(n)return n.applicationName;const i=r();if(i){const n=i.instances().find((t=>e===t.id));if(n)return null===(t=n.application)||void 0===t?void 0:t.name}}function Q(){if("undefined"!=typeof window&&window.glue42gd&&window.glue42gd.getWindowInfo){const t=window.glue42gd.getWindowInfo(e);return t||void 0}}f={get id(){return y},get name(){return m},get application(){const e=r();return e?e.application(K()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){if("undefined"!=typeof window&&window.glue42gd)return a.servers().find((e=>e.windowId===this.id));const e=K();return e?{application:e}:void 0},get url(){return _},get title(){return I},get windowStyleAttributes(){return E},get settings(){return E},get tabGroupId(){return"tab"===v.toLowerCase()?N:void 0},get tabIndex(){return"tab"===v.toLowerCase()?F:void 0},get frameId(){return L},get frameButtons(){return G},get mode(){return v},get state(){return O},get isCollapsed(){return W},get isVisible(){return R},get isLocked(){return D},get context(){return C},get bounds(){return b},get minHeight(){return E.minHeight},get maxHeight(){return E.maxHeight},get minWidth(){return E.minWidth},get maxWidth(){return E.maxWidth},get isFocused(){return x},get frameColor(){return A},get opened(){return void 0!==f.id},get group(){return w},get groupId(){return k},get isSticky(){return j},get topNeighbours(){return $("top")},get leftNeighbours(){return $("left")},get rightNeighbours(){return $("right")},get bottomNeighbours(){return $("bottom")},get isGroupHeaderVisible(){return S},get activityId(){if(C._t42)return C._t42.activityId;const e=Q();return e?e.activityId:void 0},get activityWindowId(){if(C._t42)return C._t42.activityWindowId;const e=Q();return e?e.activityWindowId:void 0},get windowType(){return t.windowType||"electron"},get zoomFactor(){return B},get screen(){if("undefined"!=typeof window&&window.glue42gd)return Kn.getMonitor(f.bounds,window.glue42gd.monitors)},get placementSettings(){return Object.assign({},q)},get jumpList(){return H},maximize:function(e,t){return Kn.callbackifyPromise((()=>"maximized"===O?Promise.resolve(f):n.maximize(f)),e,t)},restore:function(e,t){return Kn.callbackifyPromise((()=>"normal"===O?Promise.resolve(f):n.restore(f)),e,t)},minimize:function(e,t){return Kn.callbackifyPromise((()=>"minimized"===O?Promise.resolve(f):n.minimize(f)),e,t)},maximizeRestore:function(e,t){return Kn.callbackifyPromise((()=>n.maximizeRestore(f)),e,t)},collapse:function(e,t){return Kn.callbackifyPromise((()=>W?Promise.resolve(f):n.collapse(f)),e,t)},expand:function(e,t){return Kn.callbackifyPromise((()=>W?n.expand(f):Promise.resolve(f)),e,t)},toggleCollapse:function(e,t){return Kn.callbackifyPromise((()=>n.toggleCollapse(f)),e,t)},focus:function(e,t){return Kn.callbackifyPromise((()=>x?Promise.resolve(f):n.focus(f)),e,t)},activate:function(e,t){return Kn.callbackifyPromise((()=>x?Promise.resolve(f):n.activate(f)),e,t)},moveResize:U,setTitle:function(e,t,i){return Kn.callbackifyPromise((()=>{if(_t(e))throw new Error("`newTitle` must not be null or undefined.");return e===I?Promise.resolve(f):n.setTitle(f,e)}),t,i)},setStyle:function(e,t,i){return Kn.callbackifyPromise((()=>{if(!e||0===Object.keys(e).length||Object.keys(e).every((e=>!e)))throw new Error("Invalid style arguments: "+JSON.stringify(e));if(e&&void 0!==e.focus){if("boolean"!=typeof e.focus)throw new Error("Focus must be a boolean value. Currently, only `focus: true` is supported.");!1===e.focus&&p.warn("`focus: false` is not supported!")}if(e&&void 0!==e.hidden&&"boolean"!=typeof e.hidden)throw new Error("The `hidden` property must hold a boolean value.");for(const t of["minHeight","maxHeight","minWidth","maxWidth"]){const n=e,i=n[t];if(t in e){if(_t(i)){delete n[t];continue}if(!yt(n[t]))throw new Error(`"${t}" must be a number`)}}return n.setStyle(f,e)}),t,i)},setOnTop:function(e,t,i){return Kn.callbackifyPromise((()=>{if("boolean"!=typeof e)throw new Error("`onTop` must hold a boolean value.");return n.setOnTop(f,e)}),t,i)},resetButtons:function(e,t,i){return Kn.callbackifyPromise((()=>n.resetButtons(f,e)),t,i)},setSizeConstraints:function(e,t,i){return Kn.callbackifyPromise((()=>{if(!e||Object.keys(e).every((e=>void 0===e)))throw new Error("The properties of `constraints` cannot be null or undefined.");return n.setSizeConstraints(f,e)}),t,i)},navigate:function(e,t,i){return Kn.callbackifyPromise((()=>{if(It(e))throw new Error("The new URL must be a non-empty string.");return n.navigate(f,e)}),t,i)},addFrameButton:function(e,t,i){return Kn.callbackifyPromise((()=>{if(void 0===e||0===Object.keys(e).length)throw new Error("Button info is not available.");if(It(e.buttonId))throw new Error("`buttonId` must not be null or undefined.");if(It(e.imageBase64))throw new Error("`imageBase64` must not be null or undefined.");return n.addFrameButton(f,e)}),t,i)},removeFrameButton:function(e,t,i){return Kn.callbackifyPromise((()=>{if(It(e))throw new Error("`buttonId` must not be null or undefined.");return n.removeFrameButton(f,e)}),t,i)},setVisible:V,show:()=>V(!0),hide:()=>V(!1),center:e=>U(Kn.getDisplayCenterOfScreen(f.bounds,e||f.screen)),close:function(t,i){return Kn.callbackifyPromise((()=>{if(!e)throw new Error("The window is already closed.");return n.close(f)}),t,i)},snap:function(e,t,i,r){return Kn.callbackifyPromise((()=>{if(_t(e))throw new Error(`A target window is not specified - ${e}`);if("string"==typeof e){const t=$n.get(e);if(!t)throw new Error(`Invalid "target" parameter or no such window. Invoked with: ${e}`);e=t.API}return n.snap(f,e,t)}),i,r)},showLoader:function(e){return n.showLoader(f,e)},hideLoader:function(){return n.hideLoader(f)},updateContext:function(e,t,i){return Kn.callbackifyPromise((()=>{if(_t(e))throw new Error('"context" must not be null or undefined.');return n.updateContext(f,e,!1)}),t,i)},lock:function(e,t){return Kn.callbackifyPromise((()=>n.lock(f)),e,t)},unlock:function(e,t){return Kn.callbackifyPromise((()=>n.unlock(f)),e,t)},getIcon:function(e,t){return Kn.callbackifyPromise((()=>n.getIcon(f)),e,t)},setIcon:function(e,t,i){return Kn.callbackifyPromise((()=>{if(It(e))throw new Error('"base64Image" must be a non-empty string.');return n.setIcon(f,e)}),t,i)},setFrameColor:function(e,t,i){return Kn.callbackifyPromise((()=>{if(It(e))throw new Error('"frameColor" must be a non-empty string');return n.setFrameColor(f,e)}),t,i)},setTabTooltip:async function(e){if(It(e))throw new Error(`"${e}" must not be null or undefined`);return n.setTabTooltip(f,e)},attachTab:function(e,t,i,r){return Kn.callbackifyPromise((()=>{var i;const r='Invalid "tab" parameter - must be an object with an "id" property or a string. Invoked for source window with ID:';if(_t(e))throw new Error(r+e);let o;if("string"==typeof e){if(o=null===(i=$n.get(e))||void 0===i?void 0:i.API,_t(o))throw new Error(r+o)}else{if(_t(e.id))throw new Error(r);o=e}const s={};return _t(t)||("number"==typeof t?s.index=t:(s.selected=t.selected,s.index=t.index)),n.attachTab(f,o,s)}),i,r)},detachTab:function(e={},t,i){return Kn.callbackifyPromise((()=>{const t={};return void 0!==e.relativeTo?("string"==typeof e.relativeTo?t.relativeTo=e.relativeTo:_t(e.relativeTo.id)||(t.relativeTo=e.relativeTo.id),_t(e.relativeDirection)||(t.relativeDirection=e.relativeDirection),_t(e.width)||(t.width=e.width),_t(e.height)||(t.height=e.height)):_t(e.bounds)||(t.bounds=e.bounds),_t(e.hideTabHeader)||(t.hideTabHeader=e.hideTabHeader),n.detachTab(f,t)}),t,i)},setTabHeaderVisible:function(e,t,i){return Kn.callbackifyPromise((()=>{if("boolean"!=typeof e)throw new Error('"toBeTabHeaderVisible" must hold a boolean value.');return n.setTabHeaderVisible(f,e)}),t,i)},showPopup:function(e){return n.showPopup(f,e)},createFlydown:function(e){return n.createFlydown(f.id,e)},setModalState:function(e){return n.setModalState(f.id,e||!1)},setZoomFactor:function(e,t,i){return Kn.callbackifyPromise((()=>{if(isNaN(e))throw new Error("zoomFactor is not a number");return n.setZoomFactor(f,e)}),t,i)},zoomIn:function(e,t){return Kn.callbackifyPromise((()=>n.zoomIn(f)),e,t)},zoomOut:function(e,t){return Kn.callbackifyPromise((()=>n.zoomOut(f)),e,t)},showDevTools:function(){return n.showDevTools(f)},capture:function(e){return n.capture(f,e)},flash:function(e,t){const i={shouldFlash:!0,mode:"auto"};return"boolean"==typeof e&&(i.shouldFlash=e),void 0!==t&&(i.mode=t),n.flash(f,i)},setSticky:function(e,t,i){return Kn.callbackifyPromise((()=>{if("boolean"!=typeof e)throw new Error("`isSticky` must hold a boolean value.");return n.setSticky(f,e)}),t,i)},print:function(e){return n.print(f,e)},printToPDF:function(e){return n.printToPDF(f,e)},place:function(e){return n.place(f,e)},ungroup:function(t){return new Promise(((i,r)=>{const o=J(((t,n,r)=>{e===t.id&&(o(),i(f))}));n.ungroup(f,t).catch((e=>{o(),r(e)}))}))},refresh:function(e){return n.refresh(f,e)},download:function(e,t){return n.download(f,e,t)},configure:function(e){return n.configureWindow(f,e)},getChannel:async()=>{var e;return null===(e=(await g().getWindowsWithChannels({windowIds:[y]}))[0])||void 0===e?void 0:e.channel},onClose:function(t){if(!At(t))throw new Error("callback should be a function");return void 0===e&&t(f),l.add("onClose",t)},onUrlChanged:function(e){return z("onUrlChanged",e)},onTitleChanged:function(e){return z("onTitleChanged",e,[f.title,f])},onFrameButtonAdded:function(e){return z("onFrameButtonAdded",e)},onFrameButtonRemoved:function(e){return z("onFrameButtonRemoved",e)},onFrameButtonClicked:function(e){return z("onFrameButtonClicked",e)},onCollapsed:function(e){if(!At(e))throw new Error("callback should be a function");return W&&e(f),l.add("collapsed",e)},onExpanded:function(e){if(!At(e))throw new Error("callback should be a function");return W||e(f),l.add("expanded",e)},onMinimized:function(e){return"minimized"===O?z("minimized",e,[f]):z("minimized",e)},onMaximized:function(e){return"maximized"===O?z("maximized",e,[f]):z("maximized",e)},onNormal:function(e){return"normal"===O?z("normal",e,[f]):z("normal",e)},onAttached:function(e){return z("attached",e)},onDetached:function(e){return z("detached",e)},onVisibilityChanged:function(e){return z("visibility-changed",e)},onContextUpdated:function(e){return z("context-updated",e)},onLockingChanged:function(e){return z("lock-changed",e)},onBoundsChanged:function(e){return z("bounds-changed",e)},onFrameColorChanged:function(e){return z("frame-color-changed",e)},onFocusChanged:function(e){return z("focus-changed",e)},onStickyChanged:function(e){return z("sticky-changed",e)},onGroupChanged:J,onWindowAttached:function(e){return z("window-attached",e)},onWindowDetached:function(e){return z("window-detached",e)},onTabSelectionChanged:function(e){return z("tab-selection-changed",e)},onTabHeaderVisibilityChanged:function(e){return z("tab-header-visibility-changed",e)},onClosing:function(t){if(!At(t))throw new Error("callback must be a function");return n.onClosing(((e,n)=>{const i=t();i&&i.then?i.then(e).catch(n):e()}),e)},onRefreshing:function(t){if(!At(t))throw new Error("callback must be a function");return n.onRefreshing(((e,n,i)=>{const r=t(i);r&&r.then?r.then(e).catch(n):e()}),e)},onZoomFactorChanged:function(e){return z("zoom-factor-changed",e)},onPlacementSettingsChanged:function(e){return z("placementSettingsChanged",e)},onNeighboursChanged:function(e){return z("neighbours-changed",e)},onNavigating:function(t){if(!At(t))throw new Error("callback must be a function");return n.onNavigating(((e,n,i,r)=>{const o=t(r);o&&o.then?o.then(e).catch(n):e()}),e)},get tabs(){return function(){const e=$n.list;return"tab"!==v.toLowerCase()?[]:Object.keys(e).reduce(((t,n)=>{const i=e[n];return i&&i.API.tabGroupId&&void 0!==i.API.tabGroupId&&void 0!==f.tabGroupId&&i.API.tabGroupId===f.tabGroupId&&t.push(i.API),t}),[]).sort(((e,t)=>{if(e.tabIndex!==t.tabIndex){if(-1===e.tabIndex)return Number.MAX_SAFE_INTEGER;if(-1===t.tabIndex)return Number.MIN_SAFE_INTEGER}return e.tabIndex-t.tabIndex}))}()},get isTabHeaderVisible(){return P},get isTabSelected(){return M},getURL:()=>Promise.resolve(_),getTitle:()=>Promise.resolve(I),getBounds:()=>Promise.resolve(b),getContext:()=>Promise.resolve(C),setContext(e){if(_t(e))throw new Error('"context" must not be null or undefined, set to empty object if you want to clear it out.');return n.updateContext(f,e,!0)},getDisplay:()=>o().getByWindowId(e),resizeTo:(e,t)=>U({width:e,height:t}),moveTo:(e,t)=>U({top:e,left:t}),async getParentWindow(){var e;const t=E.parentInstanceId;if(t)return null===(e=$n.list[t])||void 0===e?void 0:e.API},getChildWindows:async()=>Object.keys($n.list).map((e=>$n.list[e].API)).filter((t=>t.settings.parentInstanceId===e)),joinChannel:t=>g().join(t,e),leaveChannel:()=>g().leave(e)};return{API:f,Events:{handleUpdate:function(e){_=e.url,I=e.title,C=e.context||{},b=e.bounds,A=e.frameColor,x=e.focus,T=e.neighbours||{},k=e.groupId,S=e.isGroupHeaderVisible,P=e.isTabHeaderVisible,M=e.isTabSelected,E=e.settings,R=e.isVisible,j=e.isSticky,W=e.isCollapsed,O=e.state,N=e.tabGroupId,L=e.frameId,D=e.isLocked,B=e.zoomFactor,q=e.placementSettings},handleWindowClose:function(){void 0!==e&&(l.execute("onClose",f),e=void 0)},handleWindowChangeState:async function(e){"collapsed"===e?W=!0:"expanded"===e?W=!1:O=e,await n.finished,l.execute(e,f)},handleTitleChanged:function(e){I=e,n.finished.finally((()=>{l.execute("onTitleChanged",e,f)}))},handleVisibilityChanged:function(e){e!==R&&(R=e,l.execute("visibility-changed",f))},handleUrlChanged:function(e){_=e,l.execute("onUrlChanged",e,f)},handleWindowSettingsChanged:function(e){E=e,l.execute("settings-changed",f)},handleContextUpdated:function(e){C=e,l.execute("context-updated",C,f)},handleFrameIsLockedChanged:function(e){D=e,l.execute("lock-changed",f)},handleBoundsChanged:function(e){b.top===e.top&&b.left===e.left&&b.width===e.width&&b.height===e.height||(b=e,l.execute("bounds-changed",f))},handleFocusChanged:function(e){x=e,l.execute("focus-changed",f)},handleFrameButtonAdded:function(e){const t=["buttonId","imageBase64","order","tooltip"].reduce(((t,n)=>(t[n]=e[n],t)),{});-1===G.map((e=>e.buttonId)).indexOf(e.buttonId)&&G.push(t),l.execute("onFrameButtonAdded",t,f)},handleFrameButtonRemoved:function(e){let t;G=G.reduce(((n,i)=>(i.buttonId===e?t=i:n.push(i),n)),[]),void 0!==t&&l.execute("onFrameButtonRemoved",t,f)},handleFrameButtonClicked:function(e){const t=G.filter((t=>t.buttonId===e.buttonId));t.length>0&&l.execute("onFrameButtonClicked",t[0],f)},handleFrameColorChanged:function(e){A=e,l.execute("frame-color-changed",f)},handleFrameAttached:function(e,t,n){N=e,L=t,P=n,l.execute("frame-attached",f)},handleFrameSelectionChanged:async function(t,i){let r;t===e?(M=!0,r=f):(M=!1,r=$n.get(t)?$n.get(t).API:void 0);const o=$n.get(i)?$n.get(i).API:void 0;await n.finished,l.execute("tab-selection-changed",r,o,f)},handleCompositionChanged:function(e){T=e.neighbors||{},F=e.index,l.execute("neighbours-changed",T,f)},handleGroupHeaderVisibilityChanged:function(e){S=e},handleTabHeaderVisibilityChanged:function(e){P!==e&&(P=e,l.execute("tab-header-visibility-changed",f))},handleGroupChanged:function(e,t){w=e,k=null==e?void 0:e.id,_t(e)||_t(t)||l.execute("group-changed",f,e,t)},handleAttached:async function(e,t,i,r,o){N=e,P=i,L=t,void 0!==r&&(D=r),await n.finished,o.forEach((e=>{e.Events.handleWindowAttached(f)})),l.execute("attached",f)},handleDetached:async function(e,t){N=void 0,M=!1,void 0!==e&&(D=e),await n.finished,t.forEach((e=>{e.Events.handleWindowDetached(f)})),l.execute("detached",f)},handleWindowAttached:function(e){l.execute("window-attached",e)},handleWindowDetached:function(e){l.execute("window-detached",e)},handleZoomFactorChanged:function(e){B=e,l.execute("zoom-factor-changed",f)},handleIsStickyChanged:function(e){j=e,l.execute("sticky-changed",e,f)},handlePlacementSettingsChanged:function(e){let t;const n=e;if(n.display){const e=o();if(e){const i=n.display-1;t=new Promise(((t,n)=>{e.all().then((e=>{const n=e.find((e=>e.index===i));t(n)})).catch(n)}))}else t=Promise.resolve(void 0)}else t=Promise.resolve(void 0);t.then((e=>{n.display=e,q=n,l.execute("placementSettingsChanged",f)}))}}}};var ei=new class{constructor(){this._registry=fn(),this._finished=Promise.resolve()}get hostInstance(){return this.agmTarget}get finished(){return this._finished}init(e,t){this.agm=e,this.agmTarget=t}handleEvent(e){this._registry.execute("event",e)}async open(e){let t;this._finished=new Promise((e=>{t=e}));try{const n=await this.agm.invoke("T42.Wnd.Create",e,this.agmTarget);if(void 0===n.returned)throw new Error("failed to execute T42.Wnd.Create - unknown reason");const i=n.returned.id,r=await $n.waitFor(i);return setTimeout((()=>{"electron"===r.API.windowType&&r.Events.handleUrlChanged(r.API.url)}),0),r.API}catch(e){throw e}finally{t()}}async close(e){return await this.execute("close",{windowId:e.id},"Closed"),e}async navigate(e,t){return await this.execute("navigate",{windowId:e.id,options:{url:t}},"UrlChanged"),e}async setStyle(e,t){var n;const i=[],r=e=>i.push(e);if(_t(t.focus)||e.isFocused||r(e.focus()),!_t(t.hidden)){const n=!t.hidden;r(e.setVisible(n))}if(_t(t.onTop)||r(e.setOnTop(t.onTop)),!It(t.tabTooltip)||!It(t.tabToolTip)){const i=null!==(n=t.tabTooltip)&&void 0!==n?n:t.tabToolTip;r(e.setTabTooltip(i))}It(t.tabTitle)||r(this.execute("setTabTitle",{windowId:e.id,options:{tabTitle:t.tabTitle}}));const{maxWidth:o,maxHeight:s,minWidth:a,minHeight:c,allowClose:d,allowCollapse:u,allowLockUnlock:h,allowMaximize:l,allowMinimize:p}=t;return r(e.setSizeConstraints({maxWidth:o,maxHeight:s,minWidth:a,minHeight:c})),r(e.resetButtons({allowClose:d,allowCollapse:u,allowLockUnlock:h,allowMaximize:l,allowMinimize:p})),await Promise.all(i),e}async setSizeConstraints(e,t){return await this.execute("setSizeConstraints",{windowId:e.id,options:t}),e}async setTabTooltip(e,t){return await this.execute("setTabTooltip",{windowId:e.id,options:{tabTooltip:t}}),e}async resetButtons(e,t){return await this.execute("resetButtons",{windowId:e.id,options:t}),e}async setOnTop(e,t){return await this.execute("setOnTop",{windowId:e.id,options:{onTop:t}}),e}async setTitle(e,t){const n={windowId:e.id,options:{title:t}};return await this.execute("setTitle",n,"TitleChanged"),e}async setSticky(e,t){const n={windowId:e.id,options:{isSticky:t}};return await this.execute("setSticky",n),e}async moveResize(e,t){return"undefined"!=typeof window&&window.glueDesktop.versionNum<31200?new Promise((async(n,i)=>{const r=this.areBoundsEqual(t,e);let o=!1;const s=()=>{o||(o=!0,c&&(c(),c=void 0),n(e),a&&(clearTimeout(a),a=void 0))};let a,c;r||(c=e.onBoundsChanged((e=>{this.areBoundsEqual(t,e)&&s()})));try{await this.execute("moveResize",{windowId:e.id,options:{bounds:t}})}catch(e){return void i(e)}r?s():a=setTimeout((()=>{s()}),1e3)})):(await this.execute("moveResize",{windowId:e.id,options:{bounds:t}}),e)}async addFrameButton(e,t){return await this.execute("addButton",{windowId:e.id,options:t},"ButtonAdded"),e}async removeFrameButton(e,t){return await this.execute("removeButton",{windowId:e.id,options:t},"ButtonRemoved"),e}async activate(e){let t;try{const n=new Promise(((n,i)=>{t=e.onFocusChanged((()=>{n()}))}));return await Promise.all([this.execute("activate",{windowId:e.id},"FocusChanged"),n]),e}catch(e){throw e}finally{t&&t()}}async focus(e){let t;try{const n=new Promise(((n,i)=>{t=e.onFocusChanged((()=>{n()}))}));return await Promise.all([this.execute("focus",{windowId:e.id},"FocusChanged"),n]),e}catch(e){throw e}finally{t&&t()}}async maximizeRestore(e){return await this.execute("maximizeRestore",{windowId:e.id},"StateChanged"),e}async maximize(e){return await this.execute("maximize",{windowId:e.id},"StateChanged"),e}async restore(e){return await this.execute("restore",{windowId:e.id},"StateChanged"),e}async minimize(e){return await this.execute("minimize",{windowId:e.id},"StateChanged"),e}async collapse(e){return await this.execute("collapse",{windowId:e.id},"StateChanged"),e}async expand(e){return await this.execute("expand",{windowId:e.id},"StateChanged"),e}async toggleCollapse(e){return await this.execute("toggleCollapse",{windowId:e.id},"StateChanged"),e}async snap(e,t,n){const i={targetWindowId:t.id};return n&&(i.snappingEdge=n),await this.execute("snap",{windowId:e.id,options:i},"CompositionChanged",`CompositionChanged-${t.id}`),e}async attachTab(e,t,n){return await this.execute("attachTab",{windowId:e.id,options:{index:n,sourceWindowId:t.id,targetWindowId:e.id}},`WindowFrameAdded-${t.id}`,`WindowFrameRemoved-${t.id}`),e}async detachTab(e,t){const n=["WindowFrameRemoved","WindowFrameAdded"];return _t(null==t?void 0:t.relativeTo)?n.push("BoundsChanged"):(n.push("CompositionChanged"),n.push(`CompositionChanged-${t.relativeTo}`)),await this.execute("detachTab",{windowId:e.id,options:t},...n),e}async setVisible(e,t=!0){let n;return n=t?"show":"hide",await this.execute(n,{windowId:e.id},"VisibilityChanged"),e}async showLoader(e,t){return await this.execute("showLoadingAnimation",{windowId:e.id,options:t}),e}async hideLoader(e){return await this.execute("hideLoadingAnimation",{windowId:e.id}),e}async updateContext(e,t,n){let i;try{const r=this.swapUndefinedToNull(t),o=new Promise(((t,n)=>{i=e.onContextUpdated((()=>{t()}))}));return await Promise.all([this.execute("updateContext",{windowId:e.id,context:r,replace:n}),o]),e}catch(e){throw e}finally{i&&i()}}async lock(e){return await this.execute("lockUnlock",{windowId:e.id,options:{lock:!0}},"FrameIsLockedChanged"),e}async unlock(e){return await this.execute("lockUnlock",{windowId:e.id,options:{lock:!1}},"FrameIsLockedChanged"),e}async getIcon(e){return(await this.execute("getIcon",{windowId:e.id,options:{}})).icon}async setIcon(e,t){return await this.execute("setIcon",{windowId:e.id,options:{dataURL:t}}),e}async setFrameColor(e,t){return await this.execute("setFrameColor",{windowId:e.id,options:{frameColor:t}},"FrameColorChanged"),e}async setTabHeaderVisible(e,t){return await this.execute("setTabHeaderVisible",{windowId:e.id,options:{toShow:t}},"TabHeaderVisibilityChanged"),e}async showPopup(e,t){if(!t)throw new Error("The options object is not valid!");const n={...t};n.targetLocation||(n.targetLocation="bottom");const i={...n,popupBounds:n.size,targetId:e.id,popupId:n.windowId};return await this.execute("showPopupWindow",{windowId:e.id,options:i}),e}async createFlydown(e,t){if(!t)throw new Error("The options object is not valid!");const n={...t};n.horizontalOffset||(n.horizontalOffset=0),n.verticalOffset||(n.verticalOffset=0);const i=this.reformatFlydownOptions(e,n);return this.execute("setFlydownArea",{windowId:e,options:i}).then((()=>{const e=i.zones.map((e=>e.id));return i.zones.forEach((e=>{let n="function"==typeof e.flydownSize?e.flydownSize:()=>e.flydownSize;t.size instanceof Function&&e.flydownSize&&(n=async(n,i)=>{let r;return t.size instanceof Function&&(r=await t.size(n,i)),e.flydownSize instanceof Function&&e.flydownSize!==t.size?await e.flydownSize(n,i)||r:r||e.flydownSize}),this._registry.clearKey(`${i.targetId}_${e.id}`),this._registry.add(`${i.targetId}_${e.id}`,n)})),{destroy:()=>this.clearFlydownArea(i.targetId,e),options:n}}))}async setModalState(e,t){return this.execute("setModalState",{windowId:e,options:{isModal:t}})}async handleFlydownBoundsRequested(e,t){const n={zoneId:t.flydownId,flydownWindowBounds:t.flydownWindowBounds,flydownWindowId:t.flydownWindowId},i=await Promise.all(this._registry.execute(`${e}_${t.flydownId}`,n,(()=>t.cancel=!0)));if(1===i.length){const e={height:0,width:0,top:0,left:0},n="object"!=typeof i[0]||Array.isArray(i[0])?e:i[0];return{...t,flydownWindowBounds:n}}}async zoomIn(e){return await this.execute("zoomIn",{windowId:e.id}),e}async zoomOut(e){return await this.execute("zoomOut",{windowId:e.id}),e}async setZoomFactor(e,t){return await this.execute("setZoomFactor",{windowId:e.id,options:{zoomFactor:t}}),e}async showDevTools(e){return await this.execute("showDevTools",{windowId:e.id}),e}async capture(e,t){return(await this.execute("captureScreenshot",{windowId:e.id,options:{...t}})).data}async captureGroup(e,t){return(await this.execute("captureGroupScreenshot",{windowId:e[0],options:{groupWindowIds:e,...t}})).data}async flash(e,t){return await this.execute("flash",{windowId:e.id,options:{...t}}),e}async configure(e,t){return this.execute("configure",{windowId:e,options:{...t}})}async print(e,t){return await this.execute("print",{windowId:e.id,options:{...t}}),e}async printToPDF(e,t){return(await this.execute("printToPDF",{windowId:e.id,options:{...t}})).filePath}async place(e,t){const n={...t};return t.display&&"current"!==t.display||(n.display=await e.getDisplay()),n.display=n.display.index+1,this.execute("place",{windowId:e.id,options:{...n}})}async refresh(e,t){return await this.execute("refresh",{windowId:e.id,options:{ignoreCache:t}}),e}async download(e,t,n={}){n.enableDownloadBar=!n.silent;const i=await this.execute("downloadURL",{windowId:e.id,options:{url:t,options:n}});return{url:t,path:i.fullPath,size:i.fileSize}}async configureWindow(e,t){return await this.execute("configureWindow",{windowId:e.id,options:t}),e}async execute(e,t,...n){const i={...t,command:e};let r;this._finished=new Promise((e=>{r=e}));try{return"undefined"!=typeof window&&window.glueDesktop.versionNum<31200?await this.executeWithoutToken(i,...n):await this.executeWithToken(i)}catch(e){throw e}finally{r()}}async ungroup(e,t){const n={windowId:e.id,options:t};return await this.execute("ungroup",n),e}async updateJumpList(e,t){const n={windowId:e,options:t};await this.execute("updateJumplist",n)}async getJumpList(e){const t={windowId:e};return await this.execute("getJumplist",t)}onClosing(e,t){const n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(e,t)}onRefreshing(e,t){const n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(e,t)}onNavigating(e,t){const n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addWillNavigateHandler(e,t)}reformatFlydownOptions(e,t){const n=(e,n)=>{if(t[n]&&(void 0===e[n]||null===e[n])){const i=t[n];e[n]=i}},i=t.zones.map((e=>(n(e,"windowId"),n(e,"targetLocation"),!t.size||void 0!==e.flydownSize&&null!==e.flydownSize||(e.flydownSize=t.size),e.flydownBounds=e.flydownSize,e.flydownId=e.windowId,e.targetLocation||(e.targetLocation="bottom"),e)));return{...t,zones:i,targetId:e,flydownBounds:t.size,flydownActiveArea:t.activeArea}}clearFlydownArea(e,t){return this.execute("clearFlydownWindowArea",{windowId:e,options:{}}).then((()=>{t.forEach((t=>{this._registry.clearKey(`${e}_${t}`)}))}))}executeWithoutToken(e,...t){const n=[],i=null==t?void 0:t.filter((e=>!_t(e))).map((t=>new Promise((i=>{const[r,o=e.windowId]=t.split("-");n.push(this._registry.add("event",(e=>{e.type===r&&e.windowId===o&&i()})))})))),r=new Promise(((t,n)=>{this.agm.invoke("T42.Wnd.Execute",e,this.agmTarget).then((e=>{e.returned&&e.returned.errorMsg?n(e):t(e.returned)})).catch((e=>n(e)))}));return Promise.all([r,...i]).then((e=>e[0])).finally((()=>{n.forEach((e=>e()))}))}async executeWithToken(e){let t;try{const n=Vn.generate(),i=new Promise((e=>{t=this._registry.add("event",(t=>{t.token===n&&e()}))})),r=new Promise(((t,i)=>{e.token=n,this.agm.invoke("T42.Wnd.Execute",e,this.agmTarget).then((e=>{e.returned&&e.returned.errorMsg?i(e):t(e.returned)})).catch((e=>{i(e)}))}));return(await Promise.all([r,i]))[0]}catch(e){throw e}finally{t&&t()}}areBoundsEqual(e,t){const n=t.bounds,i=t.settings;let r=e.height,o=e.width;e.height<i.minHeight&&(r=i.minHeight),e.height>i.maxHeight&&(r=i.maxHeight),e.width<i.minWidth&&(o=i.minWidth),e.width>i.maxWidth&&(o=i.maxWidth);const s=!r||n.height===r,a=!o||n.width===o,c=!e.left||n.left===e.left,d=!e.top||n.top===e.top;return s&&a&&c&&d}swapUndefinedToNull(e){try{const t={};for(const n of Object.keys(e)){let i=e[n];void 0===i&&(i=null),t[n]=i}return t}catch{return e}}};function ti(e,t){const n=$n.list;return Object.keys(n).reduce(((i,r)=>{const o=n[r];return o.API.tabGroupId===t&&o.API.id!==e&&i.push(o),i}),[])}class ni{constructor(e,t,n,i,r,o,s){this._registry=fn(),this._waitTimeout=1e4,this._agm=e,this._logger=t.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(o),this._windowId=s,this._appManagerGetter=n,this._displayAPIGetter=i,this._channelsAPIGetter=r}init(){return new Promise(((e,t)=>{void 0===this._agmInstance&&(this._agmInstance="best"),this._agm.registerAsync("T42.Wnd.OnEventWithResponse",((e,t,n,i)=>{this.respondToEvent(e).then(n).catch(i)})),new Promise(((n,i)=>{this._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:this._waitTimeout,target:this._agmInstance,onData:t=>{this.updateWindow(t.data,e),ei.handleEvent(t.data)},onConnected:e=>{this._agmInstance=this.normalizeInstance(e),ei.init(this._agm,this._agmInstance)}}).catch((e=>{t("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+e)}))}))}))}get executor(){return ei}open(e,t,n){n=n||{};const i={...n};return void 0!==i.relativeTo&&"string"!=typeof i.relativeTo&&(i.relativeTo=i.relativeTo.id||""),i.name=e,i.url=t,i.windowState=n.windowState||n.state,delete i.state,this.executor.open(i)}createFlydown(e,t){return this.executor.createFlydown(e,t)}async showPopup(e,t){const n=$n.get(e);await this.executor.showPopup(n.API,t)}tabAttached(e){return this._registry.add("tab-attached",e)}tabDetached(e){return this._registry.add("tab-detached",e)}onWindowFrameColorChanged(e){return this._registry.add("frame-color-changed",e)}onEvent(e){return this._registry.add("window-event",e)}my(){return this._windowId}execute(e,t,n){return this._agm.invoke("T42.Wnd.Execute",{command:e,options:n,windowId:t})}onCompositionChanged(e){return this._registry.add("composition-changed",e)}onGroupHeaderVisibilityChanged(e){return this._registry.add("group-header-changed",e)}onWindowGotFocus(e){return this._registry.add("got-focus",e)}onWindowLostFocus(e){return this._registry.add("lost-focus",e)}normalizeInstance(e){if(e)return{application:e.application,machine:e.machine,user:e.user}}respondToEvent(e){return"ShowFlydownBoundsRequested"===e.type?this.executor.handleFlydownBoundsRequested(e.data.windowId,e.data):Promise.reject(`There isn't a handler for ${e.type}`)}updateWindow(e,t){const n=this.getExtendedStreamEvent(e);if("Snapshot"===e.type){return e.windows.forEach((e=>{const t=$n.get(e.id);if(t)t.Events.handleUpdate(this.mapToWindowConstructorOptions(e));else{const t=this.createWindow(e.id,e);$n.markReadyToShow(t.API.id)}this._registry.execute("window-event",n)})),void t(this)}if("CommandExecuted"===e.type)return void this._registry.execute("window-event",n);if("Created"===e.type){const t=e,i=this.createWindow(t.windowId,t.data||{});return $n.setReadyState(i.API.id),void this._registry.execute("window-event",n)}const i=$n.get(e.windowId);if(!i)return void this._logger.error(`received update for unknown window. Stream:', ${JSON.stringify(e,null,4)}`);const r=i.API,o=i.Events;if("BoundsChanged"===e.type){const t=e;o.handleBoundsChanged(t.data)}if("UrlChanged"===e.type){const t=e;$n.setUrlChangedState(t.windowId),o.handleUrlChanged(t.data)}if("TitleChanged"===e.type){const t=e;o.handleTitleChanged(t.data)}if("IsStickyChanged"===e.type){const t=e;o.handleIsStickyChanged(t.data)}if("VisibilityChanged"===e.type&&o.handleVisibilityChanged(e.data),"ContextChanged"===e.type&&o.handleContextUpdated(e.data),"StateChanged"===e.type&&o.handleWindowChangeState(e.data),"FrameColorChanged"===e.type&&(o.handleFrameColorChanged(e.data),this._registry.execute("frame-color-changed",r)),"CompositionChanged"===e.type){const t=e;o.handleCompositionChanged(t.data),this._registry.execute("composition-changed",t.data)}if("GroupHeaderVisibilityChanged"===e.type){const t=e;o.handleGroupHeaderVisibilityChanged(t.data.groupHeaderVisible),this._registry.execute("group-header-changed",t.data)}if("FocusChanged"===e.type){const t=e;this.focusChanged(o,r,t.data)}if("WindowFrameChanged"===e.type&&(o.handleFrameAttached(e.data.frameId,e.data.frameId,e.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===e.type){const t=ti(r.id,e.data.frameId),n=e.data;o.handleAttached(n.frameId,n.frameId,n.isTabHeaderVisible,n.isLocked,t).then((async()=>{t.length>0&&(await ei.finished,this._registry.execute("tab-attached",r,e.data.frameId,e.data.isTabHeaderVisible))}))}if("WindowFrameRemoved"===e.type){const t=r.tabGroupId,n=ti(r.id,t);o.handleDetached(e.data.isLocked,n).then((async()=>{n.length>0&&(await ei.finished,this._registry.execute("tab-detached",r,e.data.frameId,r.tabGroupId))}))}"TabHeaderVisibilityChanged"===e.type&&o.handleTabHeaderVisibilityChanged(e.data.isTabHeaderVisible),"FrameSelectionChanged"===e.type&&o.handleFrameSelectionChanged(e.data.newWindowId,e.data.prevWindowId),"ButtonClicked"===e.type&&o.handleFrameButtonClicked(e.data),"ButtonAdded"===e.type&&o.handleFrameButtonAdded(e.data),"ButtonRemoved"===e.type&&o.handleFrameButtonRemoved(e.data),"WindowZoomFactorChanged"===e.type&&o.handleZoomFactorChanged(e.data),"Closed"===e.type&&($n.remove(i),o.handleWindowClose()),"FrameIsLockedChanged"===e.type&&o.handleFrameIsLockedChanged(e.data),"PlacementSettingsChanged"===e.type&&o.handlePlacementSettingsChanged(e.data),this._registry.execute("window-event",n)}createWindow(e,t){const n=Yn(e,this.mapToWindowConstructorOptions(t),ei,this._logger,this._appManagerGetter,this._displayAPIGetter,this._channelsAPIGetter,this._agm);return $n.add(n),n}focusChanged(e,t,n){e.handleFocusChanged(n),n?this._registry.execute("got-focus",t):this._registry.execute("lost-focus",t)}mapToWindowConstructorOptions(e){return{name:e.name,context:e.context,bounds:e.bounds,url:e.url,title:e.title,isVisible:e.isVisible,focus:e.isFocused,state:e.state,frameColor:e.frameColor,groupId:e.groupId,neighbours:e.neighbors,isFocused:e.isFocused,isGroupHeaderVisible:e.groupHeaderVisible,isCollapsed:e.isCollapsed,tabGroupId:e.frameId,frameId:e.frameId,mode:e.mode,isTabHeaderVisible:e.isTabHeaderVisible,isTabSelected:e.isActiveTab,settings:e.settings,windowType:e.windowType,zoomFactor:e.zoomFactor,isLocked:e.isLocked,placementSettings:e.placementSettings,isSticky:e.isSticky,tabIndex:e.tabIndex,frameButtons:e.frameButtons,jumpListOptions:e.jumpList}}getExtendedStreamEvent(e){try{if(!e.windowId)return e;const t=$n.get(e.windowId);if(!t)return e;const n={state:e.type,windowName:t.API.name,...e};return"WindowFrameAdded"===n.state&&(n.state="TabAttached"),"StateChanged"===n.state&&(n.state=n.data.charAt(0).toUpperCase()+n.data.slice(1)),"ButtonAdded"===n.state&&(n.state="FrameButtonAdded"),"ButtonRemoved"===n.state&&(n.state="FrameButtonRemoved"),n}catch(t){return e}}}var ii=(e,t)=>{const n=fn(),i=[];async function r(e,n,...i){return await t.execute(e,n,...i),a}function o(){const e=[];return i.forEach((t=>{const n=s(t);void 0!==n&&e.push(n)})),e}function s(e){return $n.get(e)?$n.get(e).API:void 0}const a={id:e,get windows(){return function(e){const t=o();return"function"==typeof e&&e(t),t}()},find:function(e,t,n){let i;"string"==typeof e?i=e:_t(e)||(i=e.id);const r=s(i);if(r)return"function"==typeof t&&t(r),r;"function"==typeof n&&n(`No window with ID: ${i}`)},get isHeaderVisible(){return void 0===o().find((e=>!e.isGroupHeaderVisible))},showHeader:(e,t)=>Kn.callbackifyPromise((()=>r("setGroupHeaderVisibility",{windowId:i[0],options:{toShow:!0}},...i.map((e=>`GroupHeaderVisibilityChanged-${e}`)))),e,t),hideHeader:(e,t)=>Kn.callbackifyPromise((()=>r("setGroupHeaderVisibility",{windowId:i[0],options:{toShow:!1}},...i.map((e=>`GroupHeaderVisibilityChanged-${e}`)))),e,t),getTitle:async()=>(await t.execute("getGroupTitle",{windowId:i[0]})).title,setTitle:async e=>{if(It(e))throw new Error("`title` must not be null or undefined.");return r("setGroupTitle",{windowId:i[0],options:{title:e}})},capture:e=>t.captureGroup(i,e),maximize:(e,t)=>Kn.callbackifyPromise((()=>r("maximizeGroup",{windowId:i[0]},...i.map((e=>`StateChanged-${e}`)))),e,t),restore:(e,t)=>Kn.callbackifyPromise((()=>r("restoreGroup",{windowId:i[0]},...i.map((e=>`StateChanged-${e}`)))),e,t),onHeaderVisibilityChanged:function(e){return n.add("header-visibility-changed",e)},onWindowAdded:function(e){return n.add("window-added",e)},onWindowRemoved:function(e){return n.add("window-removed",e)}};return{groupAPI:a,groupInternal:{get windows(){return i},addWindow:async function(e){if(-1===i.indexOf(e)){i.push(e);const r=$n.get(e);r.Events.handleGroupChanged(a,void 0),await t.finished,n.execute("window-added",a,r.API)}},removeWindow:async function(e){const r=i.indexOf(e.API.id);-1!==r&&(i.splice(r,1),e.Events.handleGroupChanged(void 0,a),await t.finished,n.execute("window-removed",a,e.API))},handleGroupHeaderVisibilityChanged:function(e){n.execute("header-visibility-changed",a)}}}},ri=(e,t)=>{const n=fn(),i={};let r=-1;const o=$n.list;function s(e,t,n){let r;"string"==typeof e?r=e:_t(e)||(r=e.id);const o=Object.values(i).find((e=>e.groupAPI.windows.filter((e=>e.id===r)).length));if(o)return"function"==typeof t&&t(o.groupAPI),o.groupAPI;"function"==typeof n&&n("Cannot find the group of the window.")}function a(t,n){const r=function(t){if(i.hasOwnProperty(t))return i[t];{const n=ii(t,e.executor);return i[t]=n,n}}(t);return r.groupInternal.addWindow(n),r}function c(e,t){e&&(e.groupInternal.removeWindow(t),function(e){0===e.groupAPI.windows.length&&delete i[e.groupAPI.id]}(e))}function d(e){let t;return"string"==typeof e?t=e:_t(e)||(t=e.id),Object.values(i).find((e=>e.groupInternal.windows.filter((e=>e===t)).length))}Object.keys(o).forEach((e=>{const t=o[e],n=t.API.groupId,i=t.API.id;It(n)||a(n,i)})),$n.onRemoved((e=>{c(d(e.API),e)})),e.onCompositionChanged((e=>{!function(e){const t=e.groupId,r=e.windowId,o=$n.get(r);if(!o)return;const s=d(o.API);if(_t(t))return void c(s,o);if(_t(s)&&!_t(t))return void a(t,o.API.id);s.groupAPI.id!==t&&function(e,t,r){const o=e.API.id,s=i[t];c(s,e);const d=a(r,o);e.Events.handleGroupChanged(d.groupAPI,s.groupAPI),n.execute("window-moved",o,t,r)}(o,s.groupAPI.id,t)}(e)})),e.onGroupHeaderVisibilityChanged((e=>{const t=s(e.windowId);if(void 0!==t){const n=i[t.id];-1===r&&(r=t.windows.length),r--,0===r&&(r=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(e))}}));return{groupsAPI:{get my(){return s(e.my())},list:function(e){const t=Object.keys(i).map((e=>{if(i[e])return i[e].groupAPI}));return"function"==typeof e&&e(t),t},findGroupByWindow:s},groupsEvents:{onWindowMoved:function(e){return n.add("window-moved",e)}}}},oi=(e,t,n,i,r,o)=>{const s=fn(),a=t;let c,d;$n.init(a);const u=new Promise(((t,s)=>{((e,t,n,i,r,o)=>{const s=t;return new Promise(((t,a)=>{if(2===o)throw s.trace("running in HC"),new Error("GD2 not supported");if(o>=3)s.trace("running in GD 3"),new ni(e,s,n,i,r,void 0,window.glue42gd.windowId).init().then(t).catch(a);else{const o=new ni(e,s,n,i,r).init(),c=e=>new Promise(((t,n)=>setTimeout((()=>{n("timeout waiting for streams")}),e)));Promise.race([o,c(1e4)]).then(t).catch(a)}}))})(e,a,n,i,r,o).then((n=>{d=n,c=ri(n),zn.init(n.executor,e,a),t()})).catch((e=>{const t=`Environment detector fails with: ${e}`;a.error(t),s(t)}))}));function h(){const e=$n.getIfReady(d.my());return e?e.API:void 0}function l(e){return s.add("window-added",e)}function p(e){return s.add("window-removed",e)}return $n.onReadyWindow((function(e){s.execute("window-added",e.API)})),$n.onRemoved((function(e){s.execute("window-removed",e.API)})),{my:h,open:function(e,t,n,i,r){return Kn.callbackifyPromise((()=>{if(It(e))throw new Error("The window name is missing.");if(It(t))throw new Error("The window URL is missing.");if(!_t(n)){const e=n;for(const t of["minHeight","maxHeight","minWidth","maxWidth","width","height","top","left"])if(t in e){const n=e[t];if(_t(n)){delete e[t];continue}if(!yt(n)){throw new Error(`${t} must be a number`)}if(("width"===e[t]||"height"===e[t])&&n<=0){throw new Error(`${t} must be a positive number`)}}}return d.open(e,t,n)}),i,r)},find:function(e,t,n){const i=$n.list,r=Object.keys(i).reduce(((t,n)=>{var r;const o=i[n];return(null===(r=null==o?void 0:o.API)||void 0===r?void 0:r.name)===e&&t.push(o.API),t}),[]);if(r[0])return"function"==typeof t&&t(r[0]),r[0];"function"==typeof n&&n("There is no window with name:"+e)},findById:function(e,t,n){const i=$n.list,r=Object.keys(i).reduce(((t,n)=>{const r=i[n];return void 0!==r&&r.API.id===e&&t.push(r.API),t}),[]);if(r[0])return"function"==typeof t&&t(r[0]),r[0];"function"==typeof n&&n("There is no window with such id:"+e)},list:function(e){const t=$n.list,n=Object.keys(t).map((e=>t[e].API));if("function"!=typeof e)return n;e(n)},ready:function(){return u},onWindowAdded:l,windowAdded:l,onWindowRemoved:p,windowRemoved:p,onTabAttached:function(e){let t,n=!1;return u.then((()=>{n||(t=d.tabAttached(e))})),()=>{n=!0,t&&t()}},onTabDetached:function(e){let t,n=!1;return u.then((()=>{n||(t=d.tabDetached(e))})),()=>{n=!0,t&&t()}},onWindowFrameColorChanged:function(e){let t,n=!1;return u.then((()=>{n||(t=d.onWindowFrameColorChanged(e))})),()=>{n=!0,t&&t()}},get groups(){return c.groupsAPI},onWindowGotFocus:function(e){let t,n=!1;return u.then((()=>{n||(t=d.onWindowGotFocus(e))})),()=>{n=!0,t&&t()}},onWindowLostFocus:function(e){let t,n=!1;return u.then((()=>{n||(t=d.onWindowLostFocus(e))})),()=>{n=!0,t&&t()}},onEvent:function(e){let t,n=!1;return u.then((()=>{n||(t=d.onEvent(e))})),()=>{n=!0,t&&t()}},createFlydown:function(e,t){return d.createFlydown(e,t)},showPopup:function(e,t){return d.showPopup(e,t)},configure:function(e){const t=h(),n=t?t.id:"";return ei.configure(n,e)}}};var si=new class{constructor(){this.layouts=[]}removeWhere(e){this.layouts=this.layouts.filter(e)}add(e){this.layouts.push(e)}get all(){return this.layouts}where(e){return this.layouts.filter(e)}first(e){return this.where(e)[0]}};class ai{constructor(e,t,n,i){this.config=e,this.activitiesGetter=t,this.callbacks=n,this.logger=i,this.interop=e.agm,this.registerRequestMethods()}onSaveRequested(e){return this.callbacks.add("saveRequested",e)}isActivityOwner(){if("undefined"!=typeof htmlContainer){const e=htmlContainer.getContext();return e&&e._t42&&e._t42.activityIsOwner}const e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;const t=e.my.window,n=e.my.activity;return!(!n&&!t)&&n.owner.id===t.id}registerRequestMethods(){this.interop.register("T42.HC.GetSaveContext",(e=>{const t=this.callbacks.execute("saveRequested",e);(null==t?void 0:t.length)>1&&this.logger.warn('Multiple subscriptions for "glue.layouts.onSaveRequested" - only the first one will be used');const n=t[0],i=this.config.autoSaveWindowContext;if("boolean"==typeof i&&i)return{autoSaveWindowContext:i};if(Array.isArray(i)&&i.length>0)return{autoSaveWindowContext:i};const r={windowContext:null==n?void 0:n.windowContext,activityContext:void 0};return this.isActivityOwner()&&(r.activityContext=null==n?void 0:n.activityContext),r}))}}function ci(e){if(!e)return e;if(Array.isArray(e))return e.map((e=>ci(e)));if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;return Object.keys(e).reduce(((t,n)=>{const i=ci(e[n]);let r=n;return n[0].toLowerCase()!==n[0]&&(r=n[0].toLowerCase()+n.substr(1)),t[r]=i,t}),{})}class di{constructor(e){this.name=e.name,this.type=e.type,this.components=e.components,this.context=e.context,this.metadata=e.metadata,this.version=e.version,this.displays=e.displays}}class ui{constructor(e,t,n,i){this.config=e,this.stream=t,this.callbacks=n,this.appManager=e.appManager,this.onEvent=t.onEvent,this.provider=new ai(e,e.activityGetter,n,i),t.subscribe()}async setDefaultGlobal(e){await this.config.agm.invoke("T42.ACS.SelectDefaultLayout",{name:e})}async clearDefaultGlobal(){await this.config.agm.invoke("T42.ACS.DeselectDefaultLayout")}async getDefaultGlobal(){const e=(await this.config.agm.invoke("T42.ACS.GetDefaultLayout")).returned;if(e)return this.isSlimMode()?e:this.list().find((t=>t.name===e.name&&"Global"===t.type))}ready(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready}save(e){return new Promise(((t,n)=>{var i,r;if(this.verifyNotSlimMode(),_t(e))return n(new Error("layout is required"));if(It(e.name))return n(new Error("layout.name argument is required"));It(e.type)&&(e.type="Global"),It(e.activityId)||(e.type="Activity");const o={name:e.name,type:e.type,context:null!==(i=e.context)&&void 0!==i?i:{},metadata:null!==(r=e.metadata)&&void 0!==r?r:{},options:{}};if("Activity"===e.type){let t=e.activityId;if(!t){if(!this.appManager.myInstance.inActivity)return n(new Error("Current application is not in activity. Cannot save activity layout for it."));t=this.appManager.myInstance.activityId}o.activityId=t}else{if("Global"!==e.type)return n(new Error(`layout type ${e.type} is not supported`));Array.isArray(e.ignoreInstances)&&(o.options.ignoreInstances=e.ignoreInstances),Array.isArray(e.instances)&&(o.options.instances=e.instances)}this.invokeMethodAndTrack("T42.ACS.SaveLayout",o,t,n)}))}restore(e){return new Promise(((t,n)=>{var i,r;if(this.verifyNotSlimMode(),_t(e))return n(new Error("options argument is required"));if(It(e.name))return n(new Error("options.name argument is required"));if(It(e.type)&&(e.type="Global"),It(e.activityIdToJoin)||(e.type="Activity"),"Activity"===e.type){if(_t(e.setActivityContext)&&(e.setActivityContext=!0),"boolean"!=typeof e.setActivityContext)return n(new Error("`setActivityContext` must hold a boolean value."));e.activityIdToJoin=null!==(i=e.activityIdToJoin)&&void 0!==i?i:this.appManager.myInstance.activityId}if(_t(e.closeRunningInstance)||(e.closeRunningInstances=e.closeRunningInstance),_t(e.closeRunningInstances)&&(e.closeRunningInstances=!0),!Ct(e.closeRunningInstances))return n(new Error("`closeRunningInstances` must hold a boolean value."));if(_t(e.closeMe)&&(e.closeMe=e.closeRunningInstances),!Ct(e.closeMe))return n(new Error("`closeMe` must hold a boolean value."));if(!_t(e.context)&&!vt(e.context))return n(new Error("`context` must hold an object value."));if(!_t(e.timeout)&&"number"!=typeof e.timeout)return n(new Error("`timeout` must hold an number value."));e.context=null!==(r=e.context)&&void 0!==r?r:{};const o={activityToJoin:e.activityIdToJoin,setActivityContext:e.setActivityContext,ignoreActivityWindowTypes:e.ignoreActivityWindowTypes,reuseExistingWindows:e.reuseWindows,closeRunningInstances:e.closeRunningInstances,excludeFromClosing:e.closeMe?[]:[this.appManager.myInstance.id]},s={type:e.type,name:e.name,context:e.context,options:o};e.timeout&&(s.timeout=e.timeout),this.invokeMethodAndTrack("T42.ACS.RestoreLayout",s,t,n,!0)}))}remove(e,t){return new Promise(((n,i)=>{if(this.verifyNotSlimMode(),!t)return i(new Error("name argument is required"));if(!e)return i(new Error("type argument is required"));const r={type:e,name:t};this.invokeMethodAndTrack("T42.ACS.RemoveLayout",r,n,i)}))}list(){return this.verifyNotSlimMode(),si.all}import(e,t){return new Promise(((n,i)=>{if(this.verifyNotSlimMode(),!_t(t)&&"merge"!==t&&"replace"!==t)return i(new Error(`${t} is not supported - only "merge" and "replace"`));const r={mode:t||"replace",layouts:e};this.invokeMethodAndTrack("T42.ACS.ImportLayouts",r,n,i,!0)}))}export(e){return new Promise(((t,n)=>{this.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(n=>{let i=this.getObjectValues(n.Layouts).map((e=>new di(ci(e))));e&&(i=i.filter((t=>t.type===e))),t(i)}),n,!0)}))}rename(e,t){return new Promise(((n,i)=>{if(this.verifyNotSlimMode(),!e)return i(new Error("layout argument is required"));if(!e.name)return i(new Error("name argument is required"));if(!e.type)return i(new Error("type argument is required"));const r={type:e.type,oldName:e.name,newName:t};this.invokeMethodAndTrack("T42.ACS.RenameLayout",r,n,i)}))}updateMetadata(e){return new Promise(((t,n)=>{if(!e)return n(new Error("layout argument is required"));if(!e.name)return n(new Error("name argument is required"));if(!e.type)return n(new Error("type argument is required"));if(!e.metadata)return n(new Error("metadata argument is required"));const i={name:e.name,type:e.type,metadata:e.metadata};this.invokeMethodAndTrack("T42.ACS.UpdateMetadata",i,t,n,!0)}))}hibernate(e,t){return new Promise(((n,i)=>{if(!e)return i(new Error("name cannot be empty"));const r={name:e,type:"Global",context:(t=t||{}).context||{},metadata:t.metadata||{}};this.invokeMethodAndTrack("T42.ACS.HibernateLayout",r,n,i,!0)}))}resume(e,t,n){return new Promise(((i,r)=>{if(!e)return r(new Error("name cannot be empty"));const o={name:e,type:"Global",context:t,...n};this.invokeMethodAndTrack("T42.ACS.ResumeLayout",o,i,r,!0)}))}async getCurrentLayout(){let e=(await this.config.agm.invoke("T42.ACS.GetCurrentLayout",{},"best",{methodResponseTimeoutMs:12e4})).returned.layout;if(e)return this.isSlimMode()||(e=this.list().find((t=>t.name===e.name&&t.type===e.type))),e}onAdded(e){const t=this.callbacks.add("added",e);return si.all.length>0&&si.all.forEach((t=>{try{e(t)}catch(e){}})),t}onRemoved(e){return this.callbacks.add("removed",e)}onChanged(e){return this.callbacks.add("changed",e)}onRestored(e){return this.callbacks.add("restored",e)}onRenamed(e){return this.callbacks.add("renamed",e)}onEvent(e){return this.stream.onEvent(e)}onSaveRequested(e){return this.provider.onSaveRequested(e)}updateAppContextInCurrent(e){return new Promise(((t,n)=>{if(e&&"object"!=typeof e)return n(new Error("context must be an object"));const i={context:e=null!=e?e:{}};this.invokeMethodAndTrack("T42.ACS.UpdateLayoutComponentContext",i,t,n,!0)}))}updateDefaultContext(e){return new Promise(((t,n)=>{if(e&&"object"!=typeof e)return n(new Error("context must be an object"));const i={context:e=null!=e?e:{}};this.invokeMethodAndTrack("T42.ACS.UpdateDefaultContext",i,t,n,!0)}))}async get(e,t){const n=this.list().find((n=>n.name===e&&n.type===t));if(!n)throw new Error(`cannot find layout with name=${e} and type=${t}`);return n}async getAll(e){return this.list().filter((t=>e===t.type))}isSlimMode(){return"slim"===this.config.mode}verifyNotSlimMode(){if(this.isSlimMode())throw Error("Operation not allowed in slim mode. Run in full mode.")}invokeMethodAndTrack(e,t,n,i,r){let o,s=r;const a=Vn();t.token=a;const c=()=>{s&&o&&n(o)};r||this.stream.waitFor(a).then((()=>{s=!0,c()})).catch((e=>{i(e)}));this.config.agm.invoke(e,t,"best",{methodResponseTimeoutMs:12e4}).then((t=>t.returned?t.returned.status&&"Success"!==t.returned.status&&"PartialSuccess"!==t.returned.status?i(new Error(t.returned)):(o=t.returned,void c()):i(new Error("No result from method "+e)))).catch((e=>i(e)))}getObjectValues(e){return e?Object.keys(e).map((t=>e[t])):[]}}class hi{constructor(e,t){this.agm=e,this.callbacks=t,this.ready=new Promise(((e,t)=>{this.resolveReady=e,this.rejectReady=t})),this.gotSnapshot=new Promise(((e,t)=>{this.resolveGotSnapshot=e,this.rejectGotSnapshot=t}))}subscribe(e){const t=e=>this.getObjectValues(e).map((e=>ci(e)));this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((e=>{e.onData((e=>{const n=e.data;n.IsSnapshot&&this.resolveGotSnapshot(),this.addLayouts(t(n.OnLayoutAdded)),this.removeLayouts(t(n.OnLayoutRemoved)),this.changeLayouts(t(n.OnLayoutChanged)),this.renameLayouts(t(n.OnLayoutRenamed)),this.restoredLayout(t(n.OnLayoutRestored)),this.callbacks.execute("streamEvent",n)})),e.onFailed((e=>{const t="can not subscribe to T42.ACS.OnLayoutEvent "+e;this.rejectReady(t),this.rejectGotSnapshot(t)})),this.resolveReady()})).catch((e=>{const t="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+e;this.rejectReady(t),this.rejectGotSnapshot(t)})):(e&&this.resolveReady(),setTimeout((()=>{this.subscribe(!0)}),500))}onEvent(e){return this.callbacks.add("streamEvent",e)}waitFor(e,t){return t||(t=1e4),new Promise(((n,i)=>{let r=!1;const o=this.onEvent((t=>{t.Token===e&&(r=!0,o(),n())}));setTimeout((()=>{r||i("timed out")}),t)}))}checkForLayoutEventMethod(){try{return-1!==this.agm.methods().map((e=>e.name)).indexOf("T42.ACS.OnLayoutEvent")}catch(e){return!1}}addLayouts(e){e&&e.forEach((e=>{const t=new di(e);si.add(t),this.callbacks.execute("added",t)}))}removeLayouts(e){e&&e.forEach((e=>{si.removeWhere((t=>!this.compareLayouts(t,e))),this.callbacks.execute("removed",e)}))}changeLayouts(e){e&&e.forEach((e=>{si.removeWhere((t=>!this.compareLayouts(t,e))),si.add(new di(e)),this.callbacks.execute("changed",e)}))}renameLayouts(e){e&&e.forEach((e=>{const t=si.first((t=>this.compareLayouts(t,{type:e.type,name:e.oldName})));if(!t)throw Error("received rename event for unknown layout with type "+e.type+" and name "+e.oldName);t.name=e.newName,this.callbacks.execute("renamed",t)}))}compareLayouts(e,t){return e.name===t.name&&e.type===t.type}getObjectValues(e){return e?Object.keys(e).map((t=>e[t])):[]}restoredLayout(e){e&&e.forEach((e=>{const t=si.first((t=>this.compareLayouts(t,{type:e.type,name:e.name})));this.callbacks.execute("restored",t)}))}}function li(e){if(!e.agm)throw Error("config.agm is required");if(!e.logger)throw Error("config.logger is required");e.mode=e.mode||"slim";const t=e.logger,n=fn();let i;return e.mode,i=new hi(e.agm,n),new ui(e,i,n,t)}class pi{constructor(e,t){this._agm=e,this._logger=t,this._registry=fn(),this._registered=!1,this.all=async()=>(await this.callGD(gi.GetAll,{})).map(this.decorateDisplay),this.get=async e=>{const t=await this.callGD(gi.Get,{id:e});return this.decorateDisplay(t)},this.getPrimary=async()=>(await this.all()).find((e=>e.isPrimary)),this.capture=async e=>await this.callGD(gi.Capture,{...e}),this.captureAll=async e=>await this.callGD(gi.CaptureAll,{...e}),this.getMousePosition=async()=>await this.callGD(gi.GetMousePosition),this.callGD=async(e,t)=>(await this._agm.invoke("T42.Displays.Command",{options:{...t},command:e})).returned.data,this.decorateDisplay=e=>{const t={...e,capture:t=>this.capture({id:e.id,size:t})},n=t.workArea;return n.x=n.left,n.y=t.workArea.top,t}}getByWindowId(e){return this.callGD(gi.GetByWindowId,{id:e})}onDisplayChanged(e){return this.register(),this._registry.add("on-display-changed",e)}register(){this._registered||(this._registered=!0,this._agm.register("T42.Displays.OnEvent",((e,t)=>{const n=e.event,i=e.data;if("display-changed"===n)this._registry.execute("on-display-changed",i.displays.map(this.decorateDisplay));else this._logger.warn(`unknown event - ${n}`)})))}}var gi;let fi,yi;async function mi(e,t){fi.invoke("T42.Channels.Announce",{swId:null!=t?t:yi,command:"switchChannel",data:{newChannel:e}})}!function(e){e.Capture="capture",e.CaptureAll="captureAll",e.GetAll="getAll",e.Get="get",e.GetByWindowId="getByWindowId",e.GetMousePosition="getMousePosition"}(gi||(gi={}));const vi="___channel___",wi="latest_fdc3_type";class bi{constructor(e){this.contexts=e}subscribe(e){this.callback=e}subscribeFor(e,t){if(!this.isChannel(e))return Promise.reject(new Error(`Channel with name: ${e} doesn't exist!`));const n=this.createContextName(e);return this.contexts.subscribe(n,((e,n,i,r,o)=>{t(e.data,e,null==o?void 0:o.updaterId)}))}async switchChannel(e){this.unsubscribe();const t=this.createContextName(e);this.unsubscribeFunc=await this.contexts.subscribe(t,((e,t,n,i,r)=>{this.callback&&this.callback(e.data,e,null==r?void 0:r.updaterId)}))}leave(){this.callback&&this.callback({},void 0),this.unsubscribe()}all(){return this.contexts.all().filter((e=>e.startsWith(vi))).map((e=>e.substr(vi.length)))}getContextData(e){return new Promise(((t,n)=>{if(!this.isChannel(e))return n(new Error(`A channel with name: ${e} doesn't exist!`));const i=this.createContextName(e);this.contexts.subscribe(i,(e=>{if(e.latest_fdc3_type){const{latest_fdc3_type:n,...i}=e;t(i)}t(e)})).then((e=>e()))}))}updateChannel(e,t){const n=this.createContextName(e);return this.contexts.update(n,t)}updateData(e,t){const n=this.createContextName(e),i=this.getFDC3Type(t);if(this.contexts.setPathSupported){const e=Object.keys(t).map((e=>({path:"data."+e,value:t[e]})));return i&&e.push({path:wi,value:i}),this.contexts.setPaths(n,e)}return i&&(t.latest_fdc3_type=i),this.contexts.update(n,{data:t})}isChannel(e){return this.all().some((t=>t===e))}unsubscribe(){this.unsubscribeFunc&&this.unsubscribeFunc()}createContextName(e){return vi+e}getFDC3Type(e){const t=Object.keys(e).filter((e=>0===e.indexOf("fdc3_")));if(0!==t.length){if(t.length>1)throw new Error("FDC3 does not support updating of multiple context keys");return t[0].split("_").slice(1).join("_")}}}class _i{constructor(e,t,n,i){this.shared=e,this.interop=t,this.getWindows=n,this.logger=i,this.subsKey="subs",this.changedKey="changed",this.isInitialJoin=!0,this.registry=fn(),this.shared.subscribe(this.handler.bind(this)),"undefined"!=typeof window&&void 0!==window.glue42gd&&(this.currentContext=window.glue42gd.initialChannel,this.currentContext&&this.joinNoSelectorSwitch(this.currentContext))}subscribe(e){if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,e)}async subscribeFor(e,t){if("string"!=typeof e)throw new Error("Please provide the name as a string!");if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return await this.shared.subscribeFor(e,t)}async publish(e,t){if("object"!=typeof e)throw new Error("Please provide the data as an object!");if(t){if("string"!=typeof t)throw new Error("Please provide the name as a string!");return this.shared.isChannel(t)?this.shared.updateData(t,e):Promise.reject(new Error(`A channel with name: ${t} doesn't exist!`))}if(!this.currentContext)throw new Error("Not joined to any channel!");return this.shared.updateData(this.currentContext,e)}all(){const e=this.shared.all();return Promise.resolve(e)}async list(){const e=await this.all();return await Promise.all(e.map((e=>this.get(e))))}get(e){return"string"!=typeof e?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(e)}getMy(){return this.currentContext?this.get(this.currentContext):Promise.resolve(void 0)}async join(e,t){return t?mi(e,t):this.joinCore(e)}async joinNoSelectorSwitch(e){return this.joinCore(e,!1)}leave(e){return e?mi(void 0,e):this.leaveCore()}leaveNoSelectorSwitch(){return this.leaveCore(!1)}current(){return this.currentContext}my(){return this.current()}changed(e){if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,e)}onChanged(e){return this.changed(e)}async add(e){if("object"!=typeof e)throw new Error("Please provide the info as an object!");if(void 0===e.name)throw new Error("info.name is missing!");if("string"!=typeof e.name)throw new Error("Please provide the info.name as a string!");if(void 0===e.meta)throw new Error("info.meta is missing!");if("object"!=typeof e.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===e.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof e.meta.color)throw new Error("Please provide the info.meta.color as a string!");const t={name:e.name,meta:e.meta||{},data:e.data||{}};return await this.shared.updateChannel(e.name,t),t}async getWindowsOnChannel(e){return(await this.getWindowsWithChannels({channels:[e]})).map((e=>e.window))}async getWindowsWithChannels(e){var t;try{const n=await this.interop.invoke("T42.Channels.Announce",{command:"getChannelsInfo",data:{filter:e}}),i=this.getWindows();if(null===(t=null==n?void 0:n.returned)||void 0===t?void 0:t.windows)return n.returned.windows.map((e=>({window:i.findById(e.windowId),channel:e.channel,application:e.application})))}catch(e){this.logger.error("Error getting all channel enabled windows. This method is available since Glue42 3.12",e)}return[]}handler(e,t,n){this.registry.execute(this.subsKey,e,t,n)}async joinCore(e,t=!0){if("string"!=typeof e)throw new Error("Please provide the channel name as a string!");if(!this.isInitialJoin&&e===this.currentContext)return;this.isInitialJoin=!1;const n=e=>this.shared.all().includes(e);if(!n(e)){const t=new Promise(((t,i)=>{let r;const o=setInterval((()=>{n(e)&&(clearTimeout(r),clearInterval(o),t())}),100);r=setTimeout((()=>(clearInterval(o),i(new Error(`A channel with name: ${e} doesn't exist!`)))),3e3)}));await t}this.currentContext=e,await this.shared.switchChannel(e),t&&mi(e),this.registry.execute(this.changedKey,e)}leaveCore(e=!0){return this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.leave(),e&&mi(),Promise.resolve()}}function Ii(e,t,n,i){const r=new bi(e),o=new _i(r,t,n,i);return async function(e,t){fi=e,"undefined"!=typeof window&&window.glue42gd&&(yi=window.glue42gd.windowId),yi&&(await fi.register("T42.Channels.Command",(e=>{const n=e.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:t.current()};throw new Error(`unknown command ${n}`)}t.leaveNoSelectorSwitch()}else{const n=e.channel;if(!n)throw new Error("missing argument id");t.joinNoSelectorSwitch(n)}})),fi.invoke("T42.Channels.Announce",{swId:yi,instance:fi.instance.instance}))}(t,o),{subscribe:o.subscribe.bind(o),subscribeFor:o.subscribeFor.bind(o),publish:o.publish.bind(o),all:o.all.bind(o),list:o.list.bind(o),get:o.get.bind(o),join:o.join.bind(o),leave:o.leave.bind(o),current:o.current.bind(o),my:o.my.bind(o),changed:o.changed.bind(o),onChanged:o.onChanged.bind(o),add:o.add.bind(o),getWindowsOnChannel:o.getWindowsOnChannel.bind(o),getWindowsWithChannels:o.getWindowsWithChannels.bind(o),getMy:o.getMy.bind(o),ready:()=>e.ready()}}const Ci="T42.Hotkeys.Command";class Ai{constructor(e){this.agm=e,this.registry=fn(),this.firstHotkey=!0,this.hotkeys=new Map}async register(e,t){if(void 0===e)throw new Error("Hotkey parameter missing");if("string"==typeof e)e={hotkey:e};else{if(!e.hotkey)throw new Error("Info's hotkey parameter missing");e={hotkey:e.hotkey,description:e.description}}const n=this.formatHotkey(e.hotkey);if(this.hotkeys.has(n))throw new Error(`Shortcut for ${n} already registered`);this.firstHotkey&&(this.firstHotkey=!1,await this.registerInvokeAGMMethod()),this.registry.add(n,t),await this.agm.invoke(Ci,{command:"register",hotkey:n,description:e.description}),this.hotkeys.set(n,e)}async unregister(e){if(void 0===e)throw new Error("hotkey parameter missing");if("string"!=typeof e)throw new Error("hotkey parameter must be string");const t=this.formatHotkey(e);await this.agm.invoke(Ci,{command:"unregister",hotkey:t}),this.hotkeys.delete(t),this.registry.clearKey(t)}async unregisterAll(){await this.agm.invoke(Ci,{command:"unregisterAll"}),this.hotkeys.clear(),this.registry.clear()}isRegistered(e){const t=this.formatHotkey(e);return this.hotkeys.has(t)}registerInvokeAGMMethod(){this.agm.register("T42.Hotkeys.Invoke",(e=>{const t=e.key.toLowerCase(),n=this.hotkeys.get(t);this.registry.execute(t,n)}))}formatHotkey(e){if(e)return e.replace(/\s/g,"").toLowerCase()}}var xi="5.14.5",Ti=e=>{function t(e,t,i){if("boolean"==typeof e&&!e)return;const r=n(e,t,i);return"object"==typeof e?(e.mode=r,e):{mode:r}}function n(e,t,i){return"object"==typeof e?n(e.mode,t,i)+"":void 0===e?"boolean"!=typeof t||t?t+"":void 0:"boolean"==typeof e?e?(void 0===i?t:i)+"":void 0:e+""}return{layouts:t(e.layouts,"slim"),activities:t(e.activities,"trackMyTypeAndInitiatedFromMe"),appManager:t(e.appManager,!1,"startOnly"),windows:t(e.windows,!0),channels:t(e.channels||!1,!1),displays:t(e.displays,!0)}};class ki{constructor(e){this.options=e,this.callbacks=fn(),this.actions=e.actions,this.body=e.body,this.badge=e.badge,this.data=e.data,this.dir=e.dir,this.icon=e.icon,this.image=e.image,this.lang=e.lang,this.renotify=e.renotify,this.requireInteraction=e.requireInteraction,this.silent=e.silent,this.tag=e.tag,this.timestamp=e.timestamp,this.title=e.title}close(){throw new Error("Method not implemented.")}addEventListener(e,t,n){this.callbacks.add(e,t)}removeEventListener(e,t,n){}dispatchEvent(e){return this.callbacks.execute(e.type,e),!0}}class Si{constructor(e){this.interop=e}toggle(){return this.interop.invoke("T42.Notifications.Show")}show(){return this.interop.invoke("T42.Notifications.Show",{show:!0})}hide(){return this.interop.invoke("T42.Notifications.Hide")}isVisible(){throw new Error("Method not implemented.")}}class Pi{constructor(e){this.interop=e,this.methodsRegistered=!1,this.NOTIFICATIONS_CONFIGURE_METHOD_NAME="T42.Notifications.Configure",this.methodNameRoot="T42.Notifications.Handler-"+Vn(),this.nextId=0,this.notifications={},this.panel=new Si(e)}get maxActions(){return 2}async raise(e){var t,n,i,r;if(!e)throw new Error("invalid options - should be an object");if(!e.title)throw new Error("invalid options - should have title");if(!this.methodsRegistered){const e=[];for(let t=0;t<this.maxActions;t++)e.push(this.interop.register(this.methodNameRoot+"_"+t,this.handleNotificationAction.bind(this)));await Promise.all(e),this.methodsRegistered=!0}const o=String(this.nextId++),s=null!==(t=e.type)&&void 0!==t?t:"Notification",a={title:e.title,type:s,severity:null!==(n=e.severity)&&void 0!==n?n:"None",description:e.body,glueRoutingDetailMethodName:this.methodNameRoot+"_0",actions:[],sourceId:o,source:e.source};if(e.actions){const t=e.actions.slice(0,this.maxActions);let n=0;for(const e of t){const t={g42notificationId:o,g42action:e.action,g42interopMethod:null===(i=e.interop)||void 0===i?void 0:i.method,g42interopTarget:null===(r=e.interop)||void 0===r?void 0:r.target},s=Object.keys(t).map((e=>({name:e,value:{stringValue:t[e]}}))),c={name:this.methodNameRoot+"_"+n,description:e.title,displayName:e.title,parameters:s};a.actions.push(c),n++}}if(e.icon&&(a.attributes=a.attributes||[],a.attributes.push({key:"icon",value:{stringValue:e.icon}})),e.data){a.attributes=a.attributes||[];const t=JSON.stringify(e.data);a.attributes.push({key:"data",value:{stringValue:t}})}"number"==typeof e.panelExpiry&&(a.attributes=a.attributes||[],a.attributes.push({key:"panelExpiry",value:{stringValue:e.panelExpiry+""}})),"number"==typeof e.toastExpiry&&(a.attributes=a.attributes||[],a.attributes.push({key:"toastExpiry",value:{stringValue:e.toastExpiry+""}})),await this.interop.invoke("T42.GNS.Publish.RaiseNotification",{notification:a});const c=new ki(e);return this.notifications[o]=c,c}async setFilter(e){return(await this.interop.invoke("T42.Notifications.Filter",e)).returned}async getFilter(){return(await this.interop.invoke("T42.Notifications.Filter")).returned}async configure(e){if(!e||Array.isArray(e))throw new Error("Invalid options - should be an object.");if(0===Object.values(e).length)throw new Error("The argument must be a non-empty object.");Object.values(e).forEach((e=>{if(void 0!==typeof e&&"boolean"!=typeof e)throw new Error("Expected type of option values - boolean.")}));return(await this.interop.invoke(this.NOTIFICATIONS_CONFIGURE_METHOD_NAME,e)).returned}handleNotificationAction(e){if(e.g42notificationId){const t=e,n=t.g42notificationId,i=this.notifications[n];if(!i)return;const r={type:"onaction",action:t.g42action};i.onaction&&i.onaction(r);const o=(i.actions||[]).find((e=>e.action===t.g42action)).interop;o&&this.interop.invoke(o.method,o.arguments||{},o.target||"best"),i.dispatchEvent(r)}else if(e.notification&&e.notification.sourceNotificationId){const t=e.notification.sourceNotificationId,n=this.notifications[t];if(!n)return;const i={type:"onclick"};n.onclick&&n.onclick(i);const r=n.options.clickInterop;r&&this.interop.invoke(r.method,r.arguments||{},r.target||"best"),n.dispatchEvent(i)}}}class Mi{constructor(e){this.core=e,this.registry=fn(),this.isSubscribed=!1,this.getConfiguration()}async list(){if(await this.getConfiguration(),!this.getMethodName)throw new Error("not supported");return(await this.getAll()).returned.all}async getCurrent(){if(await this.getConfiguration(),!this.getMethodName)throw new Error("not supported");const e=await this.getAll();return e.returned.all.find((t=>t.name===e.returned.selected))}async select(e){if(await this.getConfiguration(),!this.setMethodName)throw new Error("not supported");await this.core.interop.invoke(this.setMethodName,{theme:e})}onChanged(e){return this.subscribe(),this.registry.add("changed",e)}async getConfiguration(){try{if(this.sharedContextName)return;const e=await this.core.interop.invoke("T42.Themes.Configuration");this.sharedContextName=e.returned.sharedContextName,this.getMethodName=e.returned.getThemesMethodName,this.setMethodName=e.returned.setThemesMethodName}catch(e){return}}async getAll(){return await this.getConfiguration(),await this.core.interop.invoke(this.getMethodName)}async subscribe(){await this.getConfiguration(),this.isSubscribed||(this.isSubscribed=!0,this.core.contexts.subscribe(this.sharedContextName,(e=>{e&&e.all&&e.selected&&this.registry.execute("changed",e.all.find((t=>t.name===e.selected)))})))}}const Ei="Tick42.FDC3.Intents.";class Ri{constructor(e,t,n){this.interop=e,this.windows=t,this.logger=n,this.myIntents=new Set}async find(e){let t=await this.all();if(void 0===e)return t;if("string"==typeof e)return t.filter((t=>t.name===e));if("object"!=typeof e)throw new Error("Please provide the intentFilter as a string or an object!");if(e.contextType){const n=e.contextType.toLowerCase();t=t.filter((e=>e.handlers.some((e=>{var t;return null===(t=e.contextTypes)||void 0===t?void 0:t.some((e=>e.toLowerCase()===n))}))))}return e.name&&(t=t.filter((t=>t.name===e.name))),t}async raise(e){if("string"!=typeof e&&"object"!=typeof e||"object"==typeof e&&"string"!=typeof e.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");"string"==typeof e&&(e={intent:e});const t=e.intent,n=await this.get(t);if(void 0===n)throw new Error(`Intent ${t} not found.`);const i=!n.handlers.some((e=>"app"===e.type)),r=e.target||(i?"reuse":"startNew");let o;const s=n.handlers.find((e=>"app"===e.type));if("startNew"===r)o=s;else if("reuse"===r){o=n.handlers.find((e=>"instance"===e.type))||s}else if(r.instance)o=n.handlers.find((e=>"instance"===e.type&&e.instanceId===r.instance));else{if(!r.app)throw new Error(`Invalid intent target: ${JSON.stringify(r)}`);o=n.handlers.find((e=>"app"===e.type&&e.applicationName===r.app))}if(!o)throw new Error(`Can not raise intent for request ${JSON.stringify(e)} - can not find intent handler.`);let a=o.instanceId;"app"===o.type&&(a=await this.startApp(o.applicationName,e.options));const c=await this.raiseIntentToInstance(a,t,e.context);return c.request=e,c.handler=o,c}async all(){let e;try{const t=await this.interop.invoke("T42.ACS.GetApplications",{withIntentsInfo:!0});e=t.returned.applications}catch(e){return this.logger.error("Failed to get the applications!",e),[]}const t={},n=e.filter((e=>e.intents&&e.intents.length>0));for(const e of n)for(const n of e.intents){let i=t[n.name];i||(i={name:n.name,handlers:[]},t[n.name]=i);const r={applicationName:e.name,applicationTitle:e.title||"",applicationDescription:e.caption,displayName:n.displayName,contextTypes:n.contexts,applicationIcon:e.icon,type:"app"};i.handlers.push(r)}const i=this.interop.servers(),r=i.map((e=>e.windowId)).filter((e=>void 0!==e)),o="T42.Wnd.GetInfo";let s;if(this.interop.methods().some((e=>e.name===o)))try{const e=await this.interop.invoke(o,{ids:r});s=e.returned.windows}catch(e){}for(const n of i)await Promise.all(n.getMethods().filter((e=>e.name.startsWith(Ei))).map((async i=>{const r=i.name.replace(Ei,"");let o=t[r];o||(o={name:r,handlers:[]},t[r]=o);const a=i.flags.intent,c=e.find((e=>e.name===n.application));let d;c&&c.intents&&(d=c.intents.find((e=>e.name===r)));const u=await this.windowsIdToTitle(n.windowId,s),h={instanceId:n.instance,applicationName:n.application,applicationIcon:a.icon||(null==c?void 0:c.icon),applicationTitle:(null==c?void 0:c.title)||"",applicationDescription:a.description||(null==c?void 0:c.caption),displayName:a.displayName||(null==d?void 0:d.displayName),contextTypes:a.contextTypes||(null==d?void 0:d.contexts),instanceTitle:u,type:"instance"};o.handlers.push(h)})));return Object.values(t)}addIntentListener(e,t){if("string"!=typeof e&&"object"!=typeof e||"object"==typeof e&&"string"!=typeof e.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");if("function"!=typeof t)throw new Error("Please provide the handler as a function!");const n="string"==typeof e?e:e.intent,i=`Tick42.FDC3.Intents.${n}`;let r,o={};if(this.myIntents.has(n))throw new Error(`Intent listener for intent ${n} already registered!`);this.myIntents.add(n);const s={unsubscribe:()=>{this.myIntents.delete(n),r.then((()=>this.interop.unregister(i))).catch((e=>this.logger.trace(`Unregistration of a method with name ${i} failed with reason: ${e}`)))}};if("object"==typeof e){const{intent:t,...n}=e;o=n}return r=this.interop.register({name:i,flags:{intent:o}},(e=>{if(this.myIntents.has(n))return t(e)})),r.catch((e=>{this.myIntents.delete(n),this.logger.warn(`Registration of a method with name ${i} failed with reason: ${e}`)})),s}async get(e){return(await this.all()).find((t=>t.name===e))}async startApp(e,t){return(await this.interop.invoke("T42.ACS.StartApplication",{Name:e,options:t})).returned.Id}async raiseIntentToInstance(e,t,n){const i=`Tick42.FDC3.Intents.${t}`;let r=this.interop.servers().find((t=>t.instance===e));r||await new Promise(((t,n)=>{let i;const o=this.interop.serverAdded((n=>{n.instance===e&&(r=n,t(),clearTimeout(i),o())}));i=setTimeout((()=>{o(),n(new Error(`Can not find interop server for instance ${e}`))}),3e4)}));r.getMethods().find((e=>e.name===i))||await new Promise(((t,n)=>{let r;const o=this.interop.methodAdded((e=>{e.name===i&&(t(),clearTimeout(r),o())}));r=setTimeout((()=>{o(),n(new Error(`Can not find interop method ${i} for instance ${e}`))}),1e4)}));return{result:(await this.interop.invoke(i,n,{instance:e})).returned}}async windowsIdToTitle(e,t){var n,i;if(void 0!==t)return null===(n=t.find((t=>t.id===e)))||void 0===n?void 0:n.title;const r=null===(i=this.windows)||void 0===i?void 0:i.findById(e);return await(null==r?void 0:r.getTitle())}}class ji{constructor(e,t){this.appName=e,this.interop=t,this.registry=fn(),this.interopMethodRegistered=!1}async get(e){return(await this.interop.invoke("T42.Prefs.Get",{app:null!=e?e:this.appName})).returned}async set(e,t){var n;this.verifyDataObject(e),await this.interop.invoke("T42.Prefs.Set",{app:null!==(n=null==t?void 0:t.app)&&void 0!==n?n:this.appName,data:e,merge:!1})}async setFor(e,t){return this.verifyApp(e),this.verifyDataObject(t),this.set(t,{app:e})}async update(e,t){var n;this.verifyDataObject(e),await this.interop.invoke("T42.Prefs.Set",{app:null!==(n=null==t?void 0:t.app)&&void 0!==n?n:this.appName,data:e,merge:!0})}async updateFor(e,t){return this.verifyApp(e),this.verifyDataObject(t),this.update(t,{app:e})}async clear(e){await this.interop.invoke("T42.Prefs.Set",{app:null!=e?e:this.appName,clear:!0})}async clearFor(e){this.verifyApp(e),await this.interop.invoke("T42.Prefs.Set",{app:e,clear:!0})}async getAll(){return(await this.interop.invoke("T42.Prefs.Get")).returned}async clearAll(){await this.interop.invoke("T42.Prefs.Set",{clear:!0})}subscribe(e){return this.verifyCallback(e),this.subscribeFor(this.appName,e)}subscribeFor(e,t){this.verifyApp(e),this.verifyCallback(t);const n=this.registry.add(e,t);return this.registerInteropIfNeeded().then((()=>{this.interop.invoke("T42.Prefs.Get",{app:e,subscribe:!0})})),()=>{n()}}async registerInteropIfNeeded(){this.interopMethodRegistered||(this.interopMethodRegistered=!0,await this.interop.register("T42.Prefs.Update",(e=>{this.registry.execute(e.app,e)})))}verifyApp(e){if(!e)throw new Error("app should be defined");if(!mt(e))throw new Error("app should be a string")}verifyDataObject(e){if(!e)throw new Error("data should be defined");if(!vt(e))throw new Error("data should be an object")}verifyCallback(e){if(!At(e))throw new Error("callback should be defined")}}class Wi{constructor(e,t){this.methodName=e,this.interop=t}async get(e){return(await this.invoke("get-cookies",{filter:e})).returned.cookies}async set(e){this.verifyCookieObject(e),await this.invoke("set-cookie",e)}async remove(e,t){if(!mt(e))throw new Error("url should be a string");if(!mt(t))throw new Error("name should be a string");await this.invoke("remove-cookie",{url:e,name:t})}invoke(e,t){return this.interop.invoke(this.methodName,{command:e,args:t})}verifyCookieObject(e){if(!e)throw new Error("cookie should be defined");if(!vt(e))throw new Error("cookie should be an object")}}const Oi=new class{constructor(){this.initialized=!1,this.details=[],this.reject=()=>{},this.resolve=()=>{}}init(e){this.initialized=!0,this.addCall(e),this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}addCall(e){this.details.push({date:new Date,config:e})}done(e){this.resolve(e)}error(e){this.reject(e)}},Ni=async e=>{let t=!1;Oi.initialized||(t=!0,Oi.init(e));const n="undefined"!=typeof window&&window.glue42gd;if(n&&!t)return Oi.addCall(e),Oi.promise;const i=await Fi(e,n);return Oi.resolve(i),i},Fi=async(e,t)=>{const n=Kn.getGDMajorVersion(),i=Ti(e=e||{});let r,o,s,a,c;function d(e,t,n){const i=t.subLogger(e);if(n&&n.logger){const e=n.logger;e.console&&i.consoleLevel(e.console),e.publish&&i.publishLevel(e.publish)}return i}e.gateway=e.gateway||{};const u={libs:[{name:"windows",create:function(e){if(i.windows){const t=d("windows",e.logger,i.windows);return s=oi(e.agm,t,(()=>r),(()=>a),(()=>c),n),l(s),s}}},{name:"activities",create:function(e){var a;if(i.activities&&un.checkIsUsingGW3Implementation&&un.checkIsUsingGW3Implementation(e.connection)){const c=d("activity",e.logger,i.activities);return o=new un({connection:e.connection,contexts:e.contexts,agm:e.agm,logger:c,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"exit",announcementInfo:null,windows:s,appManagerGetter:()=>r,mode:i.activities.mode,typesToTrack:i.activities.typesToTrack,activityId:null===(a=null==t?void 0:t.activityInfo)||void 0===a?void 0:a.activityId,gdMajorVersion:n}).api,l(o),o}}},{name:"appManager",create:function(e){if(!i.appManager)return;const t=d("appManager",e.logger,i.appManager);return r=xn({agm:e.agm,windows:s,logger:t,activities:o,mode:i.appManager.mode,gdMajorVersion:n}),l(r),r}},{name:"layouts",create:function(e){var t;if(!i.layouts)return;const s=d("layouts",e.logger,i.layouts),a=i.layouts,c=li({agm:e.agm,appManager:r,activityGetter:()=>o,logger:s,mode:a.mode,autoSaveWindowContext:null!==(t=a.autoSaveWindowContext)&&void 0!==t&&t,gdMajorVersion:n});return l(c),c}},{name:"channels",create:function(e){if(!i.channels)return;if(!e.contexts)return;const t=d("channels",e.logger,i.channels);return c=Ii(e.contexts,e.agm,(()=>s),t),l(c),c}},{name:"hotkeys",create:function(e){const t=function(e){const t=new Ai(e);return{register:t.register.bind(t),unregister:t.unregister.bind(t),unregisterAll:t.unregisterAll.bind(t),isRegistered:t.isRegistered.bind(t),ready:()=>Promise.resolve()}}(e.agm);return l(t),t}},{name:"displays",create:function(e){if(i.displays){const t=d("displays",e.logger,i.displays);return a=new pi(e.agm,t),l(a),a}}},{name:"intents",create:function(e){const t=new Ri(e.agm,s,e.logger.subLogger("intents"));return l(t),t}},{name:"notifications",create:function(e){const t=new Pi(e.interop);return l(t),t}},{name:"themes",create:function(e){if(!e.contexts)return;const t=function(e){const t=new Mi(e);return{list:t.list.bind(t),getCurrent:t.getCurrent.bind(t),select:t.select.bind(t),onChanged:t.onChanged.bind(t),ready:()=>Promise.resolve()}}(e);return l(t),t}},{name:"prefs",create:function(n){var i,r;const o=null!==(r=null!==(i=e.application)&&void 0!==i?i:null==t?void 0:t.application)&&void 0!==r?r:n.interop.instance.application,s=new ji(o,n.interop);return l(s),s}},{name:"cookies",create:function(e){const t=function(e,t){const n=new Wi(t,e);return{get:n.get.bind(n),remove:n.remove.bind(n),set:n.set.bind(n),ready:()=>Promise.resolve()}}(e.interop,"T42.GD.Execute");return l(t),t}}],version:xi,enrichGlue:e=>{e.config.activities=i.activities,e.config.windows=i.windows,e.config.appManager=i.appManager,e.config.layouts=i.layouts,e.config.channels=i.channels,e.config.displays=i.displays}},h=[];function l(e){h.push(e)}"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(h));const p=await gt(e,u);return Array.isArray(null==e?void 0:e.libraries)&&e.libraries.length&&await Promise.all(e.libraries.map((t=>t(p,e)))),p};Ni.coreVersion=gt.version,Ni.version=xi,Ni.calls=Oi;let Li=Ni,Di=!0;if("undefined"!=typeof window){const e=window.glue42gd;e&&e.autoInjected&&(Li=window.Glue,Di=!1),Di&&(window.Glue=Li),delete window.GlueCore}return Li.default=Li,Li}));
//# sourceMappingURL=desktop.umd.min.js.map
